<!-- Tab: RFID Replacement -->
<div v-show="currentTab === 'rfid-replace'">
  <div class="split-layout">
    <!-- Left: Form -->
    <div>
      <div class="section-header">
        <h2>RFID 標籤更換作業</h2>
      </div>

      <div class="alert alert-info mb-4">
        <i data-lucide="info" class="w-5 h-5"></i>
        <div>請選擇 AOI 檢驗通過的工單，並掃描舊標籤與新標籤以進行 RFID 更換。</div>
      </div>

      <form @submit.prevent="submitEpcChange">
        <!-- Work Order Select -->
        <div style="margin-bottom: 1rem;">
          <label class="input-label">選擇工單 (AOI PASS)</label>
          <div class="wo-card-list">
            <div v-if="aoiPassedOrders.length === 0" class="empty-state" style="padding: 2rem;">
              <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
              <div>目前無 AOI 檢驗通過的工單</div>
            </div>
            <div v-for="wo in aoiPassedOrders" :key="wo.id"
                 :class="['wo-card', formEpc.workOrderId === wo.id ? 'selected' : '']"
                 @click="formEpc.workOrderId = wo.id; onWoSelect()">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div class="wo-number">{{ wo.orderNumber }}</div>
                  <div class="wo-info">{{ wo.productModel }} ({{ wo.customerName }})</div>
                </div>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  <span class="badge badge-success">AOI PASS</span>
                  <span style="font-size: 0.75rem; color: #64748b;">{{ wo.completedQty || 0 }}/{{ wo.quantity }}</span>
                </div>
              </div>
              <i v-if="formEpc.workOrderId === wo.id" data-lucide="check-circle" style="position: absolute; top: 50%; right: 1rem; transform: translateY(-50%); color: #667eea; width: 1.25rem; height: 1.25rem;"></i>
            </div>
          </div>
        </div>

        <!-- EPC Input Section -->
        <div class="form-section" style="margin-bottom: 1rem;">
          <div style="margin-bottom: 1rem;">
            <label class="input-label">舊 EPC (Old Tag)</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <input type="text" class="input input-bordered w-full" v-model="formEpc.oldEpc" @blur="checkOldEpc" placeholder="掃描舊標籤">
              <span v-if="epcCheckStatus === 'checking'" class="loading loading-spinner loading-md"></span>
            </div>
            <div v-if="epcCheckInfo" :style="{ color: epcCheckInfo.found ? '#16a34a' : '#ea580c' }" style="font-size: 0.75rem; font-weight: 600; margin-top: 0.25rem;">
              {{ epcCheckInfo.message }}
            </div>
            <div v-else style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">來源產品上的舊標籤</div>
          </div>

          <div>
            <label class="input-label" style="color: #667eea;">新 EPC (New Tag)</label>
            <input type="text" class="input input-bordered w-full" v-model="formEpc.newEpc" placeholder="掃描新標籤 (例如: RF...)" required
                   pattern="^RF[0-9]{13}$" style="border-color: #667eea;">
            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">格式: RF + 13碼數字 (例: RF2026010100001)</div>
          </div>
        </div>

        <!-- Operator -->
        <div style="margin-bottom: 1rem;">
          <label class="input-label">操作人員</label>
          <div v-if="operators.length > 0 && operators.length <= 12" class="operator-grid">
            <div v-for="op in operators" :key="op.id"
                 :class="['operator-chip', formEpc.operatorName === op.name ? 'selected' : '']"
                 @click="formEpc.operatorName = op.name">
              {{ op.name }}
            </div>
          </div>
          <select v-else class="select select-bordered w-full" v-model="formEpc.operatorName" required>
            <option value="">-- 請選擇 --</option>
            <option v-for="op in operators" :key="op.id" :value="op.name">{{ op.name }}</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary w-full">
          <i data-lucide="repeat" class="w-4 h-4"></i>
          確認更換與綁定
        </button>
      </form>
    </div>

    <!-- Right: History -->
    <div style="border-left: 1px solid #e2e8f0; padding-left: 1.5rem;">
      <h3 style="margin: 0 0 1rem; color: #475569;">最近更換紀錄</h3>
      <div class="scrollable">
        <table class="data-table">
          <thead>
            <tr>
              <th>時間</th>
              <th>舊標籤 -> 新標籤</th>
              <th>工單</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="h in epcHistory" :key="h.id">
              <td style="font-size: 0.75rem; color: #64748b;">
                {{ new Date(h.createdAt).toLocaleString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }}
              </td>
              <td>
                <div class="epc-arrow">
                  <span class="old">{{ h.oldEpc || '(無)' }}</span>
                  <i data-lucide="arrow-right" class="w-4 h-4"></i>
                  <span class="new">{{ h.newEpc }}</span>
                </div>
              </td>
              <td style="font-size: 0.75rem; color: #64748b;">{{ h.orderNumber }}</td>
            </tr>
            <tr v-if="epcHistory.length === 0" class="empty-row">
              <td colspan="3">
                <div class="empty-state">
                  <i data-lucide="tag" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                  <div>尚無紀錄</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
