<!-- Tab: Work Orders -->
<div v-show="currentTab === 'work-orders'">
  <div class="section-header">
    <h2>{{ canManage ? '工單管理' : '工單查看' }}</h2>
    <!-- 建立按鈕：僅管理員顯示 -->
    <div v-if="canManage" class="wo-create-buttons">
      <button class="btn btn-primary" @click="openCreateWoModal('deglue')">
        <i data-lucide="droplets" class="w-4 h-4"></i>
        除膠
      </button>
      <button class="btn btn-warning" @click="openCreateWoModal('regeneration')">
        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        再生
      </button>
      <button class="btn btn-error" @click="openCreateWoModal('rework')">
        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
        重工
      </button>
    </div>
  </div>

  <!-- 狀態篩選 -->
  <div class="wo-filter-bar">
    <div class="wo-filter-chips">
      <button :class="['wo-filter-chip', woStatusFilter === 'all' ? 'active' : '']" @click="woStatusFilter = 'all'">
        全部 <span class="chip-count">{{ workOrders.length }}</span>
      </button>
      <button :class="['wo-filter-chip', woStatusFilter === 'in_progress' ? 'active in-progress' : '']" @click="woStatusFilter = 'in_progress'">
        進行中 <span class="chip-count">{{ workOrders.filter(w => w.status === 'in_progress').length }}</span>
      </button>
      <button :class="['wo-filter-chip', woStatusFilter === 'draft' ? 'active draft' : '']" @click="woStatusFilter = 'draft'">
        草稿 <span class="chip-count">{{ workOrders.filter(w => w.status === 'draft').length }}</span>
      </button>
      <button :class="['wo-filter-chip', woStatusFilter === 'completed' ? 'active completed' : '']" @click="woStatusFilter = 'completed'">
        已完成 <span class="chip-count">{{ workOrders.filter(w => w.status === 'completed').length }}</span>
      </button>
    </div>
  </div>

  <div class="scrollable">
    <table class="data-table">
      <thead>
        <tr>
          <th>單號</th>
          <th>產品/客戶</th>
          <th>類型</th>
          <th>進度</th>
          <th>數量 (完工/總數)</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="wo in filteredWorkOrders" :key="wo.id">
          <td>
            <span style="font-family: monospace; font-weight: 600;">{{ wo.orderNumber }}</span>
          </td>
          <td>
            <div style="font-weight: 600;">{{ wo.productModel }}</div>
            <div style="font-size: 0.75rem; color: #64748b;">{{ wo.customerName }}</div>
          </td>
          <td>
            <span :class="['badge', wo.orderType === 'regeneration' ? 'badge-warning' : wo.orderType === 'rework' ? 'badge-error' : 'badge-primary']">
              {{ { deglue: '除膠', regeneration: '再生', rework: '重工' }[wo.orderType] || wo.orderType }}
            </span>
            <span v-if="wo.orderType === 'rework' && wo.reworkCount" class="badge badge-error ml-1">
              第{{ wo.reworkCount }}次
            </span>
          </td>
          <td>
            <span :class="'status-badge status-' + (wo.status || 'unknown')">
              {{ { draft: '草稿', pending: '待處理', in_progress: '進行中', completed: '已完成', paused: '暫停' }[wo.status] || wo.status || '未知' }}
            </span>
          </td>
          <td>
            <span style="font-weight: 600;">{{ wo.completedQty }}</span>
            <span style="color: #94a3b8;"> / {{ wo.quantity }}</span>
          </td>
          <td>
            <div style="display: flex; flex-direction: row; gap: 0.5rem; flex-wrap: nowrap;">
              <!-- 派工：共用功能 -->
              <button v-if="wo.status !== 'completed'" class="btn btn-sm btn-primary" @click="openDispatchModal(wo)">
                派工
              </button>
              <!-- 編輯/取消：僅管理員 -->
              <button v-if="canManage && wo.status === 'draft'" class="btn btn-sm btn-ghost" @click="startEditWorkOrder(wo)">
                編輯
              </button>
              <button v-if="canManage && (wo.status === 'draft' || wo.status === 'pending')" class="btn btn-sm btn-outline btn-error" @click="deleteWorkOrder(wo.id)">
                取消
              </button>
              <span v-if="wo.status === 'completed'" class="badge badge-success">已完成</span>
            </div>
          </td>
        </tr>
        <tr v-if="filteredWorkOrders.length === 0" class="empty-row">
          <td colspan="6">
            <div class="empty-state">
              <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
              <div>{{ woStatusFilter === 'all' ? '暫無工單資料' : '無符合條件的工單' }}</div>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
