<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
  const { createApp, ref, onMounted, nextTick, watch } = Vue;

  const app = createApp({
    setup() {
      const loading = ref(false);
      const loadingCount = ref(0);
      const version = ref('');
      const currentTab = ref('work-orders');
      const workOrders = ref([]);
      const dispatches = ref([]);
      const epcHistory = ref([]);
      const reports = ref([]);
      const operators = ref([]);
      const customers = ref([]);
      const products = ref([]);

      // Computed
      const regenerationOrders = Vue.computed(() => workOrders.value.filter(w => w.orderType === 'regeneration'));
      const completedDeglueOrders = Vue.computed(() => workOrders.value.filter(w => w.orderType === 'deglue' && w.status === 'completed'));
      // AOI PASS 的工單（可進行 RFID 更換）
      const aoiPassedOrders = Vue.computed(() => {
        const passedWorkOrderIds = new Set(
          aoiInspections.value
            .filter(a => a.result === 'PASS')
            .map(a => a.workOrderId)
        );
        return workOrders.value.filter(w =>
          passedWorkOrderIds.has(w.id) && w.status !== 'completed' && w.status !== 'cancelled'
        );
      });
      // 可重工的工單：已完成且尚未重工過的工單（reworkCount = 0 或未設定）
      const reworkableOrders = Vue.computed(() => workOrders.value.filter(w =>
        w.status === 'completed' && (!w.reworkCount || parseInt(w.reworkCount) === 0)
      ));

      const customerSites = Vue.computed(() => {
        if (!formWo.value.customerName) return [];
        const cust = customers.value.find(c => c.name === formWo.value.customerName);
        if (!cust || !cust.sites) return [];
        try { return JSON.parse(cust.sites); } catch { return []; }
      });

      // 依工單類型過濾可用站點
      const availableStations = Vue.computed(() => {
        if (!selectedWo.value) return [];
        const type = selectedWo.value.orderType;
        if (type === 'deglue') {
          // 除膠工單流程：除膠站 → 烘箱站 → OQC檢驗 → 包裝站
          return ['除膠站', '烘箱站', 'OQC檢驗', '包裝站'];
        } else if (type === 'regeneration') {
          // 再生工單流程：烘箱站 → AOI檢驗 → 釋氣檢驗 → RFID更換 → 包裝站
          return ['烘箱站', 'AOI檢驗', '釋氣檢驗', 'RFID更換', '包裝站'];
        } else if (type === 'rework') {
          // 重工工單：僅烘箱站
          return ['烘箱站'];
        }
        // 預設（不應該到這裡）
        return ['除膠站', '烘箱站', 'OQC檢驗', 'RFID更換', '包裝站'];
      });

      const filteredOutgassingTests = Vue.computed(() => {
        if (!formOutgassing.value.workOrderId) return outgassingTests.value;
        return outgassingTests.value.filter(t => t.workOrderId === formOutgassing.value.workOrderId);
      });

      // R0 Computed
      const filteredR0Labels = Vue.computed(() => {
        const filter = r0TableFilter.value.toLowerCase();
        if (!filter) return r0Labels.value;
        return r0Labels.value.filter(l =>
          (l.r0Code && l.r0Code.toLowerCase().includes(filter)) ||
          (l.currentEpc && l.currentEpc.toLowerCase().includes(filter)) ||
          (l.orderNumber && l.orderNumber.toLowerCase().includes(filter)) ||
          (l.customerName && l.customerName.toLowerCase().includes(filter))
        );
      });

      const r0CodePreview = Vue.computed(() => {
        if (!formR0Generate.value.workOrderId) return '';
        const year = new Date().getFullYear().toString().slice(-2);
        const area = formR0Generate.value.areaCode || 'A';
        const serial = String(r0SerialCounter.value).padStart(6, '0');
        const customerCode = formR0Generate.value.customerCode || 'XXX';
        return `R0${customerCode}@${printerConfig.value.yearPrefix}${year}${area}${serial}`;
      });

      // EPC 預覽 (顯示目前設定會產生的 EPC 格式)
      const epcPreview = Vue.computed(() => {
        if (!formR0Generate.value.workOrderId) return '';
        const header = epcConfig.value.header || 'E2';
        const customer = (formR0Generate.value.customerCode || 'XXXX').toUpperCase().padEnd(4, '0').slice(0, 4);
        const product = (formR0Generate.value.productCode || 'XXXX').toUpperCase().padEnd(4, '0').slice(0, 4);
        const year = new Date().getFullYear().toString().slice(-2);
        const serial = String(epcSerialCounter.value).padStart(12, '0');
        return `${header}${customer}${product}${year}${serial}`;
      });

      const canUpgradeR0 = Vue.computed(() => {
        if (!formR0Upgrade.value.labelInfo) return false;
        const currentCount = parseInt(formR0Upgrade.value.labelInfo.regenerationCount) || 0;
        return currentCount < 5;
      });

      // Modals
      const showCreateWoModal = ref(false);
      const showDispatchModal = ref(false);
      const showReportModal = ref(false);
      const showShareModal = ref(false);

      // Share
      const shareLoading = ref(false);
      const shareData = ref(null);
      const shareCopied = ref(false);

      const selectedWo = ref(null);
      const selectedDispatch = ref(null);
      const selectedEpcWo = ref(null);

      // Forms
      const formWo = ref({ customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' });
      const formDispatch = ref({ stationName: '除膠站', operatorName: '', quantity: 0 });
      const formReport = ref({ goodQty: 0, ngQty: 0, hasAbnormal: false, abnormalType: '', ngDetails: [] });
      // NG 明細輸入
      const currentNgReason = ref(null);
      const currentNgQty = ref(1);
      const currentNgBarcodes = ref([]);
      const currentNgBarcodeInput = ref('');
      const formEpc = ref({ workOrderId: '', oldEpc: '', newEpc: '', operatorName: '' });
      const formOperator = ref({ name: '', code: '' });
      const formCustomer = ref({ name: '', code: '', sitesInput: '' });
      const formProduct = ref({ name: '', code: '', type: '10cm' });

      // NG Reasons
      const ngReasons = ref([]);
      const formNgReason = ref({ name: '', code: '', description: '' });

      // Outgassing
      const outgassingTests = ref([]);
      const outgassingSampleInfo = ref(null);
      const formOutgassing = ref({ workOrderId: '', rfidCode: '', result: '', operatorName: '', notes: '', signature: '' });

      // Signature Pad
      const signaturePadOutgassing = ref(null);
      const signaturePadAoi = ref(null);
      const isDrawing = ref(false);
      const lastPos = ref({ x: 0, y: 0 });

      // AOI
      const aoiInspections = ref([]);
      const aoiCsvPreview = ref([]);
      const formAoi = ref({ workOrderId: '', operatorName: '' });
      const formAoiSingle = ref({ rfidCode: '', result: '', defectType: '' });

      // Inspection Detail Modal
      const showInspectionDetailModal = ref(false);
      const selectedInspection = ref(null);
      const inspectionType = ref(''); // 'outgassing' or 'aoi'

      // Oven Monitoring (10 ovens)
      const ovens = ref([
        { id: 1, name: '烘箱 1', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 2, name: '烘箱 2', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 3, name: '烘箱 3', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 4, name: '烘箱 4', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 5, name: '烘箱 5', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 6, name: '烘箱 6', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 7, name: '烘箱 7', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 8, name: '烘箱 8', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 9, name: '烘箱 9', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false },
        { id: 10, name: '烘箱 10', apiEndpoint: '', batchQty: 18, scannedCodes: [], doorOpen: false, temperature: 0, runningTime: 0, running: false }
      ]);
      const selectedOvenId = ref(null);
      const ovenScanInput = ref('');
      const ecuConnected = ref(false);
      const ovenConfig = ref({ ecuEndpoint: '' });
      const ovenBindings = ref({}); // { ovenId: dispatchId }
      const ovenBatchQty = ref(18);
      const ovenAutoReportEnabled = ref(false);
      const ovenEventLogs = ref([]);
      const showOvenSettingsModal = ref(false);
      const dispatchDoorStates = ref({}); // { dispatchId: { state: 'open'|'closed', time: Date, ovenId: number } }
      let ovenTimer = null;

      // Label Editor
      const labelTemplates = ref([]);
      const currentTemplateId = ref('');
      const labelSize = ref({ width: 50, height: 30 });
      const labelElements = ref([]);
      const selectedElementIdx = ref(null);
      const showTemplateSaveModal = ref(false);
      const showLabelPreviewModal = ref(false);
      const templateSaveName = ref('');
      const previewWorkOrderId = ref('');
      const previewData = ref({});
      const canvasScale = ref(16); // 縮放倍率 (6-20x)
      const dataFields = ref([
        { key: '${r0Code}', label: 'R0 編碼' },
        { key: '${epc}', label: 'EPC 編碼' },
        { key: '${orderNumber}', label: '工單號' },
        { key: '${productModel}', label: '產品型號' },
        { key: '${customerName}', label: '客戶名稱' },
        { key: '${customerCode}', label: '客戶代碼' },
        { key: '${regenerationStatus}', label: '再生狀態' },
        { key: '${regenerationCount}', label: '再生次數' },
        { key: '${date}', label: '日期' },
        { key: '${operator}', label: '操作員' }
      ]);
      let dragType = null;
      let dragData = null;
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      // R0 Management
      const r0SubTab = ref('generate');
      const r0Labels = ref([]);
      const r0TableFilter = ref('');
      const r0QueryInput = ref('');
      const r0QueryResult = ref(null);
      const r0GenerateQueue = ref([]);
      const printerConnected = ref(false);
      const showPrinterSettingsModal = ref(false);
      const printerConfig = ref({
        type: 'sato',
        connection: 'usb',
        ip: '',
        simulationMode: true,
        yearPrefix: 'YCD',
        serialStart: 1
      });

      // R0 Generate Form
      const formR0Generate = ref({
        workOrderId: '',
        quantity: 10,
        customerCode: '',
        productCode: '',
        areaCode: 'A'
      });

      // R0 Simulate Form (for testing without RFID printer)
      const formR0Simulate = ref({
        r0Code: '',
        epc: ''
      });

      // R0 Replace Form
      const formR0Replace = ref({
        oldBarcode: '',
        oldLabelInfo: null,
        reason: '',
        operatorName: '',
        pendingNewLabel: false,
        newEpc: ''
      });

      // R0 Upgrade Form
      const formR0Upgrade = ref({
        barcode: '',
        labelInfo: null,
        operatorName: '',
        notes: ''
      });

      // R0 Serial Counter (stored in localStorage)
      const r0SerialCounter = ref(parseInt(localStorage.getItem('r0SerialCounter') || '1'));

      // EPC Serial Counter (stored in localStorage)
      const epcSerialCounter = ref(parseInt(localStorage.getItem('epcSerialCounter') || '1'));

      // EPC Config
      const epcConfig = ref({
        header: 'E2',           // 2 位 header
        autoGenerate: true      // 是否自動產生
      });

      // Editing State
      const editingOperatorId = ref(null);
      const editingCustomerId = ref(null);
      const editingProductId = ref(null);
      const editingNgReasonId = ref(null);
      const editingWorkOrderId = ref(null);

      // EPC Check
      const epcCheckStatus = ref('idle');
      const epcCheckInfo = ref(null);

      // Admin
      const adminLoading = ref(false);
      const adminMessage = ref('');
      const adminMessageType = ref('success');
      const systemVersion = ref('5.1.0');

      // WMS 倉儲管理
      const wmsLocations = ref([]);
      const wmsInventory = ref([]);
      const wmsMovements = ref([]);
      const wmsLocationSummary = ref([]);
      const wmsInventoryList = ref([]); // 當前選擇倉區的庫存列表
      const showWmsInboundModal = ref(false);
      const showWmsTransferModal = ref(false);
      const showWmsOutboundModal = ref(false);
      const showLocationDetailModal = ref(false);
      const selectedLocation = ref(null);
      const formWms = ref({
        locationCode: '',
        workOrderId: '',
        quantity: 1,
        barcode: '',
        barcodes: [],
        operatorName: '',
        fromLocation: '',
        toLocation: '',
        inventoryId: '',
        reason: ''
      });

      // 盤點相關
      const showWmsStockTakeModal = ref(false);
      const stockTakeItems = ref([]);
      const formStockTake = ref({
        locationCode: '',
        operatorName: '',
        notes: ''
      });

      // Reinitialize Lucide icons when DOM updates
      function refreshIcons() {
        nextTick(() => {
          if (window.lucide) lucide.createIcons();
        });
      }

      // Watch for changes that need icon refresh
      watch([loading, currentTab, showCreateWoModal, showDispatchModal, showReportModal, showShareModal, showInspectionDetailModal, workOrders, dispatches], refreshIcons);

      // Event Handlers
      const onWoSelect = () => {
        const wo = workOrders.value.find(w => w.id === formEpc.value.workOrderId);
        selectedEpcWo.value = wo;
      };

      const onCustomerSelect = () => { formWo.value.customerSite = ''; };

      const onSourceWorkOrderSelect = () => {
        const sourceWo = workOrders.value.find(w => w.id === formWo.value.sourceWorkOrderId);
        if (sourceWo) {
          formWo.value.customerName = sourceWo.customerName;
          formWo.value.customerSite = sourceWo.customerSite || '';
          formWo.value.productModel = sourceWo.productModel;
          formWo.value.quantity = sourceWo.goodQty || sourceWo.quantity;
        }
      };

      // Edit Handlers
      const startEditOperator = (op) => { editingOperatorId.value = op.id; formOperator.value = { name: op.name, code: op.code }; };
      const cancelEditOperator = () => { editingOperatorId.value = null; formOperator.value = { name: '', code: '' }; };

      const startEditCustomer = (c) => {
        editingCustomerId.value = c.id;
        let sites = []; try { sites = JSON.parse(c.sites); } catch {}
        formCustomer.value = { name: c.name, code: c.code, sitesInput: sites.join(', ') };
      };
      const cancelEditCustomer = () => { editingCustomerId.value = null; formCustomer.value = { name: '', code: '', sitesInput: '' }; };

      const startEditProduct = (p) => { editingProductId.value = p.id; formProduct.value = { name: p.name, code: p.code, type: p.type }; };
      const cancelEditProduct = () => { editingProductId.value = null; formProduct.value = { name: '', code: '', type: '10cm' }; };

      // NG Reasons CRUD
      const startEditNgReason = (r) => { editingNgReasonId.value = r.id; formNgReason.value = { name: r.name, code: r.code, description: r.description }; };
      const cancelEditNgReason = () => { editingNgReasonId.value = null; formNgReason.value = { name: '', code: '', description: '' }; };

      const checkOldEpc = async () => {
        const epc = formEpc.value.oldEpc;
        if (!epc) return;
        epcCheckStatus.value = 'checking';
        epcCheckInfo.value = null;
        try {
          const record = await callApi('checkEpc', { epc });
          epcCheckInfo.value = record
            ? { found: true, message: `[已找到] ${record.productModel} (來自工單 ${record.orderNumber})` }
            : { found: false, message: `[注意] 系統無此 EPC 紀錄 (將視為首次入站)` };
        } catch (e) { console.error(e); }
        finally { epcCheckStatus.value = 'idle'; }
      };

      // API Wrapper (showLoading: 是否顯示載入動畫，預設 true)
      const callApi = (action, payload, showLoading = true) => {
        if (showLoading) {
          loadingCount.value++;
          loading.value = true;
        }
        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(res => {
              if (showLoading) {
                loadingCount.value--;
                if (loadingCount.value <= 0) loading.value = false;
              }
              if (res.success) resolve(res.data);
              else reject(res.error);
            })
            .withFailureHandler(err => {
              if (showLoading) {
                loadingCount.value--;
                if (loadingCount.value <= 0) loading.value = false;
              }
              reject(err);
            })
            .api(action, payload);
        });
      };

      window.onerror = () => { loading.value = false; loadingCount.value = 0; };

      // 從 localStorage 載入快取資料（立即顯示）
      const loadCachedData = () => {
        try {
          const cached = localStorage.getItem('MES_DATA_CACHE');
          if (cached) {
            const data = JSON.parse(cached);
            version.value = data.version || '';
            workOrders.value = data.workOrders || [];
            dispatches.value = data.dispatches || [];
            reports.value = data.reports || [];
            operators.value = data.operators || [];
            customers.value = data.customers || [];
            products.value = data.products || [];
            ngReasons.value = data.ngReasons || [];
            outgassingTests.value = data.outgassingTests || [];
            aoiInspections.value = data.aoiInspections || [];
            epcHistory.value = data.epcHistory || [];
            r0Labels.value = data.r0Labels || [];
            return true;
          }
        } catch (e) { console.warn('Cache load failed:', e); }
        return false;
      };

      // 儲存資料到 localStorage
      const saveCachedData = (ver, allData) => {
        try {
          const cacheData = {
            version: ver,
            workOrders: allData.workOrders,
            dispatches: allData.dispatches,
            reports: allData.reports,
            operators: allData.operators,
            customers: allData.customers,
            products: allData.products,
            ngReasons: allData.ngReasons,
            outgassingTests: allData.outgassingTests,
            aoiInspections: allData.aoiInspections,
            epcHistory: allData.epcHistory,
            r0Labels: allData.r0Labels,
            cachedAt: Date.now()
          };
          localStorage.setItem('MES_DATA_CACHE', JSON.stringify(cacheData));
        } catch (e) { console.warn('Cache save failed:', e); }
      };

      const refreshData = async (showLoading = true) => {
        try {
          // 效能優化：單次 API 取得所有資料（含快取）
          const [ver, allData] = await Promise.all([
            callApi('getVersion', null, showLoading),
            callApi('getAllData', null, showLoading)
          ]);
          version.value = ver;
          workOrders.value = allData.workOrders || [];
          dispatches.value = allData.dispatches || [];
          reports.value = allData.reports || [];
          operators.value = allData.operators || [];
          customers.value = allData.customers || [];
          products.value = allData.products || [];
          ngReasons.value = allData.ngReasons || [];
          outgassingTests.value = allData.outgassingTests || [];
          aoiInspections.value = allData.aoiInspections || [];
          epcHistory.value = allData.epcHistory || [];
          r0Labels.value = allData.r0Labels || [];
          // 儲存到本地快取
          saveCachedData(ver, allData);
        } catch (e) { if (showLoading) alert('載入失敗: ' + e); }
      };

      // Share Functions
      const openShareModal = async () => {
        showShareModal.value = true;
        shareLoading.value = true;
        shareData.value = null;
        shareCopied.value = false;
        try {
          shareData.value = await callApi('getShortUrl', {});
        } catch (e) {
          console.error('產生短網址失敗:', e);
          // 使用 fallback
          const currentUrl = window.location.href;
          shareData.value = {
            shortUrl: currentUrl,
            qrCodeUrl: 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(currentUrl)
          };
        } finally {
          shareLoading.value = false;
        }
      };

      const copyShareUrl = async () => {
        if (!shareData.value?.shortUrl) return;
        try {
          await navigator.clipboard.writeText(shareData.value.shortUrl);
          shareCopied.value = true;
          setTimeout(() => { shareCopied.value = false; }, 3000);
        } catch (e) {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = shareData.value.shortUrl;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          shareCopied.value = true;
          setTimeout(() => { shareCopied.value = false; }, 3000);
        }
      };

      // CRUD Operations
      const submitOperator = async () => {
        try {
          if (editingOperatorId.value) await callApi('updateOperator', { id: editingOperatorId.value, data: { ...formOperator.value } });
          else await callApi('createOperator', { ...formOperator.value });
          cancelEditOperator();
          await refreshData();
        } catch (e) { alert(e); }
      };

      const deleteOperator = async (id) => {
        if (!confirm('確定要刪除此人員嗎？')) return;
        try { await callApi('deleteOperator', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      const submitCustomer = async () => {
        try {
          const sites = formCustomer.value.sitesInput.split(/[,，\n]+/).map(s => s.trim()).filter(s => s);
          if (editingCustomerId.value) await callApi('updateCustomer', { id: editingCustomerId.value, data: { name: formCustomer.value.name, code: formCustomer.value.code, sites } });
          else await callApi('createCustomer', { ...formCustomer.value, sites });
          cancelEditCustomer();
          await refreshData();
        } catch (e) { alert(e); }
      };

      const deleteCustomer = async (id) => {
        if (!confirm('確定要刪除此客戶嗎？')) return;
        try { await callApi('deleteCustomer', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      const submitProduct = async () => {
        try {
          if (editingProductId.value) await callApi('updateProduct', { id: editingProductId.value, data: { ...formProduct.value } });
          else await callApi('createProduct', { ...formProduct.value });
          cancelEditProduct();
          await refreshData();
        } catch (e) { alert(e); }
      };

      const deleteProduct = async (id) => {
        if (!confirm('確定要刪除此產品嗎？')) return;
        try { await callApi('deleteProduct', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      // NG Reasons Submit/Delete
      const submitNgReason = async () => {
        try {
          if (editingNgReasonId.value) await callApi('updateNgReason', { id: editingNgReasonId.value, data: { ...formNgReason.value } });
          else await callApi('createNgReason', { ...formNgReason.value });
          cancelEditNgReason();
          await refreshData();
        } catch (e) { alert(e); }
      };

      const deleteNgReason = async (id) => {
        if (!confirm('確定要刪除此 NG 原因嗎？')) return;
        try { await callApi('deleteNgReason', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      const submitEpcChange = async () => {
        try {
          if (!formEpc.value.workOrderId || !formEpc.value.newEpc || !formEpc.value.operatorName) {
            alert('請填寫所有必要欄位'); return;
          }
          await callApi('createEpcHistory', { ...formEpc.value });
          alert('綁定成功！');
          formEpc.value.oldEpc = ''; formEpc.value.newEpc = ''; epcCheckInfo.value = null;
          await refreshData();
        } catch (e) { alert(e); }
      };

      const submitWorkOrder = async () => {
        if (formWo.value.orderType === 'regeneration' && !formWo.value.sourceWorkOrderId) { alert('再生工單必須選擇來源除膠工單'); return; }
        if (formWo.value.orderType === 'rework' && !formWo.value.sourceWorkOrderId) { alert('重工工單必須選擇來源工單'); return; }
        if (!formWo.value.customerName) { alert('請選擇客戶'); return; }
        if (!formWo.value.productModel) { alert('請選擇產品'); return; }
        if (!formWo.value.quantity || formWo.value.quantity <= 0) { alert('請輸入有效數量'); return; }

        const payload = { ...formWo.value };
        if ((payload.orderType === 'regeneration' || payload.orderType === 'rework') && payload.sourceWorkOrderId) {
          const sourceWo = workOrders.value.find(w => w.id === payload.sourceWorkOrderId);
          if (sourceWo) payload.sourceOrderNumber = sourceWo.orderNumber;
        }

        try {
          if (editingWorkOrderId.value) await callApi('updateWorkOrder', { id: editingWorkOrderId.value, data: payload });
          else await callApi('createWorkOrder', payload);
          showCreateWoModal.value = false;
          formWo.value = { customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' };
          editingWorkOrderId.value = null;
          await refreshData();
        } catch (e) { alert(e); }
      };

      const startEditWorkOrder = (wo) => {
        editingWorkOrderId.value = wo.id;
        formWo.value = {
          customerName: wo.customerName, customerSite: wo.customerSite || '', productModel: wo.productModel,
          quantity: wo.quantity, orderType: wo.orderType, priority: wo.priority,
          targetRegenerationCount: wo.targetRegenerationCount || 1, sourceWorkOrderId: wo.sourceWorkOrderId || ''
        };
        showCreateWoModal.value = true;
      };

      // 快速建立工單（指定類型）
      const openCreateWoModal = (orderType) => {
        editingWorkOrderId.value = null;
        formWo.value = {
          customerName: '', customerSite: '', productModel: '', quantity: 10,
          orderType: orderType,
          priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: ''
        };
        showCreateWoModal.value = true;
      };

      const cancelEditWorkOrder = () => {
        editingWorkOrderId.value = null;
        formWo.value = { customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' };
        showCreateWoModal.value = false;
      };

      const deleteWorkOrder = async (id) => {
        if (!confirm('確定要取消此工單嗎？')) return;
        try { await callApi('deleteWorkOrder', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      const openDispatchModal = (wo) => {
        selectedWo.value = wo;
        // 依工單類型設定預設站點
        let defaultStation = '除膠站';
        if (wo.orderType === 'regeneration') defaultStation = '烘箱站';
        else if (wo.orderType === 'rework') defaultStation = '烘箱站';
        formDispatch.value = { workOrderId: wo.id, stationName: defaultStation, operatorName: '', quantity: wo.quantity - wo.completedQty };
        showDispatchModal.value = true;
      };

      const submitDispatch = async () => {
        if (!formDispatch.value.operatorName) { alert('請選擇作業員'); return; }
        if (!formDispatch.value.quantity || formDispatch.value.quantity <= 0) { alert('請輸入有效數量'); return; }
        try {
          await callApi('createDispatch', { ...formDispatch.value });
          showDispatchModal.value = false;
          await refreshData();
          currentTab.value = 'dispatches';
        } catch (e) { alert(e); }
      };

      const deleteDispatch = async (id) => {
        if (!confirm('確定要取消此派工嗎？')) return;
        try { await callApi('deleteDispatch', { id }); await refreshData(); } catch (e) { alert(e); }
      };

      const startJob = async (d) => {
        try { await callApi('startDispatch', { id: d.id }); await refreshData(); } catch (e) { alert(e); }
      };

      const completeJob = async (d) => {
        try {
          await callApi('completeDispatch', { id: d.id });
          await refreshData();
          const updatedD = dispatches.value.find(x => x.id === d.id);
          openReportModal(updatedD);
        } catch (e) { alert(e); }
      };

      const openReportModal = (d) => {
        selectedDispatch.value = d;
        formReport.value = {
          dispatchId: d.id, goodQty: 0, ngQty: 0, hasAbnormal: false, abnormalType: '',
          operatorName: d.operatorName, stationName: d.stationName,
          startTime: d.actualStartAt || new Date().toISOString(),
          endTime: d.actualEndAt || new Date().toISOString()
        };
        showReportModal.value = true;
        // 重置 NG 明細
        formReport.value.ngDetails = [];
        resetNgDetailForm();
      };

      // NG 明細相關函數
      const resetNgDetailForm = () => {
        currentNgReason.value = null;
        currentNgQty.value = 1;
        currentNgBarcodes.value = [];
        currentNgBarcodeInput.value = '';
      };

      const scanNgBarcode = () => {
        const code = currentNgBarcodeInput.value.trim();
        if (!code) return;
        if (currentNgBarcodes.value.includes(code)) {
          alert('此條碼已掃描過');
          return;
        }
        currentNgBarcodes.value.push(code);
        currentNgBarcodeInput.value = '';
      };

      const removeNgBarcode = (code) => {
        const idx = currentNgBarcodes.value.indexOf(code);
        if (idx > -1) currentNgBarcodes.value.splice(idx, 1);
      };

      const addNgDetail = () => {
        if (!currentNgReason.value) {
          alert('請選擇 NG 原因');
          return;
        }
        if (currentNgQty.value < 1) {
          alert('數量必須大於 0');
          return;
        }
        const reason = ngReasons.value.find(r => r.id === currentNgReason.value);
        formReport.value.ngDetails.push({
          reasonId: currentNgReason.value,
          reasonName: reason?.name || '',
          reasonCode: reason?.code || '',
          quantity: currentNgQty.value,
          barcodes: [...currentNgBarcodes.value]
        });
        // 自動更新總 NG 數量
        formReport.value.ngQty = formReport.value.ngDetails.reduce((sum, d) => sum + d.quantity, 0);
        resetNgDetailForm();
      };

      const removeNgDetail = (idx) => {
        formReport.value.ngDetails.splice(idx, 1);
        // 自動更新總 NG 數量
        formReport.value.ngQty = formReport.value.ngDetails.reduce((sum, d) => sum + d.quantity, 0);
      };

      const submitReport = async () => {
        try {
          formReport.value.endTime = new Date().toISOString();
          formReport.value.quantity = formReport.value.goodQty + formReport.value.ngQty;
          const reportResult = await callApi('createReport', { ...formReport.value });
          // 儲存 NG 明細
          if (formReport.value.ngDetails.length > 0 && reportResult?.id) {
            for (const detail of formReport.value.ngDetails) {
              await callApi('createNgDetail', {
                reportId: reportResult.id,
                dispatchId: formReport.value.dispatchId,
                workOrderId: formReport.value.workOrderId,
                reasonId: detail.reasonId,
                reasonName: detail.reasonName,
                quantity: detail.quantity,
                barcodes: detail.barcodes
              });
            }
          }
          showReportModal.value = false;
          await refreshData();
        } catch (e) { alert(e); }
      };

      const getStatusClass = (status) => {
        return { draft: 'bg-gray-200', pending: 'bg-yellow-100', in_progress: 'bg-blue-100', completed: 'bg-green-100', paused: 'bg-red-100' }[status] || '';
      };

      // Signature Pad
      const getSignatureCanvas = (type) => type === 'outgassing' ? signaturePadOutgassing.value : signaturePadAoi.value;

      const startSign = (e, type) => {
        const canvas = getSignatureCanvas(type);
        if (!canvas) return;
        isDrawing.value = true;
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        lastPos.value = { x: (touch.clientX - rect.left) * (canvas.width / rect.width), y: (touch.clientY - rect.top) * (canvas.height / rect.height) };
      };

      const drawSign = (e, type) => {
        if (!isDrawing.value) return;
        const canvas = getSignatureCanvas(type);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches ? e.touches[0] : e;
        const pos = { x: (touch.clientX - rect.left) * (canvas.width / rect.width), y: (touch.clientY - rect.top) * (canvas.height / rect.height) };
        ctx.beginPath(); ctx.moveTo(lastPos.value.x, lastPos.value.y); ctx.lineTo(pos.x, pos.y);
        ctx.strokeStyle = '#1e3a5f'; ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.stroke();
        lastPos.value = pos;
      };

      const endSign = (type) => {
        isDrawing.value = false;
        const canvas = getSignatureCanvas(type);
        if (canvas) {
          const dataUrl = canvas.toDataURL('image/png');
          if (type === 'outgassing') formOutgassing.value.signature = dataUrl;
          else formAoiSingle.value.signature = dataUrl;
        }
      };

      const clearSignature = (type) => {
        const canvas = getSignatureCanvas(type);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (type === 'outgassing') formOutgassing.value.signature = '';
        else formAoiSingle.value.signature = '';
      };

      // Outgassing
      const loadOutgassingSampleInfo = async () => {
        if (!formOutgassing.value.workOrderId) { outgassingSampleInfo.value = null; return; }
        try { outgassingSampleInfo.value = await callApi('getOutgassingSampleInfo', { workOrderId: formOutgassing.value.workOrderId }); }
        catch (e) { console.error(e); }
      };

      const submitOutgassingTest = async () => {
        if (!formOutgassing.value.workOrderId) { alert('請選擇工單'); return; }
        if (!formOutgassing.value.result) { alert('請選擇檢驗結果'); return; }
        if (!formOutgassing.value.operatorName) { alert('請選擇檢驗員'); return; }
        try {
          await callApi('createOutgassingTest', { ...formOutgassing.value });
          if (formOutgassing.value.result === 'NG') alert('檢驗結果: NG\n\n依規定需加抽 2 片再測，若仍超標則回爐重烤。');
          formOutgassing.value.rfidCode = ''; formOutgassing.value.result = ''; formOutgassing.value.notes = ''; formOutgassing.value.signature = '';
          clearSignature('outgassing');
          await refreshData(); await loadOutgassingSampleInfo();
        } catch (e) { alert(e); }
      };

      const generateOutgassingReport = () => {
        if (!formOutgassing.value.workOrderId) { alert('請先選擇工單'); return; }
        const wo = workOrders.value.find(w => w.id === formOutgassing.value.workOrderId);
        const tests = outgassingTests.value.filter(t => t.workOrderId === formOutgassing.value.workOrderId);
        const info = outgassingSampleInfo.value;
        if (!wo || tests.length === 0) { alert('無檢驗資料可產生報告'); return; }
        const lastTestWithSig = [...tests].reverse().find(t => t.signature);
        const lastSignature = lastTestWithSig?.signature || '';
        const reportHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>釋氣檢驗報告 - ${wo.orderNumber}</title><style>body{font-family:'Microsoft JhengHei',sans-serif;padding:20px;max-width:800px;margin:0 auto}.header{text-align:center;border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:20px}.header h1{margin:0;font-size:24px}.header p{margin:5px 0;color:#666}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}.info-item{padding:8px;background:#f5f5f5;border-radius:4px}.info-item label{font-size:12px;color:#666;display:block}.info-item span{font-weight:bold}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background:#f0f0f0;font-weight:bold}.pass{color:green;font-weight:bold}.ng{color:red;font-weight:bold}.summary{background:#e8f5e9;padding:15px;border-radius:8px;margin:20px 0}.summary.warning{background:#fff3e0}.signature-section{margin-top:30px;display:flex;justify-content:flex-end}.signature-box{text-align:center}.signature-box img{max-height:80px;border-bottom:1px solid #333}.signature-box p{margin:5px 0 0;font-size:12px}.footer{margin-top:40px;text-align:center;font-size:11px;color:#999;border-top:1px solid #eee;padding-top:10px}@media print{body{padding:0}.no-print{display:none}}</style></head><body><div class="header"><h1>釋氣檢驗報告</h1><p>Outgassing Inspection Report</p></div><div class="info-grid"><div class="info-item"><label>工單編號</label><span>${wo.orderNumber}</span></div><div class="info-item"><label>客戶</label><span>${wo.customerName} / ${wo.customerSite||'-'}</span></div><div class="info-item"><label>產品型號</label><span>${wo.productModel}</span></div><div class="info-item"><label>工單數量</label><span>${info?.totalQty||wo.quantity} 片</span></div><div class="info-item"><label>抽樣規則</label><span>18 抽 1 (5.56%)</span></div><div class="info-item"><label>報告日期</label><span>${new Date().toLocaleDateString('zh-TW')}</span></div></div><h3>檢驗結果明細</h3><table><thead><tr><th>序號</th><th>檢驗單號</th><th>條碼</th><th>結果</th><th>備註</th><th>檢驗員</th><th>時間</th></tr></thead><tbody>${tests.map((t,i)=>`<tr><td>${i+1}</td><td>${t.testNumber||'-'}</td><td>${t.rfidCode||'-'}</td><td class="${t.result==='PASS'?'pass':'ng'}">${t.result}</td><td>${t.notes||'-'}</td><td>${t.operatorName||'-'}</td><td>${t.testedAt?new Date(t.testedAt).toLocaleString('zh-TW'):'-'}</td></tr>`).join('')}</tbody></table><div class="summary ${info?.passRate<100?'warning':''}"><strong>檢驗摘要</strong><br>已檢驗: ${info?.testedCount||tests.length} 片 / 需抽樣: ${info?.requiredSamples||'-'} 片<br>合格: ${info?.passCount||tests.filter(t=>t.result==='PASS').length} 片 | 不合格: ${info?.failCount||tests.filter(t=>t.result==='NG').length} 片<br><strong>合格率: ${info?.passRate||Math.round(tests.filter(t=>t.result==='PASS').length/tests.length*100)}%</strong></div><div class="signature-section"><div class="signature-box">${lastSignature?`<img src="${lastSignature}" alt="簽名">`:'<div style="width:150px;height:60px;border-bottom:1px solid #333;"></div>'}<p>品檢人員簽名</p></div></div><div class="footer">SMAI-MES 品質管理系統 | 報告產生時間: ${new Date().toLocaleString('zh-TW')} | v${systemVersion.value}</div><div class="no-print" style="margin-top:20px;text-align:center;"><button onclick="window.print()" style="padding:10px 30px;font-size:16px;cursor:pointer;">列印報告</button></div></body></html>`;
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportHtml);
        reportWindow.document.close();
      };

      // 單筆釋氣檢驗報告
      const generateSingleOutgassingReport = (test) => {
        if (!test) { alert('無檢驗資料'); return; }
        const wo = workOrders.value.find(w => w.id === test.workOrderId);
        if (!wo) { alert('找不到對應工單'); return; }
        const signature = test.signature || '';
        const reportHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>釋氣檢驗報告 - ${test.testNumber || test.inspectionNumber}</title><style>body{font-family:'Microsoft JhengHei',sans-serif;padding:20px;max-width:800px;margin:0 auto}.header{text-align:center;border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:20px}.header h1{margin:0;font-size:24px}.header p{margin:5px 0;color:#666}.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px}.info-item{padding:8px;background:#f5f5f5;border-radius:4px}.info-item label{font-size:12px;color:#666;display:block}.info-item span{font-weight:bold}.result-box{padding:20px;border-radius:8px;text-align:center;margin:20px 0}.result-box.pass{background:#dcfce7;border:2px solid #16a34a}.result-box.ng{background:#fee2e2;border:2px solid #dc2626}.result-text{font-size:36px;font-weight:bold}.result-text.pass{color:#16a34a}.result-text.ng{color:#dc2626}.signature-section{margin-top:30px;display:flex;justify-content:flex-end}.signature-box{text-align:center}.signature-box img{max-height:80px;border-bottom:1px solid #333}.signature-box p{margin:5px 0 0;font-size:12px}.footer{margin-top:40px;text-align:center;font-size:11px;color:#999;border-top:1px solid #eee;padding-top:10px}@media print{body{padding:0}.no-print{display:none}}</style></head><body><div class="header"><h1>釋氣檢驗報告</h1><p>Outgassing Inspection Report</p></div><div class="info-grid"><div class="info-item"><label>檢驗單號</label><span>${test.testNumber || test.inspectionNumber || '-'}</span></div><div class="info-item"><label>工單編號</label><span>${wo.orderNumber}</span></div><div class="info-item"><label>客戶/廠區</label><span>${wo.customerName} / ${wo.customerSite || '-'}</span></div><div class="info-item"><label>產品型號</label><span>${wo.productModel}</span></div><div class="info-item"><label>條碼/序號</label><span>${test.rfidCode || '-'}</span></div><div class="info-item"><label>檢驗時間</label><span>${test.testedAt ? new Date(test.testedAt).toLocaleString('zh-TW') : '-'}</span></div></div><div class="result-box ${test.result === 'PASS' ? 'pass' : 'ng'}"><div class="result-text ${test.result === 'PASS' ? 'pass' : 'ng'}">${test.result}</div><p style="margin:10px 0 0;color:#666;">檢驗結果</p></div>${test.notes ? `<div style="background:#f5f5f5;padding:15px;border-radius:8px;margin:20px 0;"><strong>備註：</strong>${test.notes}</div>` : ''}<div style="display:flex;justify-content:space-between;align-items:flex-end;margin-top:30px;"><div><p style="margin:0 0 5px;color:#666;font-size:12px;">檢驗員</p><p style="margin:0;font-weight:bold;">${test.operatorName || '-'}</p></div><div class="signature-box">${signature ? `<img src="${signature}" alt="簽名">` : '<div style="width:150px;height:60px;border-bottom:1px solid #333;"></div>'}<p>品檢人員簽名</p></div></div><div class="footer">SMAI-MES 品質管理系統 | 報告產生時間: ${new Date().toLocaleString('zh-TW')} | v${systemVersion.value}</div><div class="no-print" style="margin-top:20px;text-align:center;"><button onclick="window.print()" style="padding:10px 30px;font-size:16px;cursor:pointer;">列印報告</button></div></body></html>`;
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportHtml);
        reportWindow.document.close();
      };

      // AOI
      const handleAoiCsvFile = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const text = e.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          if (lines.length < 2) { alert('CSV 檔案格式錯誤或無資料'); return; }
          const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          const rows = [];

          // 檢查是否為 AOI 實際格式 (欄位包含 日期, 序號, 辨識結果)
          const isAoiFormat = headers.includes('日期') || headers.includes('序號') || headers.includes('辨識結果');

          for (let i = 1; i < lines.length; i++) {
            let row = {};
            const line = lines[i].trim();
            if (!line) continue;

            if (isAoiFormat) {
              // AOI 格式: 所有資料可能被包在第一欄引號內
              let values;
              if (line.startsWith('"')) {
                // 異常格式: "2026-01-06, 20260106_142553, R12TA225, ..."
                const content = line.replace(/^"|"$/g, '').split('",')[0];
                values = content.split(', ');
              } else {
                values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
              }

              // AOI 欄位: 日期[0],MeasureID[1],工單號碼[2],序號[3],配方[4],方向[5],X[6],Y[7],W[8],H[9],辨識結果[10],路徑[11],User[12]
              const serial = values[3] || '';
              const result = (values[10] || '').toLowerCase();

              if (serial) {
                row = {
                  rfidCode: serial,
                  result: (result === 'damage' || result === 'ng' || result === 'fail') ? 'NG' : 'PASS',
                  defectType: result === 'damage' ? 'damage' : '',
                  defectCount: (result === 'damage' || result === 'ng') ? 1 : 0
                };
              }
            } else {
              // 標準格式
              const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
              headers.forEach((h, idx) => {
                const hLower = h.toLowerCase();
                if (hLower.includes('barcode') || hLower.includes('rfid') || h === '條碼' || h === '序號') row.rfidCode = values[idx];
                else if (hLower.includes('result') || h === '結果' || h === '辨識結果') {
                  const val = (values[idx] || '').toLowerCase();
                  row.result = (val === 'pass' || val === 'ok') ? 'PASS' : 'NG';
                }
                else if (hLower.includes('defect') && hLower.includes('type') || h === '缺陷類型') row.defectType = values[idx];
                else if (hLower.includes('defect') && hLower.includes('count') || h === '缺陷數量') row.defectCount = Number(values[idx]) || 0;
              });
            }

            if (row.rfidCode) rows.push(row);
          }

          // AOI 格式需彙整同序號的缺陷
          if (isAoiFormat && rows.length > 0) {
            const grouped = {};
            rows.forEach(r => {
              if (!grouped[r.rfidCode]) {
                grouped[r.rfidCode] = { rfidCode: r.rfidCode, result: 'PASS', defectType: '', defectCount: 0 };
              }
              if (r.result === 'NG') {
                grouped[r.rfidCode].result = 'NG';
                grouped[r.rfidCode].defectType = r.defectType || 'damage';
                grouped[r.rfidCode].defectCount++;
              }
            });
            aoiCsvPreview.value = Object.values(grouped);
            alert(`已解析 AOI 格式\n原始 ${rows.length} 筆缺陷記錄\n彙整為 ${Object.keys(grouped).length} 個序號`);
          } else {
            aoiCsvPreview.value = rows;
          }
        };
        reader.readAsText(file);
      };

      const submitAoiImport = async () => {
        if (!formAoi.value.workOrderId) { alert('請選擇工單'); return; }
        if (!formAoi.value.operatorName) { alert('請選擇匯入人員'); return; }
        if (aoiCsvPreview.value.length === 0) { alert('請先選擇 CSV 檔案'); return; }
        try {
          const result = await callApi('importAoiCsv', { workOrderId: formAoi.value.workOrderId, csvRows: aoiCsvPreview.value, operatorName: formAoi.value.operatorName });
          alert(`匯入完成！\n成功: ${result.success} 筆\n失敗: ${result.failed} 筆`);
          aoiCsvPreview.value = [];
          await refreshData();
        } catch (e) { alert(e); }
      };

      const submitSingleAoi = async () => {
        if (!formAoi.value.workOrderId) { alert('請先在上方選擇工單'); return; }
        if (!formAoiSingle.value.rfidCode) { alert('請輸入條碼編號'); return; }
        if (!formAoiSingle.value.result) { alert('請選擇檢驗結果'); return; }
        try {
          await callApi('createAoiInspection', { workOrderId: formAoi.value.workOrderId, operatorName: formAoi.value.operatorName || '系統', ...formAoiSingle.value });
          if (formAoiSingle.value.result === 'NG' && (formAoiSingle.value.defectType || '').includes('破洞')) alert('嚴重瑕疵: 破洞\n此件須直接報廢處理。');
          formAoiSingle.value = { rfidCode: '', result: '', defectType: '' };
          await refreshData();
        } catch (e) { alert(e); }
      };

      // View Inspection Detail
      const viewInspectionDetail = (item, type) => {
        selectedInspection.value = item;
        inspectionType.value = type;
        showInspectionDetailModal.value = true;
      };

      // Admin Functions
      const adminSyncDatabase = async () => {
        adminLoading.value = true; adminMessage.value = '';
        try {
          const result = await callApi('syncDatabase');
          adminMessageType.value = 'success'; adminMessage.value = `資料庫同步完成！${result.message || ''}`;
        } catch (e) { adminMessageType.value = 'error'; adminMessage.value = '同步失敗: ' + e; }
        finally { adminLoading.value = false; }
      };

      const adminFixColumnOrder = async () => {
        adminLoading.value = true; adminMessage.value = '';
        try {
          const result = await callApi('fixColumnOrder');
          adminMessageType.value = 'success';
          const fixed = result.fixed || [];
          adminMessage.value = fixed.length > 0 ? `已修復欄位順序: ${fixed.join(', ')}` : '所有資料表欄位順序正確，無需修復';
          await refreshData();
        } catch (e) { adminMessageType.value = 'error'; adminMessage.value = '修復失敗: ' + e; }
        finally { adminLoading.value = false; }
      };

      const adminFixSignatureData = async () => {
        adminLoading.value = true; adminMessage.value = '';
        try {
          const result = await callApi('fixSignatureData');
          adminMessageType.value = 'success';
          const tables = result.tables || [];
          adminMessage.value = result.fixed > 0 ? `已修復簽名資料: ${tables.join(', ')}` : '所有簽名資料位置正確，無需修復';
          await refreshData();
        } catch (e) { adminMessageType.value = 'error'; adminMessage.value = '修復失敗: ' + e; }
        finally { adminLoading.value = false; }
      };

      const adminGenerateTestData = async () => {
        if (!confirm('確定要產生測試資料嗎？')) return;
        adminLoading.value = true; adminMessage.value = '';
        try {
          const result = await callApi('generateTestData');
          adminMessageType.value = 'success';
          adminMessage.value = `測試資料產生完成！新增 ${result.customers} 個客戶、${result.products} 個產品、${result.operators} 個作業員、${result.workOrders} 張工單`;
          await refreshData();
        } catch (e) { adminMessageType.value = 'error'; adminMessage.value = '產生失敗: ' + e; }
        finally { adminLoading.value = false; }
      };

      // R0 Management Functions

      /**
       * 將文字轉換為 Hex 格式 (用於 EPC 編碼)
       * @param {string} text - 原始文字
       * @param {number} length - 目標長度 (hex 字元數)
       * @returns {string} - Hex 字串，不足補 0，超過截斷
       */
      const textToHex = (text, length) => {
        if (!text) return '0'.repeat(length);
        // 將每個字元轉為 hex，取 ASCII 碼
        let hex = '';
        for (let i = 0; i < text.length && hex.length < length; i++) {
          const code = text.charCodeAt(i);
          if (code < 128) {
            // ASCII 字元直接用
            hex += text[i].toUpperCase();
          } else {
            // 非 ASCII 轉為 hex
            hex += code.toString(16).toUpperCase();
          }
        }
        // 補 0 或截斷
        return hex.slice(0, length).padEnd(length, '0');
      };

      /**
       * 產生 EPC 編碼 (方案A: 結構化)
       * 格式: [Header:2][Customer:4][Product:4][Year:2][Serial:12] = 24 位 hex
       * 範例: E2TSM0HP1026000000000001
       */
      const generateEpc = (customerCode, productCode) => {
        const header = epcConfig.value.header || 'E2';
        const customer = textToHex(customerCode || 'XXXX', 4);
        const product = textToHex(productCode || 'XXXX', 4);
        const year = new Date().getFullYear().toString().slice(-2);
        const serial = String(epcSerialCounter.value).padStart(12, '0');

        const epc = `${header}${customer}${product}${year}${serial}`;

        // 遞增序號
        epcSerialCounter.value++;
        localStorage.setItem('epcSerialCounter', epcSerialCounter.value.toString());

        return epc.toUpperCase();
      };

      /**
       * 解析 EPC 編碼
       */
      const parseEpc = (epc) => {
        if (!epc || epc.length < 24) return null;
        return {
          header: epc.slice(0, 2),
          customerCode: epc.slice(2, 6),
          productCode: epc.slice(6, 10),
          year: '20' + epc.slice(10, 12),
          serial: parseInt(epc.slice(12, 24), 10)
        };
      };

      const onR0WorkOrderSelect = () => {
        const wo = workOrders.value.find(w => w.id === formR0Generate.value.workOrderId);
        if (wo) {
          // Get customer code
          const customer = customers.value.find(c => c.name === wo.customerName);
          formR0Generate.value.customerCode = customer?.code || wo.customerName.slice(0, 3).toUpperCase();
          // Get product code
          const product = products.value.find(p => p.name === wo.productModel || p.code === wo.productModel);
          formR0Generate.value.productCode = product?.code || wo.productModel.slice(0, 4).toUpperCase();
        }
      };

      const generateR0Code = (customerCode, areaCode, serialNum) => {
        const year = new Date().getFullYear().toString().slice(-2);
        const serial = String(serialNum).padStart(6, '0');
        return `R0${customerCode}@${printerConfig.value.yearPrefix}${year}${areaCode}${serial}`;
      };

      const generateR0Labels = () => {
        if (!formR0Generate.value.workOrderId || !formR0Generate.value.quantity) return;
        const wo = workOrders.value.find(w => w.id === formR0Generate.value.workOrderId);
        if (!wo) return;

        const qty = formR0Generate.value.quantity;
        const customerCode = formR0Generate.value.customerCode || 'XXX';
        const areaCode = formR0Generate.value.areaCode || 'A';

        for (let i = 0; i < qty; i++) {
          const r0Code = generateR0Code(customerCode, areaCode, r0SerialCounter.value);
          r0GenerateQueue.value.push({
            r0Code,
            workOrderId: wo.id,
            orderNumber: wo.orderNumber,
            customerName: wo.customerName,
            productModel: wo.productModel,
            status: 'pending',
            epc: null
          });
          r0SerialCounter.value++;
        }
        localStorage.setItem('r0SerialCounter', r0SerialCounter.value.toString());
      };

      const startR0Printing = async () => {
        if (r0GenerateQueue.value.length === 0) return;

        for (const item of r0GenerateQueue.value) {
          if (item.status === 'printed') continue;
          item.status = 'printing';

          if (printerConfig.value.simulationMode) {
            // Simulation mode: wait for manual EPC input
            await new Promise(r => setTimeout(r, 500));
            item.status = 'pending'; // Keep pending until EPC is entered
          } else {
            // Real printer: send SBPL command and wait for callback
            try {
              // TODO: Implement real SATO printer communication
              item.status = 'pending';
            } catch (e) {
              console.error('Print error:', e);
            }
          }
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      /**
       * 瀏覽器列印預覽 - 用任何印表機測試標籤
       */
      const printLabelPreview = () => {
        const items = r0GenerateQueue.value.filter(i => i.status !== 'printed');
        if (items.length === 0) {
          alert('沒有待列印的標籤');
          return;
        }

        const labelWidth = 65; // mm
        const labelHeight = 35; // mm
        const date = new Date().toLocaleDateString('zh-TW');

        let labelsHtml = items.map((item, idx) => {
          const epc = item.epc || '(待綁定 EPC)';
          const status = item.regenerationStatus || 'R0';
          return `
            <div class="label" style="
              width: ${labelWidth}mm;
              height: ${labelHeight}mm;
              border: 1px solid #000;
              padding: 2mm;
              margin: 2mm;
              display: inline-block;
              vertical-align: top;
              font-family: Arial, sans-serif;
              box-sizing: border-box;
              page-break-inside: avoid;
            ">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                  <div style="font-size: 10pt; font-weight: bold;">${item.customerName || ''}</div>
                  <div style="font-size: 8pt; color: #666;">${item.productModel || ''}</div>
                </div>
                <div style="font-size: 14pt; font-weight: bold; border: 2px solid #000; padding: 1mm 3mm;">${status}</div>
              </div>
              <div style="margin-top: 3mm;">
                <div style="font-size: 7pt; color: #666;">R0 編碼:</div>
                <div style="font-size: 9pt; font-weight: bold; font-family: monospace;">${item.r0Code}</div>
              </div>
              <div style="margin-top: 2mm;">
                <div style="font-size: 7pt; color: #666;">EPC:</div>
                <div style="font-size: 7pt; font-family: monospace; word-break: break-all;">${epc}</div>
              </div>
              <div style="margin-top: 2mm; font-size: 6pt; color: #999;">${date} | #${idx + 1}</div>
            </div>
          `;
        }).join('');

        const printHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>標籤列印預覽</title>
            <style>
              @media print {
                body { margin: 0; }
                .no-print { display: none; }
              }
              body { font-family: Arial, sans-serif; }
              .print-header { padding: 10px; background: #f0f0f0; margin-bottom: 10px; }
              .labels-container { padding: 5mm; }
            </style>
          </head>
          <body>
            <div class="print-header no-print">
              <h3 style="margin: 0 0 10px;">標籤列印預覽 (共 ${items.length} 張)</h3>
              <button onclick="window.print()" style="padding: 10px 20px; font-size: 14px; cursor: pointer;">
                列印標籤
              </button>
              <button onclick="window.close()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; cursor: pointer;">
                關閉
              </button>
              <p style="margin: 10px 0 0; font-size: 12px; color: #666;">
                提示: 實際標籤尺寸為 ${labelWidth}mm x ${labelHeight}mm，請調整印表機設定
              </p>
            </div>
            <div class="labels-container">
              ${labelsHtml}
            </div>
          </body>
          </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHtml);
        printWindow.document.close();
      };

      /**
       * 補印單一標籤
       */
      const reprintLabel = (label) => {
        const labelWidth = 65;
        const labelHeight = 35;
        const date = new Date().toLocaleDateString('zh-TW');
        const status = label.regenerationStatus || 'R0';
        const epc = label.currentEpc || label.epc || '(無 EPC)';

        const printHtml = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>補印標籤 - ${label.r0Code}</title>
            <style>
              @media print { body { margin: 0; } .no-print { display: none; } }
              body { font-family: Arial, sans-serif; }
              .print-header { padding: 10px; background: #f0f0f0; margin-bottom: 10px; }
            </style>
          </head>
          <body>
            <div class="print-header no-print">
              <h3 style="margin: 0 0 10px;">補印標籤</h3>
              <button onclick="window.print()" style="padding: 10px 20px; font-size: 14px; cursor: pointer;">列印</button>
              <button onclick="window.close()" style="padding: 10px 20px; font-size: 14px; margin-left: 10px; cursor: pointer;">關閉</button>
            </div>
            <div style="padding: 5mm;">
              <div style="
                width: ${labelWidth}mm;
                height: ${labelHeight}mm;
                border: 1px solid #000;
                padding: 2mm;
                font-family: Arial, sans-serif;
                box-sizing: border-box;
              ">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div>
                    <div style="font-size: 10pt; font-weight: bold;">${label.customerName || ''}</div>
                    <div style="font-size: 8pt; color: #666;">${label.productModel || ''}</div>
                  </div>
                  <div style="font-size: 14pt; font-weight: bold; border: 2px solid #000; padding: 1mm 3mm;">${status}</div>
                </div>
                <div style="margin-top: 3mm;">
                  <div style="font-size: 7pt; color: #666;">R0 編碼:</div>
                  <div style="font-size: 9pt; font-weight: bold; font-family: monospace;">${label.r0Code}</div>
                </div>
                <div style="margin-top: 2mm;">
                  <div style="font-size: 7pt; color: #666;">EPC:</div>
                  <div style="font-size: 7pt; font-family: monospace; word-break: break-all;">${epc}</div>
                </div>
                <div style="margin-top: 2mm; font-size: 6pt; color: #999;">${date} | 補印</div>
              </div>
            </div>
          </body>
          </html>
        `;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(printHtml);
        printWindow.document.close();
      };

      /**
       * 為指定的 R0 項目自動產生並綁定 EPC
       */
      const autoGenerateEpcForItem = (item) => {
        if (!item) return null;
        // 從 item 取得客戶和產品資訊
        const customer = customers.value.find(c => c.name === item.customerName);
        const product = products.value.find(p => p.name === item.productModel || p.code === item.productModel);
        const customerCode = customer?.code || item.customerName?.slice(0, 4) || 'XXXX';
        const productCode = product?.code || item.productModel?.slice(0, 4) || 'XXXX';
        return generateEpc(customerCode, productCode);
      };

      /**
       * 自動為所有待綁定的 R0 產生 EPC
       */
      const autoGenerateAllEpc = () => {
        const pendingItems = r0GenerateQueue.value.filter(i => !i.epc);
        if (pendingItems.length === 0) {
          alert('沒有待綁定的 R0 項目');
          return;
        }

        let count = 0;
        pendingItems.forEach(item => {
          const epc = autoGenerateEpcForItem(item);
          if (epc) {
            bindEpcToR0(item, epc);
            count++;
          }
        });

        alert(`已自動產生並綁定 ${count} 個 EPC`);
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      /**
       * 將 EPC 綁定到 R0 項目
       */
      const bindEpcToR0 = (item, epc) => {
        item.epc = epc;
        item.status = 'printed';

        // Save to r0Labels
        const newLabel = {
          id: 'r0-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8),
          r0Code: item.r0Code,
          currentEpc: epc,
          workOrderId: item.workOrderId,
          orderNumber: item.orderNumber,
          customerName: item.customerName,
          productModel: item.productModel,
          areaCode: formR0Generate.value.areaCode,
          regenerationStatus: 'R0',
          regenerationCount: 0,
          status: 'active',
          createdAt: new Date().toISOString(),
          history: [{
            type: 'create',
            action: '標籤產生',
            detail: `EPC: ${epc}`,
            timestamp: new Date().toISOString()
          }]
        };
        r0Labels.value.unshift(newLabel);
        saveR0LabelsToStorage();
      };

      const simulateEpcCallback = async () => {
        const { r0Code, epc } = formR0Simulate.value;
        if (!r0Code) {
          alert('請選擇 R0 編碼');
          return;
        }

        const item = r0GenerateQueue.value.find(i => i.r0Code === r0Code);
        if (!item) {
          alert('找不到對應的 R0 編碼');
          return;
        }

        // 如果沒有輸入 EPC，自動產生
        const finalEpc = epc || autoGenerateEpcForItem(item);
        if (!finalEpc) {
          alert('無法產生 EPC');
          return;
        }

        bindEpcToR0(item, finalEpc);
        formR0Simulate.value = { r0Code: '', epc: '' };
        alert(`R0 標籤 ${r0Code} 已成功綁定 EPC:\n${finalEpc}`);
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const clearR0Queue = () => {
        if (confirm('確定要清除待列印佇列嗎？')) {
          r0GenerateQueue.value = [];
        }
      };

      const queryR0Label = () => {
        const input = r0QueryInput.value.trim();
        if (!input) return;

        // Search by R0 code or EPC
        const found = r0Labels.value.find(l =>
          l.r0Code === input ||
          l.currentEpc === input ||
          (l.r0Code && l.r0Code.includes(input)) ||
          (l.currentEpc && l.currentEpc.includes(input))
        );

        r0QueryResult.value = found || null;
        if (!found) {
          alert('查無此標籤紀錄');
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const lookupOldR0 = () => {
        const barcode = formR0Replace.value.oldBarcode.trim();
        if (!barcode) return;

        const found = r0Labels.value.find(l =>
          l.r0Code === barcode ||
          l.currentEpc === barcode ||
          (l.r0Code && l.r0Code.includes(barcode))
        );

        if (found) {
          formR0Replace.value.oldLabelInfo = found;
        } else {
          alert('查無此標籤紀錄');
          formR0Replace.value.oldLabelInfo = null;
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const printReplacementLabel = () => {
        if (!formR0Replace.value.oldLabelInfo || !formR0Replace.value.reason || !formR0Replace.value.operatorName) return;
        formR0Replace.value.pendingNewLabel = true;
        alert('請列印新標籤，然後輸入新 EPC 完成更換');
      };

      const confirmReplacement = async () => {
        const oldLabel = formR0Replace.value.oldLabelInfo;
        const newEpc = formR0Replace.value.newEpc.trim();
        if (!oldLabel || !newEpc) return;

        // Update label with new EPC
        const labelIndex = r0Labels.value.findIndex(l => l.id === oldLabel.id);
        if (labelIndex >= 0) {
          const oldEpc = r0Labels.value[labelIndex].currentEpc;
          r0Labels.value[labelIndex].currentEpc = newEpc;
          r0Labels.value[labelIndex].history.push({
            type: 'replace',
            action: 'RFID 更換',
            detail: `原因: ${formR0Replace.value.reason}, 舊 EPC: ${oldEpc}, 新 EPC: ${newEpc}, 操作員: ${formR0Replace.value.operatorName}`,
            timestamp: new Date().toISOString()
          });
          saveR0LabelsToStorage();
        }

        alert(`RFID 更換完成！\nR0: ${oldLabel.r0Code}\n新 EPC: ${newEpc}`);
        clearReplaceForm();
      };

      const clearReplaceForm = () => {
        formR0Replace.value = {
          oldBarcode: '',
          oldLabelInfo: null,
          reason: '',
          operatorName: '',
          pendingNewLabel: false,
          newEpc: ''
        };
      };

      const lookupForUpgrade = () => {
        const barcode = formR0Upgrade.value.barcode.trim();
        if (!barcode) return;

        const found = r0Labels.value.find(l =>
          l.r0Code === barcode ||
          l.currentEpc === barcode ||
          (l.r0Code && l.r0Code.includes(barcode))
        );

        if (found) {
          formR0Upgrade.value.labelInfo = found;
        } else {
          alert('查無此標籤紀錄');
          formR0Upgrade.value.labelInfo = null;
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const performStatusUpgrade = async () => {
        const labelInfo = formR0Upgrade.value.labelInfo;
        if (!labelInfo || !canUpgradeR0.value || !formR0Upgrade.value.operatorName) return;

        const labelIndex = r0Labels.value.findIndex(l => l.id === labelInfo.id);
        if (labelIndex >= 0) {
          const currentCount = parseInt(r0Labels.value[labelIndex].regenerationCount) || 0;
          const newCount = currentCount + 1;
          const newStatus = `R${newCount}`;

          r0Labels.value[labelIndex].regenerationCount = newCount;
          r0Labels.value[labelIndex].regenerationStatus = newStatus;
          r0Labels.value[labelIndex].history.push({
            type: 'upgrade',
            action: '狀態升級',
            detail: `${labelInfo.regenerationStatus || 'R0'} → ${newStatus}, 操作員: ${formR0Upgrade.value.operatorName}${formR0Upgrade.value.notes ? ', 備註: ' + formR0Upgrade.value.notes : ''}`,
            timestamp: new Date().toISOString()
          });
          saveR0LabelsToStorage();
        }

        alert(`狀態升級完成！\nR0: ${labelInfo.r0Code}\n新狀態: R${(parseInt(labelInfo.regenerationCount) || 0) + 1}`);
        clearUpgradeForm();
      };

      const clearUpgradeForm = () => {
        formR0Upgrade.value = {
          barcode: '',
          labelInfo: null,
          operatorName: '',
          notes: ''
        };
      };

      const getR0StatusClass = (status) => {
        const s = status || 'R0';
        if (s === 'R0') return 'badge-info';
        if (s === 'R1' || s === 'R2') return 'badge-success';
        if (s === 'R3' || s === 'R4') return 'badge-warning';
        if (s === 'R5') return 'badge-error';
        return 'badge-ghost';
      };

      const viewR0Detail = (label) => {
        r0QueryResult.value = label;
        r0SubTab.value = 'query';
        r0QueryInput.value = label.r0Code;
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const savePrinterSettings = () => {
        localStorage.setItem('printerConfig', JSON.stringify(printerConfig.value));
        showPrinterSettingsModal.value = false;
        alert('印表機設定已儲存');
      };

      const loadPrinterConfig = () => {
        const saved = localStorage.getItem('printerConfig');
        if (saved) {
          try {
            printerConfig.value = { ...printerConfig.value, ...JSON.parse(saved) };
          } catch (e) {}
        }
      };

      const saveR0LabelsToStorage = async () => {
        // 同時儲存到 localStorage (快速) 和後端 (持久)
        localStorage.setItem('r0Labels', JSON.stringify(r0Labels.value));
        // 背景同步到後端（不阻塞）
        try {
          await callApi('syncR0Labels', { labels: r0Labels.value }, false);
        } catch (e) {
          console.warn('R0Labels 後端同步失敗:', e);
        }
      };

      const loadR0LabelsFromStorage = () => {
        // 優先從 localStorage 載入（快速顯示）
        // 後端資料會在 refreshData 時載入並覆蓋
        const saved = localStorage.getItem('r0Labels');
        if (saved) {
          try {
            r0Labels.value = JSON.parse(saved);
          } catch (e) {}
        }
      };

      // Oven Monitoring Functions (10 ovens)
      const formatOvenTime = (seconds) => {
        if (!seconds) return '00:00';
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      };

      const addOvenLog = (type, ovenName, message) => {
        const now = new Date();
        const time = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
        ovenEventLogs.value.unshift({ type, ovenName, message, time });
        if (ovenEventLogs.value.length > 100) ovenEventLogs.value.pop();
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const clearOvenLogs = () => { ovenEventLogs.value = []; };

      const getOvenDispatch = (ovenId) => {
        const dispatchId = ovenBindings.value[ovenId];
        if (!dispatchId) return null;
        return dispatches.value.find(d => d.id === dispatchId);
      };

      const connectAllOvens = async () => {
        if (!ovenConfig.value.ecuEndpoint) {
          addOvenLog('warning', '系統', '請先設定 ECU API 端點');
          showOvenSettingsModal.value = true;
          return;
        }
        addOvenLog('info', '系統', '正在連線至 ECU-1051...');
        try {
          await new Promise(r => setTimeout(r, 1000));
          ecuConnected.value = true;
          addOvenLog('success', '系統', 'ECU-1051 連線成功');
          startOvenPolling();
        } catch (e) {
          ecuConnected.value = false;
          addOvenLog('error', '系統', 'ECU 連線失敗: ' + e);
        }
      };

      const startOvenPolling = () => {
        if (ovenTimer) clearInterval(ovenTimer);
        ovenTimer = setInterval(() => {
          ovens.value.forEach(oven => {
            if (oven.running) {
              oven.runningTime++;
              // Simulate temperature increase
              if (oven.temperature < 150) oven.temperature += 2;
            }
          });
        }, 1000);
      };

      const simulateDoor = async (ovenId, isOpen) => {
        const oven = ovens.value.find(o => o.id === ovenId);
        if (!oven) return;

        const prevState = oven.doorOpen;
        oven.doorOpen = isOpen;

        if (isOpen) {
          addOvenLog('warning', oven.name, '門已開啟');
          oven.running = false;
        } else {
          addOvenLog('success', oven.name, '門已關閉，開始運行');
          oven.running = true;
          oven.runningTime = 0;
          oven.temperature = 25;

          // Auto report if enabled
          if (prevState && ovenAutoReportEnabled.value && ovenBindings.value[ovenId]) {
            await triggerOvenAutoReport(ovenId);
          }
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const triggerOvenAutoReport = async (ovenId) => {
        const oven = ovens.value.find(o => o.id === ovenId);
        const dispatchId = ovenBindings.value[ovenId];
        const dispatch = dispatches.value.find(d => d.id === dispatchId);
        if (!dispatch) {
          addOvenLog('error', oven.name, '找不到綁定的派工單');
          return;
        }
        try {
          addOvenLog('info', oven.name, `自動報工 ${ovenBatchQty.value} 片...`);
          const result = await callApi('createReport', {
            dispatchId: dispatch.id,
            goodQty: ovenBatchQty.value,
            ngQty: 0,
            hasAbnormal: false,
            abnormalType: '',
            notes: `${oven.name} 自動報工`
          });
          addOvenLog('success', oven.name, `報工成功: ${result.reportNumber}`);
          await refreshData();
        } catch (e) {
          addOvenLog('error', oven.name, '報工失敗: ' + e);
        }
      };

      const saveOvenSettings = () => {
        addOvenLog('success', '系統', '設定已儲存');
        showOvenSettingsModal.value = false;
      };

      // 烘箱狀態判斷函數（連動派工單狀態）
      const getOvenStateLabel = (oven) => {
        // 找出綁定此烘箱的派工單
        const dispatchId = ovenBindings.value[oven.id];
        if (!dispatchId) return '未綁定';
        const doorState = dispatchDoorStates.value[dispatchId];
        if (!doorState) return '待機';
        return doorState.state === 'closed' ? '運行中' : '門開啟';
      };

      const getOvenStatusClass = (oven) => {
        const dispatchId = ovenBindings.value[oven.id];
        if (!dispatchId) return 'status-offline';
        const doorState = dispatchDoorStates.value[dispatchId];
        if (!doorState) return 'status-offline';
        return doorState.state === 'closed' ? 'status-running' : 'status-open';
      };

      const getOvenStatusIcon = (oven) => {
        const dispatchId = ovenBindings.value[oven.id];
        if (!dispatchId) return 'circle-off';
        const doorState = dispatchDoorStates.value[dispatchId];
        if (!doorState) return 'circle-off';
        return doorState.state === 'closed' ? 'door-closed' : 'door-open';
      };

      const getOvenStatusText = (oven) => {
        const dispatchId = ovenBindings.value[oven.id];
        if (!dispatchId) return '未綁定';
        const doorState = dispatchDoorStates.value[dispatchId];
        if (!doorState) return '離線';
        return doorState.state === 'closed' ? '關門（運行）' : '開門';
      };

      // 派工單開/關門狀態函數
      const getDispatchDoorState = (dispatchId) => {
        const state = dispatchDoorStates.value[dispatchId];
        return state ? state.state : null;
      };

      const getDispatchDoorTime = (dispatchId) => {
        const state = dispatchDoorStates.value[dispatchId];
        if (!state || !state.time) return '';
        return new Date(state.time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const recordOvenDoor = async (dispatch, doorState) => {
        const now = new Date().toISOString();
        // 找出綁定的烘箱
        const ovenId = Object.keys(ovenBindings.value).find(
          key => ovenBindings.value[key] === dispatch.id
        );

        // 更新本地狀態
        dispatchDoorStates.value[dispatch.id] = {
          state: doorState,
          time: now,
          ovenId: ovenId ? parseInt(ovenId) : null
        };

        // 記錄到事件日誌
        const oven = ovenId ? ovens.value.find(o => o.id === parseInt(ovenId)) : null;
        const ovenName = oven ? oven.name : '未綁定烘箱';
        const actionText = doorState === 'open' ? '開門' : '關門';
        addOvenLog(doorState === 'open' ? 'warning' : 'success', ovenName, `${dispatch.dispatchNumber} ${actionText}`);

        // 更新烘箱的 doorOpen 狀態（連動卡片顯示）
        if (oven) {
          oven.doorOpen = doorState === 'open';
          oven.running = doorState === 'closed';
        }

        // TODO: 未來可以將時間戳存入資料庫
        // await callApi('recordOvenDoorEvent', { dispatchId: dispatch.id, state: doorState, time: now });

        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      // Oven Barcode Scanning
      const selectOvenForScan = (ovenId) => {
        selectedOvenId.value = ovenId;
        ovenScanInput.value = '';
      };

      const scanOvenBarcode = () => {
        if (!selectedOvenId.value || !ovenScanInput.value.trim()) return;
        const oven = ovens.value.find(o => o.id === selectedOvenId.value);
        if (!oven) return;

        const code = ovenScanInput.value.trim();
        // 檢查是否已掃描過
        if (oven.scannedCodes.includes(code)) {
          addOvenLog('warning', oven.name, `條碼 ${code} 已掃描過`);
        } else {
          oven.scannedCodes.push(code);
          addOvenLog('info', oven.name, `掃描條碼: ${code} (${oven.scannedCodes.length}/${oven.batchQty})`);
        }
        ovenScanInput.value = '';
      };

      const clearOvenScannedCodes = (ovenId) => {
        const oven = ovens.value.find(o => o.id === ovenId);
        if (oven) {
          oven.scannedCodes = [];
          addOvenLog('info', oven.name, '已清除所有已掃描條碼');
        }
      };

      const removeOvenScannedCode = (ovenId, code) => {
        const oven = ovens.value.find(o => o.id === ovenId);
        if (oven) {
          const idx = oven.scannedCodes.indexOf(code);
          if (idx > -1) {
            oven.scannedCodes.splice(idx, 1);
          }
        }
      };

      // Label Editor Functions
      const dragStart = (e, type) => {
        dragType = type;
        e.dataTransfer.effectAllowed = 'copy';
      };

      const dragStartField = (e, field) => {
        dragType = 'text';
        dragData = field.key;
        e.dataTransfer.effectAllowed = 'copy';
      };

      const dropElement = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const scale = canvasScale.value;
        const x = Math.round((e.clientX - rect.left) / scale);
        const y = Math.round((e.clientY - rect.top) / scale);

        let newElement = { x, y };

        switch (dragType) {
          case 'text':
            newElement = { ...newElement, type: 'text', text: dragData || '文字', fontSize: 12, bold: false };
            break;
          case 'barcode':
            newElement = { ...newElement, type: 'barcode', value: '${epc}', format: 'CODE128', height: 30 };
            break;
          case 'qrcode':
            newElement = { ...newElement, type: 'qrcode', value: '${epc}', size: 40 };
            break;
          case 'image':
            newElement = { ...newElement, type: 'image', width: 30, height: 30, src: '' };
            break;
          case 'line':
            newElement = { ...newElement, type: 'line', width: 40, thickness: 1 };
            break;
          case 'rect':
            newElement = { ...newElement, type: 'rect', width: 30, height: 20, thickness: 1 };
            break;
        }

        labelElements.value.push(newElement);
        selectedElementIdx.value = labelElements.value.length - 1;
        dragType = null;
        dragData = null;
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const selectElement = (idx) => {
        selectedElementIdx.value = idx;
      };

      const deselectAll = () => {
        selectedElementIdx.value = null;
      };

      const deleteElement = () => {
        if (selectedElementIdx.value !== null) {
          labelElements.value.splice(selectedElementIdx.value, 1);
          selectedElementIdx.value = null;
        }
      };

      const getElementStyle = (el) => {
        const scale = canvasScale.value;
        return {
          left: el.x * scale + 'px',
          top: el.y * scale + 'px'
        };
      };

      const startDrag = (e, idx) => {
        if (e.target.classList.contains('resize-handle')) return;
        isDragging = true;
        selectedElementIdx.value = idx;
        const el = labelElements.value[idx];
        const canvas = document.querySelector('.label-canvas');
        if (!canvas) return;
        const rect = canvas.getBoundingClientRect();
        const scale = canvasScale.value;

        // 記錄點擊位置相對於元素左上角的偏移 (用於保持拖曳時的相對位置)
        dragOffset.x = e.clientX - rect.left - el.x * scale;
        dragOffset.y = e.clientY - rect.top - el.y * scale;

        const onMove = (me) => {
          if (!isDragging) return;
          const canvas = document.querySelector('.label-canvas');
          if (!canvas) return;
          const rect = canvas.getBoundingClientRect();
          const s = canvasScale.value;
          // 新位置 = (滑鼠相對 canvas 位置 - 偏移量) / 縮放比例
          el.x = Math.max(0, Math.round((me.clientX - rect.left - dragOffset.x) / s));
          el.y = Math.max(0, Math.round((me.clientY - rect.top - dragOffset.y) / s));
        };

        const onUp = () => {
          isDragging = false;
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      };

      const startResize = (e, idx) => {
        const el = labelElements.value[idx];
        const startX = e.clientX;
        const startY = e.clientY;
        const startW = el.width || el.size || 40;
        const startH = el.height || el.size || 40;

        const onMove = (me) => {
          const dx = me.clientX - startX;
          const dy = me.clientY - startY;
          const scale = canvasScale.value;
          if (el.type === 'qrcode') {
            el.size = Math.max(20, Math.round(startW + dx / scale));
          } else {
            el.width = Math.max(10, Math.round(startW + dx / scale));
            if (el.height !== undefined) {
              el.height = Math.max(10, Math.round(startH + dy / scale));
            }
          }
        };

        const onUp = () => {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', onUp);
        };

        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', onUp);
      };

      const resolveFieldValue = (text, data = null) => {
        if (!text) return '';
        const d = data || previewData.value;
        return text
          .replace(/\$\{r0Code\}/g, d.r0Code || 'R0XXX@YCD26A000001')
          .replace(/\$\{epc\}/g, d.epc || 'E2XXXX000026000000000001')
          .replace(/\$\{orderNumber\}/g, d.orderNumber || 'WO-XXXXXX')
          .replace(/\$\{productModel\}/g, d.productModel || 'MODEL')
          .replace(/\$\{customerName\}/g, d.customerName || 'CUSTOMER')
          .replace(/\$\{customerCode\}/g, d.customerCode || 'XXX')
          .replace(/\$\{regenerationStatus\}/g, d.regenerationStatus || 'R0')
          .replace(/\$\{regenerationCount\}/g, d.regenerationCount ?? '0')
          .replace(/\$\{date\}/g, d.date || new Date().toLocaleDateString('zh-TW'))
          .replace(/\$\{operator\}/g, d.operator || 'OP');
      };

      const loadTemplate = () => {
        if (!currentTemplateId.value) {
          labelElements.value = [];
          labelSize.value = { width: 50, height: 30 };
          return;
        }
        const tpl = labelTemplates.value.find(t => t.id === currentTemplateId.value);
        if (tpl) {
          labelSize.value = { width: tpl.width, height: tpl.height };
          labelElements.value = JSON.parse(JSON.stringify(tpl.elements));
        }
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const saveTemplate = async () => {
        if (!templateSaveName.value.trim()) {
          alert('請輸入樣板名稱');
          return;
        }
        const template = {
          id: currentTemplateId.value || 'tpl-' + Date.now(),
          name: templateSaveName.value.trim(),
          width: labelSize.value.width,
          height: labelSize.value.height,
          elements: JSON.parse(JSON.stringify(labelElements.value))
        };

        // Save to localStorage for now (can be extended to database)
        const existing = labelTemplates.value.findIndex(t => t.id === template.id);
        if (existing >= 0) {
          labelTemplates.value[existing] = template;
        } else {
          labelTemplates.value.push(template);
        }
        localStorage.setItem('labelTemplates', JSON.stringify(labelTemplates.value));

        currentTemplateId.value = template.id;
        showTemplateSaveModal.value = false;
        alert('樣板已儲存');
      };

      const previewLabel = () => {
        showLabelPreviewModal.value = true;
        nextTick(() => { if (window.lucide) lucide.createIcons(); });
      };

      const loadPreviewData = () => {
        const wo = workOrders.value.find(w => w.id === previewWorkOrderId.value);
        if (wo) {
          // 取得客戶代碼
          const customer = customers.value.find(c => c.name === wo.customerName);
          const customerCode = customer?.code || wo.customerName.slice(0, 3).toUpperCase();

          // 取得產品代碼
          const product = products.value.find(p => p.name === wo.productModel || p.code === wo.productModel);
          const productCode = product?.code || wo.productModel.slice(0, 4).toUpperCase();

          // 產生 R0 編碼預覽
          const year = new Date().getFullYear().toString().slice(-2);
          const r0Code = `R0${customerCode}@YCD${year}A000001`;

          // 產生 EPC 預覽
          const epcCustomer = customerCode.toUpperCase().padEnd(4, '0').slice(0, 4);
          const epcProduct = productCode.toUpperCase().padEnd(4, '0').slice(0, 4);
          const epc = `E2${epcCustomer}${epcProduct}${year}000000000001`;

          previewData.value = {
            r0Code: r0Code,
            epc: epc,
            orderNumber: wo.orderNumber,
            productModel: wo.productModel,
            customerName: wo.customerName,
            customerCode: customerCode,
            date: new Date().toLocaleDateString('zh-TW'),
            operator: operators.value[0]?.name || 'OP'
          };
        }
      };

      const generateSBPL = () => {
        // Generate SATO SBPL commands
        let sbpl = [];
        sbpl.push('<STX>'); // Start
        sbpl.push('A'); // ASCII mode
        sbpl.push('H0' + String(labelSize.value.height * 8).padStart(4, '0')); // Label height
        sbpl.push('V0' + String(labelSize.value.width * 8).padStart(4, '0')); // Label width

        labelElements.value.forEach(el => {
          const x = String(el.x * 8).padStart(4, '0');
          const y = String(el.y * 8).padStart(4, '0');

          switch (el.type) {
            case 'text':
              sbpl.push(`H${x}`);
              sbpl.push(`V${y}`);
              sbpl.push(`P02`); // Font
              sbpl.push(resolveFieldValue(el.text, previewData.value));
              break;
            case 'barcode':
              sbpl.push(`H${x}`);
              sbpl.push(`V${y}`);
              sbpl.push(`B1${el.format === 'CODE128' ? '3' : '1'}0${String(el.height).padStart(3, '0')}`);
              sbpl.push(resolveFieldValue(el.value, previewData.value));
              break;
            case 'qrcode':
              sbpl.push(`H${x}`);
              sbpl.push(`V${y}`);
              sbpl.push(`BQ2${String(el.size / 10).padStart(2, '0')}`);
              sbpl.push(resolveFieldValue(el.value, previewData.value));
              break;
          }
        });

        sbpl.push('Q1'); // Print 1 label
        sbpl.push('Z'); // End
        sbpl.push('<ETX>');

        const sbplText = sbpl.join('\r\n');

        // Download as file
        const blob = new Blob([sbplText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'label.sbpl';
        a.click();
        URL.revokeObjectURL(url);
      };

      // Load saved templates on mount
      const loadSavedTemplates = () => {
        const saved = localStorage.getItem('labelTemplates');
        if (saved) {
          try {
            labelTemplates.value = JSON.parse(saved);
          } catch (e) {}
        }

        // Add default templates if not exist (based on SATO PDF: 6.5cm x 3.5cm anti-metal RFID)
        // 條碼用 R0 編碼 (人可讀掃描)，QR Code 用 EPC (機器讀取備用)
        const defaultTemplates = [
          {
            id: 'default-r0',
            name: 'R0 標籤 (新品)',
            width: 65, // 6.5cm
            height: 35, // 3.5cm
            elements: [
              { type: 'text', x: 3, y: 3, text: '${customerName}', fontSize: 10, bold: true },
              { type: 'text', x: 3, y: 12, text: '${productModel}', fontSize: 8, bold: false },
              { type: 'text', x: 50, y: 3, text: 'R0', fontSize: 14, bold: true },
              { type: 'barcode', x: 3, y: 18, value: '${r0Code}', format: 'CODE128', height: 8 },
              { type: 'qrcode', x: 50, y: 12, value: '${epc}', size: 20 },
              { type: 'text', x: 3, y: 30, text: '${date}', fontSize: 6, bold: false }
            ]
          },
          {
            id: 'default-rn',
            name: 'RN 標籤 (再生)',
            width: 65,
            height: 35,
            elements: [
              { type: 'text', x: 3, y: 3, text: '${customerName}', fontSize: 10, bold: true },
              { type: 'text', x: 3, y: 12, text: '${productModel}', fontSize: 8, bold: false },
              { type: 'rect', x: 48, y: 2, width: 15, height: 12, thickness: 2 },
              { type: 'text', x: 50, y: 3, text: '${regenerationStatus}', fontSize: 14, bold: true },
              { type: 'barcode', x: 3, y: 18, value: '${r0Code}', format: 'CODE128', height: 8 },
              { type: 'qrcode', x: 50, y: 14, value: '${epc}', size: 18 },
              { type: 'text', x: 3, y: 30, text: '再生: ${regenerationCount}/5', fontSize: 6, bold: false },
              { type: 'text', x: 35, y: 30, text: '${date}', fontSize: 6, bold: false }
            ]
          }
        ];

        // Add defaults if not already present
        defaultTemplates.forEach(tpl => {
          if (!labelTemplates.value.find(t => t.id === tpl.id)) {
            labelTemplates.value.push(tpl);
          }
        });
      };

      // ========== WMS 倉儲管理 ==========
      const formatTime = (isoString) => {
        if (!isoString) return '-';
        const d = new Date(isoString);
        return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
      };

      const formatDate = (isoString) => {
        if (!isoString) return '-';
        const d = new Date(isoString);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
      };

      const loadWmsData = async () => {
        try {
          const [locations, summary, movements, inventory] = await Promise.all([
            callApi('getWmsLocations', null, false),
            callApi('getWmsLocationSummary', null, false),
            callApi('getWmsMovements', null, false),
            callApi('getWmsInventory', null, false)
          ]);
          wmsLocations.value = locations || [];
          wmsLocationSummary.value = summary || [];
          wmsMovements.value = movements || [];
          wmsInventory.value = inventory || [];
        } catch (e) { console.error('WMS 載入失敗:', e); }
      };

      const initWmsLocations = async () => {
        try {
          await callApi('initWmsLocations', {});
          await loadWmsData();
          alert('倉區初始化完成');
        } catch (e) { alert('初始化失敗: ' + e); }
      };

      const wmsLocationTypeLabel = (type) => {
        const labels = { inbound: '入庫', storage: '暫存', staging: '前置', outbound: '出庫', qc: '品檢', special: '特殊' };
        return labels[type] || type;
      };

      const wmsMovementTypeLabel = (type) => {
        const labels = { inbound: '入庫', outbound: '出庫', transfer: '調撥', adjustment: '盤點調整' };
        return labels[type] || type;
      };

      const wmsMovementTypeBadge = (type) => {
        const badges = { inbound: 'success', outbound: 'error', transfer: 'warning', adjustment: 'info' };
        return badges[type] || 'ghost';
      };

      const openWmsModal = (type) => {
        formWms.value = { locationCode: '', workOrderId: '', quantity: 1, barcode: '', barcodes: [], operatorName: '', fromLocation: '', toLocation: '', inventoryId: '', reason: '' };
        wmsInventoryList.value = [];
        if (type === 'inbound') showWmsInboundModal.value = true;
        else if (type === 'transfer') showWmsTransferModal.value = true;
        else if (type === 'outbound') showWmsOutboundModal.value = true;
        else if (type === 'stocktake') {
          formStockTake.value = { locationCode: '', operatorName: '', notes: '' };
          stockTakeItems.value = [];
          showWmsStockTakeModal.value = true;
        }
      };

      const openLocationDetail = async (loc) => {
        selectedLocation.value = loc;
        wmsInventoryList.value = wmsInventory.value.filter(inv => inv.locationCode === loc.code);
        // 如果沒有載入過庫存，先載入
        if (wmsInventory.value.length === 0) {
          try {
            wmsInventory.value = await callApi('getWmsInventory', null, false);
            wmsInventoryList.value = wmsInventory.value.filter(inv => inv.locationCode === loc.code);
          } catch (e) { console.error(e); }
        }
        showLocationDetailModal.value = true;
      };

      const loadLocationInventory = async () => {
        const locCode = formWms.value.fromLocation;
        if (!locCode) { wmsInventoryList.value = []; return; }
        try {
          if (wmsInventory.value.length === 0) {
            wmsInventory.value = await callApi('getWmsInventory', null, false);
          }
          wmsInventoryList.value = wmsInventory.value.filter(inv => inv.locationCode === locCode);
        } catch (e) { console.error(e); }
      };

      const wmsAddBarcode = () => {
        if (formWms.value.barcode && !formWms.value.barcodes.includes(formWms.value.barcode)) {
          formWms.value.barcodes.push(formWms.value.barcode);
          formWms.value.barcode = '';
        }
      };

      const submitWmsInbound = async () => {
        try {
          await callApi('wmsInbound', {
            locationCode: formWms.value.locationCode,
            workOrderId: formWms.value.workOrderId || null,
            quantity: formWms.value.quantity,
            barcode: formWms.value.barcodes.length > 0 ? formWms.value.barcodes.join(',') : formWms.value.barcode,
            operatorName: formWms.value.operatorName
          });
          showWmsInboundModal.value = false;
          await loadWmsData();
          alert('入庫成功');
        } catch (e) { alert('入庫失敗: ' + e); }
      };

      const submitWmsTransfer = async () => {
        try {
          await callApi('wmsTransfer', {
            inventoryId: formWms.value.inventoryId,
            toLocation: formWms.value.toLocation,
            operatorName: formWms.value.operatorName,
            reason: formWms.value.reason
          });
          showWmsTransferModal.value = false;
          await loadWmsData();
          wmsInventory.value = await callApi('getWmsInventory', null, false);
          alert('調撥成功');
        } catch (e) { alert('調撥失敗: ' + e); }
      };

      const submitWmsOutbound = async () => {
        try {
          await callApi('wmsOutbound', {
            inventoryId: formWms.value.inventoryId,
            operatorName: formWms.value.operatorName,
            reason: formWms.value.reason
          });
          showWmsOutboundModal.value = false;
          await loadWmsData();
          wmsInventory.value = await callApi('getWmsInventory', null, false);
          alert('出庫成功');
        } catch (e) { alert('出庫失敗: ' + e); }
      };

      // 盤點功能
      const loadStockTakeInventory = async () => {
        const locCode = formStockTake.value.locationCode;
        if (!locCode) {
          stockTakeItems.value = [];
          return;
        }
        try {
          // 確保有最新庫存資料
          if (wmsInventory.value.length === 0) {
            wmsInventory.value = await callApi('getWmsInventory', null, false);
          }
          // 篩選該倉區庫存並加入實際數量欄位
          stockTakeItems.value = wmsInventory.value
            .filter(inv => inv.locationCode === locCode)
            .map(inv => ({
              id: inv.id,
              barcode: inv.barcode || '',
              orderNumber: inv.orderNumber || '',
              productModel: inv.productModel || '',
              systemQty: Number(inv.quantity) || 0,
              actualQty: null
            }));
        } catch (e) {
          console.error('載入盤點庫存失敗:', e);
          stockTakeItems.value = [];
        }
      };

      const submitWmsStockTake = async () => {
        // 過濾有輸入實際數量的項目
        const filledItems = stockTakeItems.value.filter(item => item.actualQty !== null && item.actualQty !== '');
        if (filledItems.length === 0) {
          alert('請至少輸入一項實際數量');
          return;
        }
        try {
          const location = wmsLocations.value.find(l => l.code === formStockTake.value.locationCode);
          const result = await callApi('createWmsStockTake', {
            locationCode: formStockTake.value.locationCode,
            locationName: location?.name || '',
            operatorName: formStockTake.value.operatorName,
            notes: formStockTake.value.notes,
            details: filledItems.map(item => ({
              inventoryId: item.id,
              actualQty: item.actualQty
            }))
          });
          showWmsStockTakeModal.value = false;
          await loadWmsData();
          const adjustedCount = result.adjustedItems || 0;
          if (adjustedCount > 0) {
            alert(`盤點完成，共調整 ${adjustedCount} 筆庫存`);
          } else {
            alert('盤點完成，庫存數量無差異');
          }
        } catch (e) {
          alert('盤點失敗: ' + e);
        }
      };

      // Watch for tab change to refresh icons
      watch(currentTab, (newTab) => {
        if (newTab === 'oven') {
          nextTick(() => { if (window.lucide) lucide.createIcons(); });
        }
        if (newTab === 'wms') {
          loadWmsData();
          nextTick(() => { if (window.lucide) lucide.createIcons(); });
        }
      });

      onMounted(() => {
        // 效能優化：先載入本地快取（瞬間顯示），再背景更新
        const hasCached = loadCachedData();
        if (hasCached) {
          // 有快取：先顯示舊資料，背景靜默更新（不顯示 loading）
          refreshData(false);
        } else {
          // 無快取：顯示 loading 並載入
          refreshData(true);
        }
        loadSavedTemplates();
        loadPrinterConfig();
        loadR0LabelsFromStorage();
        // Initialize Lucide icons
        if (window.lucide) lucide.createIcons();

        // 更新倒數計時
        const updateCountdown = () => {
          const targetDate = new Date('2025-08-01T00:00:00');
          const now = new Date();
          const diffTime = targetDate - now;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          const el = document.getElementById('countdown-text');
          if (!el) return;
          if (diffDays > 0) {
            el.innerHTML = `針對「七個月技術真空期」之補償方案 (距離廠商承諾交付剩餘 <strong>${diffDays}</strong> 天)`;
          } else if (diffDays === 0) {
            el.innerHTML = `今日為廠商承諾之「七個月」交付期限，目前進入最終驗收校對期`;
          } else {
            el.innerHTML = `廠商已逾期 <strong>${Math.abs(diffDays)}</strong> 天 — 營運補償方案無限期延長中`;
          }
        };
        updateCountdown();
      });

      return {
        loading, version, currentTab, workOrders, dispatches, reports,
        showCreateWoModal, showDispatchModal, showReportModal, showShareModal,
        shareLoading, shareData, shareCopied, openShareModal, copyShareUrl,
        selectedWo, selectedDispatch, selectedEpcWo,
        formWo, formDispatch, formReport, formEpc, formOperator, formCustomer, formProduct,
        currentNgReason, currentNgQty, currentNgBarcodes, currentNgBarcodeInput,
        scanNgBarcode, removeNgBarcode, addNgDetail, removeNgDetail, resetNgDetailForm,
        editingOperatorId, editingCustomerId, editingProductId, editingNgReasonId, editingWorkOrderId,
        regenerationOrders, completedDeglueOrders, reworkableOrders, aoiPassedOrders, epcHistory, operators, customers, products, customerSites, availableStations, epcCheckStatus, epcCheckInfo,
        refreshData, openCreateWoModal, submitWorkOrder, openDispatchModal, submitDispatch, openReportModal, submitReport,
        startEditWorkOrder, cancelEditWorkOrder, deleteWorkOrder, deleteDispatch,
        submitEpcChange, onWoSelect, onCustomerSelect, onSourceWorkOrderSelect, checkOldEpc,
        submitOperator, deleteOperator, startEditOperator, cancelEditOperator,
        submitCustomer, deleteCustomer, startEditCustomer, cancelEditCustomer,
        submitProduct, deleteProduct, startEditProduct, cancelEditProduct,
        ngReasons, formNgReason, editingNgReasonId,
        submitNgReason, deleteNgReason, startEditNgReason, cancelEditNgReason,
        startJob, completeJob, getStatusClass,
        signaturePadOutgassing, signaturePadAoi, startSign, drawSign, endSign, clearSignature,
        outgassingTests, outgassingSampleInfo, formOutgassing, filteredOutgassingTests,
        loadOutgassingSampleInfo, submitOutgassingTest, generateOutgassingReport, generateSingleOutgassingReport,
        aoiInspections, aoiCsvPreview, formAoi, formAoiSingle,
        handleAoiCsvFile, submitAoiImport, submitSingleAoi,
        showInspectionDetailModal, selectedInspection, inspectionType, viewInspectionDetail,
        adminLoading, adminMessage, adminMessageType, systemVersion,
        adminGenerateTestData, adminSyncDatabase, adminFixColumnOrder, adminFixSignatureData,
        // Oven Monitoring (10 ovens)
        ovens, ecuConnected, ovenConfig, ovenBindings, ovenBatchQty, ovenAutoReportEnabled,
        ovenEventLogs, showOvenSettingsModal, dispatchDoorStates,
        formatOvenTime, connectAllOvens, clearOvenLogs, getOvenDispatch,
        simulateDoor, saveOvenSettings,
        getOvenStateLabel, getOvenStatusClass, getOvenStatusIcon, getOvenStatusText,
        getDispatchDoorState, getDispatchDoorTime, recordOvenDoor,
        selectedOvenId, ovenScanInput, selectOvenForScan, scanOvenBarcode,
        clearOvenScannedCodes, removeOvenScannedCode,
        // R0 Management
        r0SubTab, r0Labels, r0TableFilter, r0QueryInput, r0QueryResult, r0GenerateQueue,
        printerConnected, showPrinterSettingsModal, printerConfig, epcConfig,
        formR0Generate, formR0Simulate, formR0Replace, formR0Upgrade,
        filteredR0Labels, r0CodePreview, epcPreview, epcSerialCounter, canUpgradeR0,
        onR0WorkOrderSelect, generateR0Labels, startR0Printing, printLabelPreview, simulateEpcCallback, clearR0Queue,
        generateEpc, parseEpc, autoGenerateAllEpc, autoGenerateEpcForItem,
        queryR0Label, lookupOldR0, printReplacementLabel, confirmReplacement, clearReplaceForm,
        lookupForUpgrade, performStatusUpgrade, clearUpgradeForm,
        getR0StatusClass, viewR0Detail, reprintLabel, savePrinterSettings,
        // Label Editor
        labelTemplates, currentTemplateId, labelSize, labelElements, selectedElementIdx,
        showTemplateSaveModal, showLabelPreviewModal, templateSaveName, dataFields,
        previewWorkOrderId, previewData, canvasScale,
        dragStart, dragStartField, dropElement, selectElement, deselectAll, deleteElement,
        getElementStyle, startDrag, startResize, resolveFieldValue,
        loadTemplate, saveTemplate, previewLabel, loadPreviewData, generateSBPL,
        // WMS 倉儲管理
        wmsLocations, wmsInventory, wmsMovements, wmsLocationSummary, wmsInventoryList,
        showWmsInboundModal, showWmsTransferModal, showWmsOutboundModal, showLocationDetailModal,
        selectedLocation, formWms, formatTime, formatDate,
        loadWmsData, initWmsLocations, wmsLocationTypeLabel, wmsMovementTypeLabel, wmsMovementTypeBadge,
        openWmsModal, openLocationDetail, loadLocationInventory, wmsAddBarcode,
        submitWmsInbound, submitWmsTransfer, submitWmsOutbound,
        // 盤點
        showWmsStockTakeModal, stockTakeItems, formStockTake,
        loadStockTakeInventory, submitWmsStockTake
      };
    }
  });

  app.mount('#app');
</script>
