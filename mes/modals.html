<!-- Modal: Share -->
<dialog id="modal-share" class="modal" :class="{ 'modal-open': showShareModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">分享此應用程式</h3>
    <div v-if="shareLoading" style="text-align: center; padding: 2rem;">
      <span class="loading loading-spinner loading-lg"></span>
      <div style="margin-top: 1rem; color: #64748b;">產生短網址中...</div>
    </div>

    <div v-else-if="shareData" style="text-align: center;">
      <!-- QR Code -->
      <div style="margin-bottom: 1.5rem;">
        <img :src="shareData.qrCodeUrl" alt="QR Code" style="width: 200px; height: 200px; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
      </div>

      <!-- Share URL -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">分享網址</label>
        <div class="join w-full">
          <input type="text" class="input input-bordered join-item flex-1 font-mono text-xs" :value="shareData.shortUrl" readonly>
          <button class="btn btn-primary join-item" @click="copyShareUrl">
            <i data-lucide="clipboard" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Copy Success Message -->
      <div v-if="shareCopied" class="alert alert-success mt-4">
        <i data-lucide="check-circle" class="w-5 h-5"></i>
        <span>已複製到剪貼簿！</span>
      </div>

      <!-- Hint -->
      <p style="font-size: 0.75rem; color: #94a3b8; margin-top: 1rem;">
        掃描 QR Code 或複製短網址即可分享給同事
      </p>
    </div>

    <div class="modal-action">
      <button class="btn" @click="showShareModal = false">關閉</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showShareModal = false"><button>close</button></form>
</dialog>

<!-- Modal: Create/Edit Work Order -->
<dialog id="modal-wo" class="modal" :class="{ 'modal-open': showCreateWoModal }">
  <div class="modal-box max-w-2xl">
    <h3 class="font-bold text-lg mb-4">{{ editingWorkOrderId ? '編輯工單' : '建立新工單' }}</h3>
    <form @submit.prevent="submitWorkOrder">
      <!-- 1. Customer -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">客戶名稱</label>
        <div class="operator-grid" style="max-height: 160px; overflow-y: auto; padding: 0.5rem; background: #f8fafc; border-radius: 0.5rem;">
          <div v-for="c in customers" :key="c.id"
               :class="['operator-chip', formWo.customerName === c.name ? 'selected' : '']"
               @click="formWo.customerName = c.name; onCustomerSelect()">
            {{ c.name }}
          </div>
        </div>
      </div>

      <!-- 2. Site -->
      <div v-if="formWo.customerName && customerSites.length > 0" style="margin-bottom: 1rem;">
        <label class="input-label">廠區</label>
        <div class="chip-group">
          <div v-for="site in customerSites" :key="site"
               :class="['chip', formWo.customerSite === site ? 'selected' : '']"
               @click="formWo.customerSite = site">{{ site }}</div>
        </div>
      </div>

      <!-- 3. Product -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">產品型號</label>
        <div class="wo-card-list" style="max-height: 160px; padding: 0.5rem; background: #f8fafc; border-radius: 0.5rem;">
          <div v-for="p in products" :key="p.id"
               :class="['wo-card', formWo.productModel === p.code ? 'selected' : '']"
               @click="formWo.productModel = p.code">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="wo-number">{{ p.code }}</div>
                <div class="wo-info">{{ p.name }}</div>
              </div>
              <span class="badge badge-ghost">{{ p.type }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 4. Order Type (編輯模式可切換，新建模式顯示固定標籤) -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">工單類型</label>
        <!-- 新建模式：顯示固定標籤 -->
        <div v-if="!editingWorkOrderId">
          <span :class="['badge', 'badge-lg', formWo.orderType === 'deglue' ? 'badge-primary' : formWo.orderType === 'regeneration' ? 'badge-warning' : 'badge-error']">
            {{ { deglue: '除膠工單', regeneration: '再生工單', rework: '重工工單' }[formWo.orderType] }}
          </span>
        </div>
        <!-- 編輯模式：可切換類型 -->
        <div v-else class="chip-group">
          <div :class="['chip', formWo.orderType === 'deglue' ? 'selected' : '']"
               @click="formWo.orderType = 'deglue'; formWo.sourceWorkOrderId = ''">除膠</div>
          <div :class="['chip', formWo.orderType === 'regeneration' ? 'selected' : '']"
               @click="formWo.orderType = 'regeneration'">再生</div>
          <div :class="['chip', formWo.orderType === 'rework' ? 'selected' : '']"
               @click="formWo.orderType = 'rework'; formWo.sourceWorkOrderId = ''">重工</div>
        </div>
      </div>

      <!-- 4.5 Source Work Order (Regeneration only) -->
      <div v-if="formWo.orderType === 'regeneration'" class="form-section" style="margin-bottom: 1rem; background: linear-gradient(135deg, rgba(251,146,60,0.1) 0%, rgba(251,146,60,0.05) 100%);">
        <label class="input-label" style="color: #ea580c;">選擇來源除膠工單</label>
        <div v-if="completedDeglueOrders.length === 0" style="color: #ea580c; font-size: 0.875rem;">
          目前沒有已完成的除膠工單可供選擇
        </div>
        <div v-else class="wo-card-list" style="max-height: 160px;">
          <div v-for="swo in completedDeglueOrders" :key="swo.id"
               :class="['wo-card', formWo.sourceWorkOrderId === swo.id ? 'selected' : '']"
               @click="formWo.sourceWorkOrderId = swo.id; onSourceWorkOrderSelect()"
               style="border-color: #fed7aa;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="wo-number">{{ swo.orderNumber }}</div>
                <div class="wo-info">{{ swo.customerName }} / {{ swo.productModel }}</div>
              </div>
              <span style="color: #16a34a; font-size: 0.75rem; font-weight: 700;">良品: {{ swo.goodQty }}</span>
            </div>
          </div>
        </div>
        <div v-if="formWo.sourceWorkOrderId" style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">
          已選擇來源工單，客戶/產品資訊已自動帶入
        </div>
      </div>

      <!-- 4.6 Source Work Order (Rework only) -->
      <div v-if="formWo.orderType === 'rework'" class="form-section" style="margin-bottom: 1rem; background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%);">
        <label class="input-label" style="color: #dc2626;">選擇來源工單（釋氣 NG 需重烤）</label>
        <div v-if="reworkableOrders.length === 0" style="color: #dc2626; font-size: 0.875rem;">
          目前沒有可重工的工單（已完成且未重工過）
        </div>
        <div v-else class="wo-card-list" style="max-height: 160px;">
          <div v-for="swo in reworkableOrders" :key="swo.id"
               :class="['wo-card', formWo.sourceWorkOrderId === swo.id ? 'selected' : '']"
               @click="formWo.sourceWorkOrderId = swo.id; onSourceWorkOrderSelect()"
               style="border-color: #fecaca;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="wo-number">{{ swo.orderNumber }}</div>
                <div class="wo-info">{{ swo.customerName }} / {{ swo.productModel }}</div>
              </div>
              <div style="text-align: right;">
                <span :class="['badge', swo.orderType === 'regeneration' ? 'badge-warning' : 'badge-primary']" style="font-size: 0.7rem;">
                  {{ { deglue: '除膠', regeneration: '再生' }[swo.orderType] || swo.orderType }}
                </span>
                <div style="color: #16a34a; font-size: 0.75rem; font-weight: 700;">良品: {{ swo.goodQty }}</div>
              </div>
            </div>
          </div>
        </div>
        <div style="font-size: 0.75rem; color: #dc2626; margin-top: 0.5rem; background: #fef2f2; padding: 0.5rem; border-radius: 0.25rem;">
          重工上限 1 次，重工後仍 NG 須報廢
        </div>
      </div>

      <!-- 5. Regeneration Count -->
      <div v-if="formWo.orderType === 'regeneration'" style="margin-bottom: 1rem;">
        <label class="input-label">目標再生次數</label>
        <div class="r-count-grid">
          <div v-for="n in 10" :key="n"
               :class="['r-chip', formWo.targetRegenerationCount === n ? 'selected' : '']"
               @click="formWo.targetRegenerationCount = n">R{{ n }}</div>
        </div>
      </div>

      <!-- 6. Quantity & Priority -->
      <div class="form-row" style="margin-bottom: 1rem;">
        <div>
          <label class="input-label">數量</label>
          <input type="number" class="input input-bordered w-full" v-model.number="formWo.quantity" required>
        </div>
        <div>
          <label class="input-label">優先級</label>
          <div style="display: flex; gap: 0.5rem;">
            <div :class="['chip', formWo.priority === 'normal' ? 'selected' : '']"
                 @click="formWo.priority = 'normal'" style="flex: 1; text-align: center;">一般</div>
            <div :class="['chip', 'chip-ng', formWo.priority === 'urgent' ? 'selected' : '']"
                 @click="formWo.priority = 'urgent'" style="flex: 1; text-align: center;">緊急</div>
          </div>
        </div>
      </div>
    </form>

    <div class="modal-action">
      <button class="btn" @click="cancelEditWorkOrder">取消</button>
      <button class="btn btn-primary" @click="submitWorkOrder">
        {{ editingWorkOrderId ? '更新工單' : '建立工單' }}
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="cancelEditWorkOrder"><button>close</button></form>
</dialog>

<!-- Modal: Dispatch -->
<dialog id="modal-dispatch" class="modal" :class="{ 'modal-open': showDispatchModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">新增派工</h3>
    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0;">針對工單: <strong>{{ selectedWo?.orderNumber }}</strong></p>

    <form @submit.prevent="submitDispatch">
      <!-- Station -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">工作站點</label>
        <div class="chip-group">
          <div v-for="st in availableStations" :key="st"
               :class="['chip', formDispatch.stationName === st ? 'selected' : '']"
               @click="formDispatch.stationName = st">{{ st }}</div>
        </div>
        <div v-if="selectedWo?.orderType === 'rework'" style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.5rem;">
          重工僅限烘箱站（回爐重烤）
        </div>
        <div v-else-if="selectedWo?.orderType" style="color: #94a3b8; font-size: 0.75rem; margin-top: 0.5rem;">
          {{ { deglue: '除膠流程', regeneration: '再生流程' }[selectedWo.orderType] }}
        </div>
      </div>

      <!-- Operator (只顯示現場作業員) -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">作業員</label>
        <div v-if="shopFloorOperators.length > 0 && shopFloorOperators.length <= 12" class="operator-grid">
          <div v-for="op in shopFloorOperators" :key="op.id"
               :class="['operator-chip', formDispatch.operatorName === op.name ? 'selected' : '']"
               @click="formDispatch.operatorName = op.name">
            {{ op.name }}
          </div>
        </div>
        <select v-else class="select select-bordered w-full" v-model="formDispatch.operatorName" required>
          <option value="">-- 請選擇 --</option>
          <option v-for="op in shopFloorOperators" :key="op.id" :value="op.name">{{ op.name }}</option>
        </select>
      </div>

      <!-- Quantity -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">派工數量</label>
        <input type="number" class="input input-bordered w-full" v-model.number="formDispatch.quantity" required>
      </div>
    </form>

    <div class="modal-action">
      <button class="btn" @click="showDispatchModal = false">取消</button>
      <button class="btn btn-primary" @click="submitDispatch">確認派工</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showDispatchModal = false"><button>close</button></form>
</dialog>

<!-- Modal: Report -->
<dialog id="modal-report" class="modal" :class="{ 'modal-open': showReportModal }">
  <div class="modal-box" style="max-width: 600px;">
    <h3 class="font-bold text-lg mb-4">生產回報</h3>
    <p style="color: #64748b; font-size: 0.875rem; margin-top: 0;">派工單: <strong>{{ selectedDispatch?.dispatchNumber }}</strong></p>

    <form @submit.prevent="submitReport">
      <!-- 良品數量 -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label" style="color: #16a34a;">良品數量</label>
        <input type="number" class="input input-bordered w-full border-success" v-model.number="formReport.goodQty" min="0">
      </div>

      <!-- NG 明細區 -->
      <div class="ng-details-section" style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(239,68,68,0.08) 0%, rgba(239,68,68,0.02) 100%); border-radius: 0.5rem; border: 1px solid #fecaca;">
        <label class="input-label" style="color: #dc2626; margin-bottom: 0.75rem; display: block;">
          NG 明細
          <span style="font-weight: normal; color: #64748b; margin-left: 0.5rem;">總計: {{ formReport.ngQty }} 件</span>
        </label>

        <!-- 已登記的 NG 列表 -->
        <div v-if="formReport.ngDetails.length > 0" style="margin-bottom: 1rem;">
          <div v-for="(detail, idx) in formReport.ngDetails" :key="idx" class="ng-detail-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 0.375rem; margin-bottom: 0.5rem;">
            <span class="badge badge-error">{{ detail.reasonName }}</span>
            <span style="font-weight: 600;">x{{ detail.quantity }}</span>
            <span v-if="detail.barcodes.length" style="font-size: 0.75rem; color: #64748b; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              {{ detail.barcodes.join(', ') }}
            </span>
            <button type="button" class="btn btn-xs btn-ghost btn-circle" @click="removeNgDetail(idx)">
              <i data-lucide="x" class="w-3 h-3"></i>
            </button>
          </div>
        </div>

        <!-- 新增 NG -->
        <div style="background: white; padding: 0.75rem; border-radius: 0.375rem;">
          <div style="margin-bottom: 0.75rem;">
            <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">選擇 NG 原因</label>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              <label v-for="reason in ngReasons" :key="reason.id" class="ng-reason-option" :class="{ selected: currentNgReason === reason.id }">
                <input type="radio" :value="reason.id" v-model="currentNgReason" style="display: none;">
                <span>{{ reason.name }}</span>
              </label>
              <span v-if="ngReasons.length === 0" style="font-size: 0.75rem; color: #94a3b8;">請先在設定頁新增 NG 原因</span>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 80px 1fr; gap: 0.5rem; margin-bottom: 0.75rem;">
            <div>
              <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">數量</label>
              <input type="number" class="input input-bordered input-sm w-full" v-model.number="currentNgQty" min="1">
            </div>
            <div>
              <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">條碼掃描 (選填)</label>
              <div style="display: flex; gap: 0.25rem;">
                <input type="text" class="input input-bordered input-sm flex-1" v-model="currentNgBarcodeInput" @keyup.enter="scanNgBarcode" placeholder="掃描或輸入條碼...">
                <button type="button" class="btn btn-sm btn-ghost" @click="scanNgBarcode">
                  <i data-lucide="plus" class="w-4 h-4"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 已掃描的條碼 -->
          <div v-if="currentNgBarcodes.length > 0" style="margin-bottom: 0.75rem;">
            <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
              <span v-for="code in currentNgBarcodes" :key="code" class="badge badge-ghost" style="gap: 0.25rem;">
                {{ code }}
                <button type="button" @click="removeNgBarcode(code)" style="cursor: pointer; opacity: 0.6;">&times;</button>
              </span>
            </div>
          </div>

          <button type="button" class="btn btn-sm btn-error btn-outline w-full" @click="addNgDetail" :disabled="!currentNgReason">
            <i data-lucide="plus" class="w-4 h-4"></i>
            新增 NG 記錄
          </button>
        </div>
      </div>

      <!-- 異常 -->
      <div style="margin-bottom: 1rem;">
        <label class="label cursor-pointer justify-start gap-2">
          <input type="checkbox" class="checkbox" v-model="formReport.hasAbnormal">
          <span class="label-text">發生異常</span>
        </label>
      </div>

      <div v-if="formReport.hasAbnormal" style="margin-bottom: 1rem;">
        <label class="input-label">異常原因</label>
        <input type="text" class="input input-bordered w-full" v-model="formReport.abnormalType">
      </div>
    </form>

    <div class="modal-action">
      <button class="btn" @click="showReportModal = false">取消</button>
      <button class="btn btn-success" @click="submitReport">提交報工</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showReportModal = false"><button>close</button></form>
</dialog>

<!-- Modal: Inspection Detail -->
<dialog id="modal-inspection" class="modal" :class="{ 'modal-open': showInspectionDetailModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">{{ inspectionType === 'outgassing' ? '釋氣檢驗詳情' : 'AOI 檢驗詳情' }}</h3>
    <div v-if="selectedInspection" style="display: flex; flex-direction: column; gap: 1rem;">
      <!-- Header Info -->
      <div class="info-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <div class="info-item" style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem;">
          <label style="font-size: 0.75rem; color: #64748b; display: block;">檢驗單號</label>
          <span style="font-weight: 600; font-family: monospace;">{{ selectedInspection.testNumber || selectedInspection.inspectionNumber }}</span>
        </div>
        <div class="info-item" style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem;">
          <label style="font-size: 0.75rem; color: #64748b; display: block;">工單編號</label>
          <span style="font-weight: 600;">{{ selectedInspection.orderNumber }}</span>
        </div>
        <div class="info-item" style="padding: 0.75rem; background: #f8fafc; border-radius: 0.5rem;">
          <label style="font-size: 0.75rem; color: #64748b; display: block;">條碼/序號</label>
          <span style="font-family: monospace;">{{ selectedInspection.rfidCode || '-' }}</span>
        </div>
        <div class="info-item" style="padding: 0.75rem; border-radius: 0.5rem;" :style="{ background: selectedInspection.result === 'PASS' ? '#dcfce7' : '#fee2e2' }">
          <label style="font-size: 0.75rem; color: #64748b; display: block;">檢驗結果</label>
          <span :style="{ fontWeight: 700, color: selectedInspection.result === 'PASS' ? '#16a34a' : '#dc2626' }">{{ selectedInspection.result }}</span>
        </div>
      </div>

      <!-- AOI Specific: Defect Info -->
      <div v-if="inspectionType === 'aoi' && selectedInspection.defectType" style="padding: 0.75rem; background: #fff7ed; border-radius: 0.5rem; border: 1px solid #fed7aa;">
        <label style="font-size: 0.75rem; color: #9a3412; display: block;">缺陷類型</label>
        <span style="font-weight: 600; color: #c2410c;">{{ selectedInspection.defectType }}</span>
        <span v-if="selectedInspection.defectCount" style="margin-left: 0.5rem; color: #9a3412;">({{ selectedInspection.defectCount }} 處)</span>
      </div>

      <!-- Notes -->
      <div v-if="selectedInspection.notes" style="padding: 0.75rem; background: #f1f5f9; border-radius: 0.5rem;">
        <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.25rem;">備註</label>
        <span>{{ selectedInspection.notes }}</span>
      </div>

      <!-- Operator & Time -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <div>
          <label style="font-size: 0.75rem; color: #64748b; display: block;">檢驗員</label>
          <span style="font-weight: 500;">{{ selectedInspection.operatorName }}</span>
        </div>
        <div>
          <label style="font-size: 0.75rem; color: #64748b; display: block;">檢驗時間</label>
          <span style="font-size: 0.875rem;">{{ (selectedInspection.testedAt || selectedInspection.inspectedAt) ? new Date(selectedInspection.testedAt || selectedInspection.inspectedAt).toLocaleString('zh-TW') : '-' }}</span>
        </div>
      </div>

      <!-- Signature -->
      <div v-if="selectedInspection.signature" style="margin-top: 0.5rem; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;">
        <label style="font-size: 0.75rem; color: #64748b; display: block; margin-bottom: 0.5rem;">品檢簽名</label>
        <div style="text-align: center;">
          <img :src="selectedInspection.signature" alt="簽名" style="max-height: 100px; border-bottom: 1px solid #cbd5e1;">
        </div>
      </div>

      <!-- No Signature Notice -->
      <div v-else-if="inspectionType === 'outgassing'" style="padding: 0.75rem; background: #fef3c7; border-radius: 0.5rem; text-align: center; color: #92400e; font-size: 0.875rem;">
        此筆檢驗紀錄無簽名資料
      </div>
    </div>

    <div class="modal-action">
      <button v-if="inspectionType === 'outgassing'" class="btn btn-primary" @click="generateSingleOutgassingReport(selectedInspection)">
        <i data-lucide="file-text" class="w-4 h-4"></i>
        下載報告
      </button>
      <button class="btn" @click="showInspectionDetailModal = false">關閉</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showInspectionDetailModal = false"><button>close</button></form>
</dialog>
