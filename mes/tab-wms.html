<!-- Tab: WMS 倉儲管理 -->
<div v-show="currentTab === 'wms'">
  <div class="section-header">
    <h2>{{ isAdminMode ? '倉儲管理' : '倉儲操作' }}</h2>
    <div class="wms-actions">
      <button class="btn btn-primary" @click="openWmsModal('inbound')">
        <i data-lucide="package-plus" class="w-4 h-4"></i>
        入庫
      </button>
      <!-- 盤點：僅管理端顯示 -->
      <button v-if="isAdminMode" class="btn btn-info" @click="openWmsModal('stocktake')">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i>
        盤點
      </button>
    </div>
  </div>

  <!-- WMS 戰情總覽 Dashboard -->
  <div class="wms-dashboard" v-if="!wmsLoading && wmsLocationSummary.length > 0">
    <!-- 第一行: W1 庫存概況 + W2 今日動態 -->
    <div class="wms-dashboard-row">
      <!-- W1: 庫存概況 -->
      <div class="wms-widget wms-widget-wide">
        <div class="wms-widget-header">
          <span class="wms-widget-title">W1 庫存概況</span>
          <span class="wms-widget-badge">即時</span>
        </div>
        <div class="wms-widget-body">
          <div class="wms-stats-grid">
            <div class="wms-stat-card wms-stat-primary">
              <div class="wms-stat-icon">
                <i data-lucide="layers" class="w-6 h-6"></i>
              </div>
              <div class="wms-stat-info">
                <div class="wms-stat-value">{{ wmsStats.totalItems }}</div>
                <div class="wms-stat-label">總筆數</div>
              </div>
            </div>
            <div class="wms-stat-card wms-stat-success">
              <div class="wms-stat-icon">
                <i data-lucide="package" class="w-6 h-6"></i>
              </div>
              <div class="wms-stat-info">
                <div class="wms-stat-value">{{ wmsStats.totalQty }}</div>
                <div class="wms-stat-label">總件數</div>
              </div>
            </div>
            <div class="wms-stat-card wms-stat-warning">
              <div class="wms-stat-icon">
                <i data-lucide="warehouse" class="w-6 h-6"></i>
              </div>
              <div class="wms-stat-info">
                <div class="wms-stat-value">{{ wmsStats.usedLocations }}/{{ wmsStats.totalLocations }}</div>
                <div class="wms-stat-label">使用倉區</div>
              </div>
            </div>
            <div class="wms-stat-card wms-stat-info">
              <div class="wms-stat-icon">
                <i data-lucide="percent" class="w-6 h-6"></i>
              </div>
              <div class="wms-stat-info">
                <div class="wms-stat-value">{{ wmsStats.utilization }}%</div>
                <div class="wms-stat-label">使用率</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- W2: 今日動態 -->
      <div class="wms-widget">
        <div class="wms-widget-header">
          <span class="wms-widget-title">W2 今日動態</span>
          <span class="wms-widget-badge">{{ formatDate(new Date()) }}</span>
        </div>
        <div class="wms-widget-body">
          <div class="wms-today-stats">
            <div class="wms-today-item wms-today-inbound">
              <i data-lucide="arrow-down-circle" class="w-5 h-5"></i>
              <div class="wms-today-info">
                <span class="wms-today-value">{{ wmsStats.todayInbound }}</span>
                <span class="wms-today-label">入庫</span>
              </div>
            </div>
            <div class="wms-today-item wms-today-outbound">
              <i data-lucide="arrow-up-circle" class="w-5 h-5"></i>
              <div class="wms-today-info">
                <span class="wms-today-value">{{ wmsStats.todayOutbound }}</span>
                <span class="wms-today-label">出庫</span>
              </div>
            </div>
            <div class="wms-today-item wms-today-transfer">
              <i data-lucide="arrow-left-right" class="w-5 h-5"></i>
              <div class="wms-today-info">
                <span class="wms-today-value">{{ wmsStats.todayTransfer }}</span>
                <span class="wms-today-label">調撥</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 第二行: W3 庫存預警 + W4 周轉分析 + W5 入出庫進度 -->
    <div class="wms-dashboard-row">
      <!-- W3: 庫存預警 -->
      <div class="wms-widget">
        <div class="wms-widget-header">
          <span class="wms-widget-title">W3 庫存預警</span>
          <span class="wms-widget-badge" :class="wmsStats.alertCount > 0 ? 'wms-badge-warning' : 'wms-badge-success'">
            {{ wmsStats.alertCount > 0 ? wmsStats.alertCount + ' 項' : '正常' }}
          </span>
        </div>
        <div class="wms-widget-body">
          <div v-if="wmsAlerts.length === 0" class="wms-alert-empty">
            <i data-lucide="check-circle" class="w-8 h-8"></i>
            <span>庫存狀態正常</span>
          </div>
          <div v-else class="wms-alert-list">
            <div v-for="alert in wmsAlerts.slice(0, 3)" :key="alert.id"
                 class="wms-alert-item" :class="'wms-alert-' + alert.type">
              <i :data-lucide="alert.icon" class="w-4 h-4"></i>
              <div class="wms-alert-content">
                <div class="wms-alert-title">{{ alert.title }}</div>
                <div class="wms-alert-desc">{{ alert.description }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- W4: 周轉分析 -->
      <div class="wms-widget">
        <div class="wms-widget-header">
          <span class="wms-widget-title">W4 周轉分析</span>
          <span class="wms-widget-badge">本月</span>
        </div>
        <div class="wms-widget-body">
          <div class="wms-turnover-stats">
            <div class="wms-turnover-main">
              <div class="wms-turnover-value">{{ wmsStats.turnoverRate }}</div>
              <div class="wms-turnover-label">周轉率 (次/月)</div>
            </div>
            <div class="wms-turnover-details">
              <div class="wms-turnover-item">
                <span class="wms-turnover-item-label">平均庫存天數</span>
                <span class="wms-turnover-item-value">{{ wmsStats.avgStockDays }} 天</span>
              </div>
              <div class="wms-turnover-item">
                <span class="wms-turnover-item-label">滯留品項</span>
                <span class="wms-turnover-item-value" :class="wmsStats.slowMoving > 0 ? 'text-warning' : ''">
                  {{ wmsStats.slowMoving }} 項
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- W5: 入出庫進度 -->
      <div class="wms-widget">
        <div class="wms-widget-header">
          <span class="wms-widget-title">W5 本週進度</span>
          <span class="wms-widget-badge">7 天</span>
        </div>
        <div class="wms-widget-body">
          <div class="wms-progress-chart">
            <div class="wms-progress-bar-container">
              <div class="wms-progress-bar wms-progress-inbound" :style="{ width: wmsStats.weekInboundPercent + '%' }">
                <span>入 {{ wmsStats.weekInbound }}</span>
              </div>
            </div>
            <div class="wms-progress-bar-container">
              <div class="wms-progress-bar wms-progress-outbound" :style="{ width: wmsStats.weekOutboundPercent + '%' }">
                <span>出 {{ wmsStats.weekOutbound }}</span>
              </div>
            </div>
          </div>
          <div class="wms-progress-summary">
            <span>淨增減: </span>
            <span :class="wmsStats.weekNet >= 0 ? 'text-success' : 'text-error'">
              {{ wmsStats.weekNet >= 0 ? '+' : '' }}{{ wmsStats.weekNet }} 件
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 倉區總覽 -->
  <div class="wms-location-grid">
    <div v-for="loc in wmsLocationSummary" :key="loc.id"
         class="wms-location-card"
         :class="'wms-type-' + loc.locationType"
         @click="openLocationDetail(loc)">
      <div class="wms-loc-header">
        <span class="wms-loc-code">{{ loc.code }}</span>
        <span class="wms-loc-type">{{ wmsLocationTypeLabel(loc.locationType) }}</span>
      </div>
      <div class="wms-loc-name">{{ loc.name }}</div>
      <div class="wms-loc-stats">
        <div class="wms-stat">
          <span class="wms-stat-value">{{ loc.itemCount }}</span>
          <span class="wms-stat-label">筆</span>
        </div>
        <div class="wms-stat">
          <span class="wms-stat-value">{{ loc.totalQty }}</span>
          <span class="wms-stat-label">件</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading 狀態 -->
  <div v-if="wmsLoading" class="empty-state" style="padding: 3rem;">
    <span class="loading loading-spinner loading-lg text-primary"></span>
    <div style="margin-top: 1rem; color: #64748b;">載入倉儲資料中...</div>
  </div>

  <!-- 空狀態 -->
  <div v-else-if="wmsLocationSummary.length === 0" class="empty-state" style="padding: 3rem;">
    <i data-lucide="warehouse" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
    <div>尚未設定倉區</div>
    <button class="btn btn-primary mt-4" @click="initWmsLocations">
      初始化柳工再生廠倉區
    </button>
  </div>

  <!-- 最近異動 -->
  <div v-if="wmsMovements.length > 0" class="wms-movements-section">
    <h3 style="font-size: 1rem; margin: 1.5rem 0 1rem;">最近異動</h3>
    <div class="scrollable" style="max-height: 300px;">
      <table class="data-table">
        <thead>
          <tr>
            <th>時間</th>
            <th>類型</th>
            <th>來源</th>
            <th>目的</th>
            <th>工單/條碼</th>
            <th>數量</th>
            <th>操作人</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="mv in wmsMovements.slice(0, 20)" :key="mv.id">
            <td style="font-size: 0.75rem; color: #64748b;">{{ formatTime(mv.createdAt) }}</td>
            <td>
              <span :class="'badge badge-' + wmsMovementTypeBadge(mv.movementType)">
                {{ wmsMovementTypeLabel(mv.movementType) }}
              </span>
            </td>
            <td><code>{{ mv.fromLocation }}</code></td>
            <td><code>{{ mv.toLocation }}</code></td>
            <td>
              <div v-if="mv.orderNumber" style="font-size: 0.75rem;">{{ mv.orderNumber }}</div>
              <div v-if="mv.barcode" style="font-size: 0.7rem; color: #64748b;">{{ mv.barcode }}</div>
            </td>
            <td style="font-weight: 600;">{{ mv.quantity }}</td>
            <td>{{ mv.operatorName }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- WMS 入庫 Modal -->
<dialog class="modal" :class="{ 'modal-open': showWmsInboundModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">入庫作業</h3>
    <form @submit.prevent="submitWmsInbound">
      <!-- 步驟 1: 選擇倉區 -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">目的倉區 *</label>
        <div class="chip-group">
          <div v-for="loc in wmsLocations" :key="loc.code"
               :class="['chip', formWms.locationCode === loc.code ? 'selected' : '']"
               @click="formWms.locationCode = loc.code">
            {{ loc.code }}
          </div>
        </div>
        <div v-if="formWms.locationCode" style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
          {{ wmsLocations.find(l => l.code === formWms.locationCode)?.name }}
        </div>
      </div>

      <!-- 步驟 2: 選擇工單 (選擇倉區後顯示) -->
      <div v-if="formWms.locationCode" style="margin-bottom: 1rem;">
        <label class="input-label">關聯工單</label>
        <div class="chip-group">
          <div :class="['chip', !formWms.workOrderId ? 'selected' : '']"
               @click="formWms.workOrderId = ''; formWms.partId = ''">散料</div>
          <div v-for="wo in workOrders.slice(0, 8)" :key="wo.id"
               :class="['chip', formWms.workOrderId === wo.id ? 'selected' : '']"
               @click="formWms.workOrderId = wo.id; formWms.partId = ''">
            {{ wo.orderNumber }}
          </div>
        </div>
      </div>

      <!-- 步驟 2.5: 散料選擇物料 -->
      <div v-if="formWms.locationCode && !formWms.workOrderId" style="margin-bottom: 1rem;">
        <label class="input-label">選擇物料 *</label>
        <div v-if="parts.length === 0" class="alert alert-warning" style="padding: 0.75rem;">
          <span>尚無物料資料，請先至「物料主檔」新增</span>
        </div>
        <div v-else class="chip-group" style="max-height: 120px; overflow-y: auto;">
          <div v-for="part in parts" :key="part.id"
               :class="['chip', formWms.partId === part.id ? 'selected' : '']"
               @click="formWms.partId = part.id">
            <span style="font-weight: 600;">{{ part.partNumber }}</span>
            <span style="font-size: 0.75rem; color: #64748b; margin-left: 0.25rem;">{{ part.name }}</span>
          </div>
        </div>
        <div v-if="formWms.partId" style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
          {{ parts.find(p => p.id === formWms.partId)?.spec || '' }}
          <span v-if="parts.find(p => p.id === formWms.partId)?.unit">
            ({{ parts.find(p => p.id === formWms.partId)?.unit }})
          </span>
        </div>
      </div>

      <!-- 步驟 3: 條碼與數量 -->
      <div v-if="formWms.locationCode" style="margin-bottom: 1rem;">
        <label class="input-label">條碼掃描</label>
        <input type="text" class="input input-bordered w-full" v-model="formWms.barcode"
               placeholder="掃描或輸入條碼" @keyup.enter.prevent="wmsAddBarcode">
        <div v-if="formWms.barcodes && formWms.barcodes.length > 0" class="wms-barcode-list">
          <span v-for="(bc, idx) in formWms.barcodes" :key="idx" class="badge badge-ghost">
            {{ bc }} <span @click="formWms.barcodes.splice(idx, 1)" style="cursor:pointer;">&times;</span>
          </span>
        </div>
      </div>

      <div v-if="formWms.locationCode" style="margin-bottom: 1rem;">
        <label class="input-label">數量</label>
        <input type="number" class="input input-bordered w-full" v-model.number="formWms.quantity" min="1">
      </div>

      <!-- 步驟 4: 操作人員 -->
      <div v-if="formWms.locationCode" style="margin-bottom: 1rem;">
        <label class="input-label">操作人員 *</label>
        <div class="chip-group">
          <div v-for="op in operators" :key="op.id"
               :class="['chip', formWms.operatorName === op.name ? 'selected' : '']"
               @click="formWms.operatorName = op.name">
            {{ op.name }}
          </div>
        </div>
      </div>
    </form>
    <div class="modal-action">
      <button class="btn btn-ghost" @click="showWmsInboundModal = false">取消</button>
      <button class="btn btn-primary" @click="submitWmsInbound"
              :disabled="!formWms.locationCode || !formWms.operatorName || (!formWms.workOrderId && !formWms.partId)">
        確認入庫
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showWmsInboundModal = false"><button>close</button></form>
</dialog>

<!-- WMS 調撥 Modal -->
<dialog class="modal" :class="{ 'modal-open': showWmsTransferModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">調撥作業</h3>
    <form @submit.prevent="submitWmsTransfer">
      <!-- 已選擇的物品資訊（情境式開啟時顯示） -->
      <div v-if="formWms.selectedInventory" class="alert alert-info mb-4">
        <div>
          <div style="font-weight: 600;">從 {{ formWms.fromLocation }} 調撥</div>
          <div style="font-size: 0.875rem;">
            {{ formWms.selectedInventory.barcode || formWms.selectedInventory.orderNumber || '未標示' }}
            <span style="color: #64748b;">x {{ formWms.selectedInventory.quantity }} 件</span>
          </div>
        </div>
      </div>

      <!-- 選擇目的倉區 -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">目的倉區 *</label>
        <div class="chip-group">
          <div v-for="loc in wmsLocations.filter(l => l.code !== formWms.fromLocation)" :key="loc.code"
               :class="['chip', formWms.toLocation === loc.code ? 'selected' : '']"
               @click="formWms.toLocation = loc.code">
            {{ loc.code }}
          </div>
        </div>
        <div v-if="formWms.toLocation" style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
          {{ wmsLocations.find(l => l.code === formWms.toLocation)?.name }}
        </div>
      </div>

      <!-- 操作人員 -->
      <div v-if="formWms.toLocation" style="margin-bottom: 1rem;">
        <label class="input-label">操作人員 *</label>
        <div class="chip-group">
          <div v-for="op in operators" :key="op.id"
               :class="['chip', formWms.operatorName === op.name ? 'selected' : '']"
               @click="formWms.operatorName = op.name">
            {{ op.name }}
          </div>
        </div>
      </div>

      <div v-if="formWms.toLocation" style="margin-bottom: 1rem;">
        <label class="input-label">原因備註</label>
        <input type="text" class="input input-bordered w-full" v-model="formWms.reason" placeholder="選填">
      </div>
    </form>
    <div class="modal-action">
      <button class="btn btn-ghost" @click="showWmsTransferModal = false">取消</button>
      <button class="btn btn-warning" @click="submitWmsTransfer"
              :disabled="!formWms.inventoryId || !formWms.toLocation || !formWms.operatorName">
        確認調撥
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showWmsTransferModal = false"><button>close</button></form>
</dialog>

<!-- WMS 出庫 Modal -->
<dialog class="modal" :class="{ 'modal-open': showWmsOutboundModal }">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">出庫作業</h3>
    <form @submit.prevent="submitWmsOutbound">
      <!-- 已選擇的物品資訊（情境式開啟時顯示） -->
      <div v-if="formWms.selectedInventory" class="alert alert-error mb-4" style="background: rgba(239,68,68,0.1);">
        <div>
          <div style="font-weight: 600;">從 {{ formWms.fromLocation }} 出庫</div>
          <div style="font-size: 0.875rem;">
            {{ formWms.selectedInventory.barcode || formWms.selectedInventory.orderNumber || '未標示' }}
            <span style="color: #64748b;">x {{ formWms.selectedInventory.quantity }} 件</span>
          </div>
        </div>
      </div>

      <!-- 操作人員 -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">操作人員 *</label>
        <div class="chip-group">
          <div v-for="op in operators" :key="op.id"
               :class="['chip', formWms.operatorName === op.name ? 'selected' : '']"
               @click="formWms.operatorName = op.name">
            {{ op.name }}
          </div>
        </div>
      </div>

      <div v-if="formWms.operatorName" style="margin-bottom: 1rem;">
        <label class="input-label">出庫原因 *</label>
        <div class="chip-group">
          <div :class="['chip', formWms.reason === '出貨' ? 'selected' : '']" @click="formWms.reason = '出貨'">出貨</div>
          <div :class="['chip', formWms.reason === '報廢' ? 'selected' : '']" @click="formWms.reason = '報廢'">報廢</div>
          <div :class="['chip', formWms.reason === '領料' ? 'selected' : '']" @click="formWms.reason = '領料'">領料</div>
          <div :class="['chip', formWms.reason === '其他' ? 'selected' : '']" @click="formWms.reason = '其他'">其他</div>
        </div>
      </div>

      <div v-if="formWms.reason === '其他'" style="margin-bottom: 1rem;">
        <label class="input-label">備註說明</label>
        <input type="text" class="input input-bordered w-full" v-model="formWms.reasonNote" placeholder="請說明原因">
      </div>
    </form>
    <div class="modal-action">
      <button class="btn btn-ghost" @click="showWmsOutboundModal = false">取消</button>
      <button class="btn btn-error" @click="submitWmsOutbound"
              :disabled="!formWms.inventoryId || !formWms.operatorName || !formWms.reason">
        確認出庫
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showWmsOutboundModal = false"><button>close</button></form>
</dialog>

<!-- 倉區明細 Modal -->
<dialog class="modal" :class="{ 'modal-open': showLocationDetailModal }">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">
      <span class="badge badge-primary mr-2">{{ selectedLocation?.code }}</span>
      {{ selectedLocation?.name }}
    </h3>
    <div v-if="wmsInventoryList.length === 0" class="empty-state" style="padding: 2rem;">
      <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-2 opacity-50"></i>
      <div>此倉區目前無庫存</div>
    </div>
    <div v-else class="scrollable" style="max-height: 400px;">
      <table class="data-table">
        <thead>
          <tr>
            <th>條碼</th>
            <th>工單</th>
            <th>產品</th>
            <th>數量</th>
            <th>入庫日期</th>
            <th style="text-align: center;">操作</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="inv in wmsInventoryList" :key="inv.id">
            <td><code>{{ inv.barcode || '-' }}</code></td>
            <td>{{ inv.orderNumber || '-' }}</td>
            <td>{{ inv.productModel || '-' }}</td>
            <td style="font-weight: 600;">{{ inv.quantity }}</td>
            <td style="font-size: 0.75rem; color: #64748b;">{{ formatDate(inv.inboundDate) }}</td>
            <td style="text-align: center;">
              <div style="display: flex; gap: 0.25rem; justify-content: center;">
                <button class="btn btn-xs btn-warning" @click="openTransferFromInventory(inv)">
                  調撥
                </button>
                <button class="btn btn-xs btn-error btn-outline" @click="openOutboundFromInventory(inv)">
                  出庫
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="modal-action" style="justify-content: space-between;">
      <!-- 快速盤點：僅管理端 -->
      <button v-if="isAdminMode && wmsInventoryList.length > 0" class="btn btn-info btn-outline" @click="openQuickStockTake">
        <i data-lucide="clipboard-check" class="w-4 h-4"></i>
        快速盤點此儲位
      </button>
      <div v-else></div>
      <button class="btn btn-ghost" @click="showLocationDetailModal = false">關閉</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showLocationDetailModal = false"><button>close</button></form>
</dialog>

<!-- WMS 盤點 Modal -->
<dialog class="modal" :class="{ 'modal-open': showWmsStockTakeModal }">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">盤點作業</h3>
    <form @submit.prevent="submitWmsStockTake">
      <!-- 步驟 1: 選擇倉區 -->
      <div style="margin-bottom: 1rem;">
        <label class="input-label">選擇倉區 *</label>
        <div class="chip-group">
          <div v-for="loc in wmsLocations" :key="loc.code"
               :class="['chip', formStockTake.locationCode === loc.code ? 'selected' : '']"
               @click="formStockTake.locationCode = loc.code; loadStockTakeInventory()">
            {{ loc.code }}
          </div>
        </div>
        <div v-if="formStockTake.locationCode" style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">
          {{ wmsLocations.find(l => l.code === formStockTake.locationCode)?.name }}
        </div>
      </div>

      <div v-if="formStockTake.locationCode && stockTakeItems.length === 0" class="alert alert-warning mb-4">
        <span>此倉區目前無庫存可盤點</span>
      </div>

      <!-- 步驟 2: 盤點清單 -->
      <div v-if="stockTakeItems.length > 0" style="margin-bottom: 1rem;">
        <label class="input-label">庫存盤點 ({{ stockTakeItems.length }} 項)</label>
        <div class="scrollable" style="max-height: 300px; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
          <table class="data-table">
            <thead>
              <tr>
                <th>條碼/工單</th>
                <th>產品</th>
                <th style="text-align: center;">系統數量</th>
                <th style="text-align: center; width: 100px;">實際數量</th>
                <th style="text-align: center;">差異</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="(item, idx) in stockTakeItems" :key="item.id"
                  :class="{ 'bg-red-50': item.actualQty !== null && item.actualQty !== item.systemQty }">
                <td>
                  <code v-if="item.barcode">{{ item.barcode }}</code>
                  <span v-else>{{ item.orderNumber || '-' }}</span>
                </td>
                <td>{{ item.productModel || '-' }}</td>
                <td style="text-align: center; font-weight: 600;">{{ item.systemQty }}</td>
                <td style="text-align: center;">
                  <input type="number" class="input input-bordered input-sm w-20"
                         v-model.number="stockTakeItems[idx].actualQty" min="0" placeholder="-">
                </td>
                <td style="text-align: center;">
                  <span v-if="item.actualQty !== null && item.actualQty !== item.systemQty"
                        :class="item.actualQty > item.systemQty ? 'text-green-600' : 'text-red-600'"
                        style="font-weight: 600;">
                    {{ item.actualQty > item.systemQty ? '+' : '' }}{{ item.actualQty - item.systemQty }}
                  </span>
                  <span v-else style="color: #94a3b8;">-</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 步驟 3: 操作人員 -->
      <div v-if="stockTakeItems.length > 0" style="margin-bottom: 1rem;">
        <label class="input-label">操作人員 *</label>
        <div class="chip-group">
          <div v-for="op in operators" :key="op.id"
               :class="['chip', formStockTake.operatorName === op.name ? 'selected' : '']"
               @click="formStockTake.operatorName = op.name">
            {{ op.name }}
          </div>
        </div>
      </div>

      <div v-if="formStockTake.operatorName" style="margin-bottom: 1rem;">
        <label class="input-label">備註</label>
        <input type="text" class="input input-bordered w-full" v-model="formStockTake.notes" placeholder="選填">
      </div>
    </form>
    <div class="modal-action">
      <button class="btn btn-ghost" @click="showWmsStockTakeModal = false">取消</button>
      <button class="btn btn-info" @click="submitWmsStockTake"
              :disabled="!formStockTake.locationCode || !formStockTake.operatorName || stockTakeItems.length === 0">
        確認盤點
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop" @click="showWmsStockTakeModal = false"><button>close</button></form>
</dialog>
