<!-- Tab: Settings -->
<div v-show="currentTab === 'settings'">

  <!-- 1. Operators -->
  <div class="settings-section">
    <div class="settings-form">
      <h3>人員管理</h3>
      <form @submit.prevent="submitOperator">
        <div style="margin-bottom: 0.75rem;">
          <label class="input-label">姓名</label>
          <input type="text" class="input input-bordered w-full" v-model="formOperator.name" required>
        </div>
        <div style="margin-bottom: 1rem;">
          <label class="input-label">編號/代號</label>
          <input type="text" class="input input-bordered w-full" v-model="formOperator.code">
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" :class="['btn', 'flex-1', editingOperatorId ? 'btn-warning' : 'btn-ghost']">
            {{ editingOperatorId ? '更新人員' : '新增人員' }}
          </button>
          <button v-if="editingOperatorId" type="button" class="btn btn-ghost btn-outline" @click="cancelEditOperator">取消</button>
        </div>
      </form>
    </div>
    <div>
      <div class="scrollable" style="max-height: 250px; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
        <table class="data-table">
          <thead>
            <tr><th>姓名</th><th>編號</th><th style="text-align: right;">操作</th></tr>
          </thead>
          <tbody>
            <tr v-for="op in operators" :key="op.id">
              <td>{{ op.name }}</td>
              <td style="color: #64748b;">{{ op.code }}</td>
              <td style="text-align: right;">
                <div class="btn-group">
                  <button class="btn btn-sm btn-ghost" @click="startEditOperator(op)">編輯</button>
                  <button class="btn btn-sm btn-error btn-outline" @click="deleteOperator(op.id)">刪除</button>
                </div>
              </td>
            </tr>
            <tr v-if="operators.length === 0" class="empty-row"><td colspan="3">尚無資料</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 2. Customers -->
  <div class="settings-section">
    <div class="settings-form" style="background: linear-gradient(135deg, rgba(102,126,234,0.1) 0%, rgba(102,126,234,0.05) 100%);">
      <h3 style="color: #4f46e5;">客戶管理</h3>
      <form @submit.prevent="submitCustomer">
        <div style="display: grid; grid-template-columns: 1fr 120px; gap: 0.75rem; margin-bottom: 0.75rem;">
          <div>
            <label class="input-label">客戶名稱</label>
            <input type="text" class="input input-bordered w-full" v-model="formCustomer.name" required placeholder="例如: 台積電">
          </div>
          <div>
            <label class="input-label">客戶代碼 (R0用)</label>
            <input type="text" class="input input-bordered w-full" v-model="formCustomer.code" required placeholder="例如: TSM" maxlength="10" style="text-transform: uppercase;">
          </div>
        </div>
        <div style="margin-bottom: 1rem;">
          <label class="input-label">廠區列表 (用逗號分隔)</label>
          <textarea class="textarea textarea-bordered w-full" v-model="formCustomer.sitesInput" rows="2" placeholder="例如: F12, F18P5, F18P7"></textarea>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" :class="['btn', 'flex-1', editingCustomerId ? 'btn-warning' : 'btn-primary']">
            {{ editingCustomerId ? '更新客戶' : '新增客戶' }}
          </button>
          <button v-if="editingCustomerId" type="button" class="btn btn-ghost btn-outline" @click="cancelEditCustomer">取消</button>
        </div>
      </form>
    </div>
    <div>
      <div class="scrollable" style="max-height: 250px; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
        <table class="data-table">
          <thead>
            <tr><th>客戶</th><th>代碼</th><th>廠區</th><th style="text-align: right;">操作</th></tr>
          </thead>
          <tbody>
            <tr v-for="c in customers" :key="c.id">
              <td style="font-weight: 500;">{{ c.name }}</td>
              <td><code style="background: #f1f5f9; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem;">{{ c.code || '-' }}</code></td>
              <td style="font-size: 0.75rem; color: #64748b; max-width: 150px;">
                {{ (() => { try { return JSON.parse(c.sites).join(', '); } catch { return '-'; } })() }}
              </td>
              <td style="text-align: right;">
                <div class="btn-group">
                  <button class="btn btn-sm btn-ghost" @click="startEditCustomer(c)">編輯</button>
                  <button class="btn btn-sm btn-error btn-outline" @click="deleteCustomer(c.id)">刪除</button>
                </div>
              </td>
            </tr>
            <tr v-if="customers.length === 0" class="empty-row"><td colspan="4">尚無資料</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 3. Products -->
  <div class="settings-section" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
    <div class="settings-form" style="background: linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(34,197,94,0.05) 100%);">
      <h3 style="color: #16a34a;">產品管理</h3>
      <form @submit.prevent="submitProduct">
        <div style="margin-bottom: 0.75rem;">
          <label class="input-label">產品名稱</label>
          <input type="text" class="input input-bordered w-full" v-model="formProduct.name" required placeholder="例如: HEPA濾網">
        </div>
        <div style="margin-bottom: 0.75rem;">
          <label class="input-label">產品編號/型號</label>
          <input type="text" class="input input-bordered w-full" v-model="formProduct.code" required placeholder="例如: HEPA-300">
        </div>
        <div style="margin-bottom: 1rem;">
          <label class="input-label">產品類型</label>
          <div class="chip-group">
            <div v-for="t in ['6cm', '10cm', '20cm']" :key="t"
                 :class="['chip', formProduct.type === t ? 'selected' : '']"
                 @click="formProduct.type = t">{{ t }}</div>
          </div>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" :class="['btn', 'flex-1', editingProductId ? 'btn-warning' : 'btn-success']">
            {{ editingProductId ? '更新產品' : '新增產品' }}
          </button>
          <button v-if="editingProductId" type="button" class="btn btn-ghost btn-outline" @click="cancelEditProduct">取消</button>
        </div>
      </form>
    </div>
    <div>
      <div class="scrollable" style="max-height: 250px; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
        <table class="data-table">
          <thead>
            <tr><th>型號</th><th>名稱</th><th>類型</th><th style="text-align: right;">操作</th></tr>
          </thead>
          <tbody>
            <tr v-for="p in products" :key="p.id">
              <td style="font-weight: 700;">{{ p.code }}</td>
              <td>{{ p.name }}</td>
              <td><span class="badge badge-success">{{ p.type }}</span></td>
              <td style="text-align: right;">
                <div class="btn-group">
                  <button class="btn btn-sm btn-ghost" @click="startEditProduct(p)">編輯</button>
                  <button class="btn btn-sm btn-error btn-outline" @click="deleteProduct(p.id)">刪除</button>
                </div>
              </td>
            </tr>
            <tr v-if="products.length === 0" class="empty-row"><td colspan="4">尚無資料</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 4. NG Reasons -->
  <div class="settings-section">
    <div class="settings-form" style="background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.05) 100%);">
      <h3 style="color: #dc2626;">NG 原因管理</h3>
      <form @submit.prevent="submitNgReason">
        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 0.75rem; margin-bottom: 0.75rem;">
          <div>
            <label class="input-label">原因名稱</label>
            <input type="text" class="input input-bordered w-full" v-model="formNgReason.name" required placeholder="例如: 膠殘留">
          </div>
          <div>
            <label class="input-label">代碼</label>
            <input type="text" class="input input-bordered w-full" v-model="formNgReason.code" placeholder="NG01" maxlength="10">
          </div>
        </div>
        <div style="margin-bottom: 1rem;">
          <label class="input-label">說明 (選填)</label>
          <input type="text" class="input input-bordered w-full" v-model="formNgReason.description" placeholder="補充說明此 NG 原因">
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button type="submit" :class="['btn', 'flex-1', editingNgReasonId ? 'btn-warning' : 'btn-error']">
            {{ editingNgReasonId ? '更新原因' : '新增原因' }}
          </button>
          <button v-if="editingNgReasonId" type="button" class="btn btn-ghost btn-outline" @click="cancelEditNgReason">取消</button>
        </div>
      </form>
    </div>
    <div>
      <div class="scrollable" style="max-height: 200px; border: 1px solid #e2e8f0; border-radius: 0.5rem;">
        <table class="data-table">
          <thead>
            <tr><th>原因</th><th>代碼</th><th>說明</th><th style="text-align: right;">操作</th></tr>
          </thead>
          <tbody>
            <tr v-for="r in ngReasons" :key="r.id">
              <td style="font-weight: 500; color: #dc2626;">{{ r.name }}</td>
              <td><code style="background: #fee2e2; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 0.75rem;">{{ r.code || '-' }}</code></td>
              <td style="font-size: 0.75rem; color: #64748b; max-width: 150px;">{{ r.description || '-' }}</td>
              <td style="text-align: right;">
                <div class="btn-group">
                  <button class="btn btn-sm btn-ghost" @click="startEditNgReason(r)">編輯</button>
                  <button class="btn btn-sm btn-error btn-outline" @click="deleteNgReason(r.id)">刪除</button>
                </div>
              </td>
            </tr>
            <tr v-if="ngReasons.length === 0" class="empty-row"><td colspan="4">尚無 NG 原因，請先新增</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 5. Admin Tools -->
  <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
    <h3 style="margin: 0 0 1rem; color: #1e293b;">系統工具</h3>
    <div class="admin-grid">
      <div class="admin-card blue">
        <h4>同步資料庫</h4>
        <p>新增缺少的欄位（如簽名欄）</p>
        <button class="btn btn-primary w-full" :disabled="adminLoading" @click="adminSyncDatabase">
          {{ adminLoading ? '同步中...' : '同步資料庫' }}
        </button>
      </div>

      <div class="admin-card orange">
        <h4>修復欄位順序</h4>
        <p>修正欄位順序錯亂導致的資料問題</p>
        <button class="btn btn-warning w-full" :disabled="adminLoading" @click="adminFixColumnOrder">
          {{ adminLoading ? '修復中...' : '修復欄位順序' }}
        </button>
      </div>

      <div class="admin-card pink">
        <h4>修復簽名資料</h4>
        <p>修復簽名資料儲存位置錯誤問題</p>
        <button class="btn btn-error btn-outline w-full" :disabled="adminLoading" @click="adminFixSignatureData">
          {{ adminLoading ? '修復中...' : '修復簽名資料' }}
        </button>
      </div>

      <div class="admin-card purple">
        <h4>產生測試資料</h4>
        <p>產生測試資料驗證系統完整度</p>
        <button class="btn btn-ghost w-full" :disabled="adminLoading" @click="adminGenerateTestData">
          {{ adminLoading ? '產生中...' : '產生測試資料' }}
        </button>
      </div>

      <div class="admin-card gray">
        <h4>系統資訊</h4>
        <p style="font-family: monospace; margin-bottom: 0.5rem;">
          版本: <strong>{{ systemVersion }}</strong>
        </p>
        <p style="margin-bottom: 0;">
          資料庫: Google Sheets<br>
          部署: Google Apps Script
        </p>
      </div>
    </div>

    <div v-if="adminMessage" :class="['alert-message', adminMessageType]" style="margin-top: 1rem;">
      {{ adminMessage }}
    </div>
  </div>

</div>
