<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.8); z-index: 50;
      display: flex; justify-content: center; align-items: center;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="p-4 max-w-6xl mx-auto">
    
    <!-- Header -->
    <header class="bg-white shadow rounded-lg p-4 mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-800">SMAI - MES 線外表單</h1>
        <p class="text-sm text-gray-500">緊急備援作業模式 <span v-if="version" class="ml-2 text-xs bg-gray-200 px-1 rounded">v{{ version }}</span></p>
      </div>
      <div>
        <button @click="refreshData" class="px-5 py-3 bg-blue-600 text-white text-base font-medium rounded-lg shadow hover:bg-blue-700 active:bg-blue-800">
          重新整理
        </button>
      </div>
    </header>

    <!-- Loading -->
    <div v-if="loading" class="loading-overlay">
      <div class="text-xl font-bold text-blue-600">載入中...</div>
    </div>

    <!-- Tabs -->
    <div class="flex space-x-2 mb-4 overflow-x-auto pb-1">
      <button
        v-for="tab in ['work-orders', 'dispatches', 'reports', 'outgassing', 'aoi', 'rfid-replace', 'settings']"
        :key="tab"
        @click="currentTab = tab"
        :class="['px-5 py-3 rounded-lg font-medium whitespace-nowrap text-base transition-all',
          currentTab === tab
            ? 'bg-blue-600 text-white shadow-md'
            : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 active:bg-gray-100']"
      >
        {{ {
          'work-orders': '工單管理',
          'dispatches': '現場派工',
          'reports': '報工紀錄',
          'outgassing': '釋氣檢驗',
          'aoi': 'AOI 檢驗',
          'rfid-replace': 'RFID 更換',
          'settings': '設定'
        }[tab] }}
      </button>
    </div>

    <!-- Content: Work Orders -->
    <div v-if="currentTab === 'work-orders'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">工單列表</h2>
        <button @click="showCreateWoModal = true" class="px-5 py-3 bg-green-600 text-white text-base font-medium rounded-lg shadow hover:bg-green-700 active:bg-green-800">
          + 建立工單
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">單號</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">產品/客戶</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">進度</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">數量 (完工/總數)</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr v-for="wo in workOrders" :key="wo.id">
              <td class="px-6 py-4 whitespace-nowrap font-medium">{{ wo.orderNumber }}</td>
              <td class="px-6 py-4">
                <div class="text-sm font-bold">{{ wo.productModel }}</div>
                <div class="text-xs text-gray-500">{{ wo.customerName }}</div>
              </td>
              <td class="px-6 py-4">
                <span :class="getStatusClass(wo.status)" class="px-2 py-1 rounded-full text-xs">
                  {{ wo.status }}
                </span>
              </td>
              <td class="px-6 py-4 text-sm">
                {{ wo.completedQty }} / {{ wo.quantity }}
              </td>
              <td class="px-4 py-4">
                <div class="flex flex-wrap gap-2">
                  <button
                    v-if="wo.status !== 'completed'"
                    @click="openDispatchModal(wo)"
                    class="px-3 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 active:bg-indigo-800"
                  >
                    派工
                  </button>
                  <button
                    v-if="wo.status === 'draft'"
                    @click="startEditWorkOrder(wo)"
                    class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg border border-gray-300 hover:bg-gray-200 active:bg-gray-300"
                  >
                    編輯
                  </button>
                  <button
                    v-if="wo.status === 'draft' || wo.status === 'pending'"
                    @click="deleteWorkOrder(wo.id)"
                    class="px-3 py-2 bg-white text-red-600 text-sm font-medium rounded-lg border border-red-300 hover:bg-red-50 active:bg-red-100"
                  >
                    取消
                  </button>
                  <span v-if="wo.status === 'completed'" class="px-3 py-2 text-green-600 text-sm font-medium">
                    已完成
                  </span>
                </div>
              </td>
            </tr>
            <tr v-if="workOrders.length === 0">
              <td colspan="5" class="px-6 py-8 text-center text-gray-500">暫無工單資料</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Content: Dispatches -->
    <div v-if="currentTab === 'dispatches'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-bold">現場派工任務</h2>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div v-for="d in dispatches" :key="d.id" class="border rounded-lg p-4 bg-white hover:shadow-md transition">
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="text-xs font-mono text-gray-500">{{ d.dispatchNumber }}</span>
              <div class="text-xs text-gray-400">{{ workOrders.find(w => w.id === d.workOrderId)?.orderNumber || '-' }}</div>
            </div>
            <span :class="getStatusClass(d.status)" class="px-2 py-0.5 rounded text-xs">{{ d.status }}</span>
          </div>
          <h3 class="font-bold text-lg mb-1">{{ d.stationName }}</h3>
          <p class="text-sm text-gray-600 mb-2">操作員: {{ d.operatorName }}</p>
          
          <div class="bg-gray-100 rounded p-2 mb-3 text-sm">
            <div class="flex justify-between mb-1">
              <span>目標: {{ d.quantity }}</span>
              <span>良品: {{ d.goodQty }}</span>
            </div>
            <div class="w-full bg-gray-300 rounded-full h-2">
              <div class="bg-green-500 h-2 rounded-full" :style="{ width: Math.min((d.completedQty / d.quantity) * 100, 100) + '%' }"></div>
            </div>
            <div v-if="d.actualStartAt" class="mt-2 text-xs text-blue-600 font-mono">
              開始: {{ new Date(d.actualStartAt).toLocaleString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }}
            </div>
          </div>

          <!-- 操作按鈕區 -->
          <div class="space-y-2">
            <button
              v-if="d.status === 'pending'"
              @click="startJob(d)"
              class="w-full py-3 bg-blue-600 text-white text-base font-bold rounded-lg hover:bg-blue-700 active:bg-blue-800 shadow"
            >
              開始作業
            </button>

            <button
              v-if="d.status === 'in_progress'"
              @click="completeJob(d)"
              class="w-full py-3 bg-green-600 text-white text-base font-bold rounded-lg hover:bg-green-700 active:bg-green-800 shadow"
            >
              完成並報工
            </button>

            <div v-if="d.status === 'completed'" class="w-full py-3 bg-gray-100 text-gray-500 text-base font-bold rounded-lg text-center">
              已完成
            </div>

            <button
              v-if="d.status === 'pending'"
              @click="deleteDispatch(d.id)"
              class="w-full py-2 bg-white text-red-600 text-sm font-medium rounded-lg border border-red-300 hover:bg-red-50 active:bg-red-100"
            >
              取消派工
            </button>
          </div>
        </div>
      </div>
      
      <div v-if="dispatches.length === 0" class="text-center py-8 text-gray-500">
        暫無派工任務，請從工單頁面進行派工。
      </div>
    </div>

    <!-- Content: Reports -->
    <div v-if="currentTab === 'reports'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex justify-between mb-4">
        <h2 class="text-xl font-bold">報工紀錄</h2>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">報工單號</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">派工單號</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">站點/人員</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">良品</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NG</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">異常</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">時間</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr v-for="r in reports" :key="r.id">
              <td class="px-4 py-3 text-sm font-mono">{{ r.reportNumber }}</td>
              <td class="px-4 py-3 text-sm text-gray-500">
                {{ dispatches.find(d => d.id === r.dispatchId)?.dispatchNumber || '-' }}
              </td>
              <td class="px-4 py-3 text-sm">
                <div class="font-medium">{{ r.stationName }}</div>
                <div class="text-xs text-gray-500">{{ r.operatorName }}</div>
              </td>
              <td class="px-4 py-3 text-sm text-green-600 font-bold">{{ r.goodQty }}</td>
              <td class="px-4 py-3 text-sm text-red-600 font-bold">{{ r.ngQty }}</td>
              <td class="px-4 py-3 text-sm">
                <span v-if="r.hasAbnormal === true || r.hasAbnormal === 'TRUE'" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs">
                  {{ r.abnormalType || '異常' }}
                </span>
                <span v-else class="text-gray-400">-</span>
              </td>
              <td class="px-4 py-3 text-xs text-gray-500">
                {{ r.createdAt ? new Date(r.createdAt).toLocaleString('zh-TW') : '-' }}
              </td>
            </tr>
            <tr v-if="reports.length === 0">
              <td colspan="7" class="px-4 py-8 text-center text-gray-500">暫無報工紀錄</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Content: Outgassing Test (釋氣檢驗) -->
    <div v-if="currentTab === 'outgassing'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">釋氣檢驗 (18抽1)</h2>
      </div>

      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left: Form -->
        <div class="w-full lg:w-1/3">
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
            <div class="text-sm text-purple-800 font-medium mb-2">抽樣規則</div>
            <div class="text-xs text-purple-600">每批 18 片抽檢 1 片，抽樣率 5.56%</div>
          </div>

          <form @submit.prevent="submitOutgassingTest" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">選擇工單</label>
              <select v-model="formOutgassing.workOrderId" @change="loadOutgassingSampleInfo" required class="block w-full border border-gray-300 rounded-lg p-3 bg-white">
                <option value="" disabled>-- 請選擇 --</option>
                <option v-for="wo in workOrders.filter(w => w.status !== 'completed' && w.status !== 'cancelled')" :key="wo.id" :value="wo.id">
                  {{ wo.orderNumber }} - {{ wo.productModel }}
                </option>
              </select>
            </div>

            <!-- Sample Info -->
            <div v-if="outgassingSampleInfo" class="bg-gray-50 rounded-lg p-4 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">工單數量</span>
                <span class="font-bold">{{ outgassingSampleInfo.totalQty }} 片</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">需抽樣數</span>
                <span class="font-bold">{{ outgassingSampleInfo.requiredSamples }} 片</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">已檢驗</span>
                <span class="font-bold">{{ outgassingSampleInfo.testedCount }} 片</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">合格率</span>
                <span :class="outgassingSampleInfo.passRate >= 100 ? 'text-green-600' : 'text-orange-600'" class="font-bold">
                  {{ outgassingSampleInfo.passRate }}%
                </span>
              </div>
              <div v-if="!outgassingSampleInfo.isComplete" class="mt-2 pt-2 border-t">
                <div class="text-xs text-gray-500">下一抽樣</div>
                <div class="font-bold text-purple-700">
                  第 {{ outgassingSampleInfo.nextSampleIndex }} 片 (批次 {{ outgassingSampleInfo.nextBatchRange }})
                </div>
              </div>
              <div v-else class="mt-2 pt-2 border-t text-center">
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-bold">抽樣完成</span>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">條碼編號</label>
              <input v-model="formOutgassing.rfidCode" placeholder="掃描條碼" class="block w-full border border-gray-300 rounded-lg p-3">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">檢驗結果</label>
              <div class="flex gap-3">
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="ogResult" v-model="formOutgassing.result" value="PASS" class="hidden">
                  <div :class="['py-3 border-2 rounded-lg text-center font-bold text-lg transition-all',
                    formOutgassing.result === 'PASS' ? 'bg-green-600 text-white border-green-600' : 'bg-white border-gray-300 hover:border-green-400']">
                    PASS
                  </div>
                </label>
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="ogResult" v-model="formOutgassing.result" value="NG" class="hidden">
                  <div :class="['py-3 border-2 rounded-lg text-center font-bold text-lg transition-all',
                    formOutgassing.result === 'NG' ? 'bg-red-600 text-white border-red-600' : 'bg-white border-gray-300 hover:border-red-400']">
                    NG
                  </div>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
              <input v-model="formOutgassing.notes" placeholder="選填：檢測數值或說明" class="block w-full border border-gray-300 rounded-lg p-3">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">檢驗員</label>
              <div class="grid grid-cols-3 gap-2">
                <label v-for="op in operators" :key="op.id" class="cursor-pointer">
                  <input type="radio" name="ogOperator" v-model="formOutgassing.operatorName" :value="op.name" class="hidden">
                  <div :class="['py-2 border rounded-lg text-center text-sm font-medium truncate',
                    formOutgassing.operatorName === op.name ? 'bg-purple-600 text-white border-purple-600' : 'bg-white hover:bg-gray-100']">
                    {{ op.name }}
                  </div>
                </label>
              </div>
            </div>

            <!-- Signature Pad -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">品檢簽名</label>
              <div class="border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 relative">
                <canvas ref="signaturePadOutgassing" width="300" height="120" class="w-full touch-none cursor-crosshair"
                  @mousedown="startSign($event, 'outgassing')" @mousemove="drawSign($event, 'outgassing')" @mouseup="endSign('outgassing')" @mouseleave="endSign('outgassing')"
                  @touchstart.prevent="startSign($event, 'outgassing')" @touchmove.prevent="drawSign($event, 'outgassing')" @touchend="endSign('outgassing')">
                </canvas>
                <button type="button" @click="clearSignature('outgassing')" class="absolute top-1 right-1 text-xs text-gray-500 hover:text-red-500 bg-white px-2 py-1 rounded shadow-sm">
                  清除
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-1">請在上方區域簽名</p>
            </div>

            <button type="submit" class="w-full py-3 bg-purple-600 text-white text-base font-bold rounded-lg shadow hover:bg-purple-700 active:bg-purple-800">
              記錄檢驗結果
            </button>
          </form>
        </div>

        <!-- Right: Records -->
        <div class="w-full lg:w-2/3">
          <h3 class="font-bold text-lg mb-3">
            檢驗紀錄
            <span v-if="formOutgassing.workOrderId" class="text-sm font-normal text-purple-600">
              ({{ workOrders.find(w => w.id === formOutgassing.workOrderId)?.orderNumber }})
            </span>
            <span v-else class="text-sm font-normal text-gray-500">(全部)</span>
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">單號</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">工單</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">條碼</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">結果</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">檢驗員</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">時間</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="t in filteredOutgassingTests" :key="t.id">
                  <td class="px-3 py-2 text-sm font-mono">{{ t.testNumber }}</td>
                  <td class="px-3 py-2 text-sm">{{ t.orderNumber }}</td>
                  <td class="px-3 py-2 text-sm font-mono text-gray-500">{{ t.rfidCode || '-' }}</td>
                  <td class="px-3 py-2">
                    <span :class="t.result === 'PASS' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                          class="px-2 py-1 rounded text-xs font-bold">
                      {{ t.result }}
                    </span>
                  </td>
                  <td class="px-3 py-2 text-sm">{{ t.operatorName }}</td>
                  <td class="px-3 py-2 text-xs text-gray-500">
                    {{ t.testedAt ? new Date(t.testedAt).toLocaleString('zh-TW') : '-' }}
                  </td>
                </tr>
                <!-- Report Button Row -->
                <tr v-if="formOutgassing.workOrderId && filteredOutgassingTests.length > 0" class="bg-gray-100">
                  <td colspan="6" class="px-3 py-3 text-center">
                    <button @click="generateOutgassingReport"
                      class="px-6 py-2 bg-gray-700 text-white text-sm font-bold rounded-lg shadow hover:bg-gray-800">
                      產生品檢報告
                    </button>
                  </td>
                </tr>
                <tr v-if="filteredOutgassingTests.length === 0">
                  <td colspan="6" class="px-3 py-8 text-center text-gray-500">
                    {{ formOutgassing.workOrderId ? '此工單尚無檢驗紀錄' : '請選擇工單查看紀錄' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Content: AOI Inspection (AOI 檢驗) -->
    <div v-if="currentTab === 'aoi'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold">AOI 自動光學檢驗</h2>
      </div>

      <div class="flex flex-col lg:flex-row gap-6">
        <!-- Left: Import -->
        <div class="w-full lg:w-1/3">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
            <div class="text-sm text-blue-800 font-medium mb-2">CSV 匯入格式</div>
            <div class="text-xs text-blue-600 font-mono bg-white p-2 rounded">
              Barcode, Result, DefectType, DefectCount<br>
              BC001, PASS, , 0<br>
              BC002, NG, 刮傷, 2
            </div>
          </div>

          <form @submit.prevent="submitAoiImport" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">選擇工單</label>
              <select v-model="formAoi.workOrderId" required class="block w-full border border-gray-300 rounded-lg p-3 bg-white">
                <option value="" disabled>-- 請選擇 --</option>
                <option v-for="wo in workOrders.filter(w => w.status !== 'completed' && w.status !== 'cancelled')" :key="wo.id" :value="wo.id">
                  {{ wo.orderNumber }} - {{ wo.productModel }}
                </option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">匯入人員</label>
              <div class="grid grid-cols-3 gap-2">
                <label v-for="op in operators" :key="op.id" class="cursor-pointer">
                  <input type="radio" name="aoiOperator" v-model="formAoi.operatorName" :value="op.name" class="hidden">
                  <div :class="['py-2 border rounded-lg text-center text-sm font-medium truncate',
                    formAoi.operatorName === op.name ? 'bg-blue-600 text-white border-blue-600' : 'bg-white hover:bg-gray-100']">
                    {{ op.name }}
                  </div>
                </label>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">CSV 檔案</label>
              <input type="file" accept=".csv" @change="handleAoiCsvFile" ref="aoiFileInput"
                     class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
            </div>

            <div v-if="aoiCsvPreview.length > 0" class="bg-gray-50 rounded-lg p-3">
              <div class="text-sm font-medium text-gray-700 mb-2">預覽 (前 5 筆)</div>
              <div class="text-xs space-y-1">
                <div v-for="(row, i) in aoiCsvPreview.slice(0, 5)" :key="i" class="flex gap-2">
                  <span class="font-mono">{{ row.rfidCode }}</span>
                  <span :class="row.result === 'PASS' ? 'text-green-600' : 'text-red-600'">{{ row.result }}</span>
                  <span class="text-gray-500">{{ row.defectType || '-' }}</span>
                </div>
              </div>
              <div class="mt-2 text-xs text-gray-500">共 {{ aoiCsvPreview.length }} 筆資料</div>
            </div>

            <button type="submit" :disabled="aoiCsvPreview.length === 0"
                    :class="aoiCsvPreview.length > 0 ? 'bg-blue-600 hover:bg-blue-700 active:bg-blue-800' : 'bg-gray-300 cursor-not-allowed'"
                    class="w-full py-3 text-white text-base font-bold rounded-lg shadow">
              匯入 AOI 結果
            </button>
          </form>

          <!-- Single Entry -->
          <div class="mt-6 pt-6 border-t">
            <h4 class="font-medium text-gray-700 mb-3">單筆輸入</h4>
            <form @submit.prevent="submitSingleAoi" class="space-y-3">
              <input v-model="formAoiSingle.rfidCode" placeholder="條碼編號" class="block w-full border border-gray-300 rounded-lg p-2 text-sm">
              <div class="flex gap-2">
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="aoiSingleResult" v-model="formAoiSingle.result" value="PASS" class="hidden">
                  <div :class="['py-2 border rounded-lg text-center text-sm font-bold',
                    formAoiSingle.result === 'PASS' ? 'bg-green-600 text-white' : 'bg-white hover:bg-green-50']">PASS</div>
                </label>
                <label class="flex-1 cursor-pointer">
                  <input type="radio" name="aoiSingleResult" v-model="formAoiSingle.result" value="NG" class="hidden">
                  <div :class="['py-2 border rounded-lg text-center text-sm font-bold',
                    formAoiSingle.result === 'NG' ? 'bg-red-600 text-white' : 'bg-white hover:bg-red-50']">NG</div>
                </label>
              </div>
              <input v-if="formAoiSingle.result === 'NG'" v-model="formAoiSingle.defectType" placeholder="缺陷類型" class="block w-full border border-gray-300 rounded-lg p-2 text-sm">
              <button type="submit" class="w-full py-2 bg-gray-600 text-white text-sm font-bold rounded-lg hover:bg-gray-700">
                新增單筆
              </button>
            </form>
          </div>
        </div>

        <!-- Right: Records -->
        <div class="w-full lg:w-2/3">
          <h3 class="font-bold text-lg mb-3">檢驗紀錄</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">單號</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">工單</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">條碼</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">結果</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">缺陷</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">時間</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <tr v-for="a in aoiInspections" :key="a.id">
                  <td class="px-3 py-2 text-sm font-mono">{{ a.inspectionNumber }}</td>
                  <td class="px-3 py-2 text-sm">{{ a.orderNumber }}</td>
                  <td class="px-3 py-2 text-sm font-mono text-gray-500">{{ a.rfidCode || '-' }}</td>
                  <td class="px-3 py-2">
                    <span :class="a.result === 'PASS' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'"
                          class="px-2 py-1 rounded text-xs font-bold">
                      {{ a.result }}
                    </span>
                  </td>
                  <td class="px-3 py-2 text-sm text-gray-500">{{ a.defectType || '-' }}</td>
                  <td class="px-3 py-2 text-xs text-gray-500">
                    {{ a.inspectedAt ? new Date(a.inspectedAt).toLocaleString('zh-TW') : '-' }}
                  </td>
                </tr>
                <tr v-if="aoiInspections.length === 0">
                  <td colspan="6" class="px-3 py-8 text-center text-gray-500">暫無檢驗紀錄</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Content: RFID Replacement -->
    <div v-if="currentTab === 'rfid-replace'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Left: Form -->
        <div class="w-full md:w-1/2">
          <h2 class="text-xl font-bold mb-4">RFID 標籤更換作業</h2>
          <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4 text-sm text-blue-800">
            請選擇再生工單，並掃描舊標籤與新標籤以進行綁定。此操作將記錄產品的再生履歷。
          </div>
          
          <form @submit.prevent="submitEpcChange" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">選擇再生工單</label>
              
              <div class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto border p-2 rounded bg-gray-50">
                <div v-if="regenerationOrders.length === 0" class="text-center text-gray-500 py-4 text-sm">
                  目前無進行中的再生工單
                </div>
                
                <label v-for="wo in regenerationOrders" :key="wo.id" class="cursor-pointer relative">
                  <input type="radio" name="rfidWo" v-model="formEpc.workOrderId" :value="wo.id" class="hidden" @change="onWoSelect">
                  <div :class="['p-3 border-2 rounded-lg bg-white transition-all', formEpc.workOrderId === wo.id ? 'border-blue-500 bg-blue-50' : 'hover:bg-blue-50']">
                    <div class="flex justify-between items-center">
                      <div>
                        <div class="font-bold text-gray-800">{{ wo.orderNumber }}</div>
                        <div class="text-xs text-gray-500">{{ wo.productModel }} ({{ wo.customerName }})</div>
                      </div>
                      <div class="flex items-center text-sm font-bold text-gray-600 bg-gray-100 px-2 py-1 rounded">
                        <span>R{{ (wo.targetRegenerationCount || 1) - 1 }}</span>
                        <span class="mx-1 text-gray-400">-></span>
                        <span class="text-blue-600">R{{ wo.targetRegenerationCount || 1 }}</span>
                      </div>
                    </div>
                  </div>
                  <!-- Checkmark Icon -->
                  <div v-if="formEpc.workOrderId === wo.id" class="absolute top-1/2 right-3 transform -translate-y-1/2 text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                  </div>
                </label>
              </div>
            </div>
            
            <div class="p-4 border rounded-md bg-gray-50">
              <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-1">舊 EPC (Old Tag)</label>
                <div class="flex gap-2">
                   <input v-model="formEpc.oldEpc" @blur="checkOldEpc" placeholder="掃描舊標籤" class="block w-full border border-gray-300 rounded-md p-2">
                   <span v-if="epcCheckStatus === 'checking'" class="text-gray-500 self-center">...</span>
                </div>
                <p v-if="epcCheckInfo" :class="epcCheckInfo.found ? 'text-green-600' : 'text-orange-500'" class="text-xs mt-1 font-bold">
                  {{ epcCheckInfo.message }}
                </p>
                <p v-else class="text-xs text-gray-500 mt-1">來源產品上的舊標籤</p>
              </div>
              
              <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-1 text-blue-700">新 EPC (New Tag)</label>
                <input v-model="formEpc.newEpc" required placeholder="掃描新標籤 (例如: RF...)" pattern="^RF[0-9]{13}$" title="格式需為 RF 開頭加上 13 位數字" class="block w-full border border-blue-300 rounded-md p-2 bg-white ring-2 ring-transparent focus:ring-blue-500">
                <p class="text-xs text-gray-500 mt-1">格式: RF + 13碼數字 (例: RF2026010100001)</p>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">操作人員</label>

              <!-- Radio Mode -->
              <div v-if="operators.length > 0 && operators.length <= 12" class="grid grid-cols-3 gap-2">
                <label v-for="op in operators" :key="op.id" class="cursor-pointer">
                  <input type="radio" name="rfidOperator" v-model="formEpc.operatorName" :value="op.name" class="hidden">
                  <div :class="['py-2 border rounded-md text-center text-sm font-medium truncate', formEpc.operatorName === op.name ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-100']">
                    {{ op.name }}
                  </div>
                </label>
              </div>

              <!-- Select Mode -->
              <select v-else v-model="formEpc.operatorName" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white">
                <option value="" disabled>-- 請選擇 --</option>
                <option v-for="op in operators" :key="op.id" :value="op.name">{{ op.name }}</option>
              </select>
            </div>

            <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-md font-bold hover:bg-blue-700 shadow-md">
              確認更換與綁定
            </button>
          </form>
        </div>

        <!-- Right: Recent History -->
        <div class="w-full md:w-1/2 border-t md:border-t-0 md:border-l pl-0 md:pl-6 pt-6 md:pt-0">
          <h3 class="text-lg font-bold mb-3 text-gray-700">最近更換紀錄</h3>
          <div class="overflow-y-auto max-h-[500px]">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-2 py-2 text-left">時間</th>
                  <th class="px-2 py-2 text-left">舊標籤 -> 新標籤</th>
                  <th class="px-2 py-2 text-left">工單</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="h in epcHistory" :key="h.id" class="border-b">
                  <td class="px-2 py-2 text-gray-500 text-xs">
                    {{ new Date(h.createdAt).toLocaleString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }}
                  </td>
                  <td class="px-2 py-2">
                    <div class="text-red-500 text-xs line-through">{{ h.oldEpc || '(無)' }}</div>
                    <div class="text-green-600 font-mono font-bold">↓ {{ h.newEpc }}</div>
                  </td>
                  <td class="px-2 py-2 text-xs text-gray-600">
                    {{ h.orderNumber }}
                  </td>
                </tr>
                <tr v-if="epcHistory.length === 0">
                  <td colspan="3" class="text-center py-4 text-gray-400">尚無紀錄</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Content: Settings -->
    <div v-if="currentTab === 'settings'" class="bg-white shadow rounded-b-lg rounded-tr-lg p-6 space-y-8">
      
      <!-- 1. Operators -->
      <div class="flex flex-col md:flex-row gap-6 border-b pb-6">
        <div class="w-full md:w-1/3">
          <h3 class="font-bold text-lg mb-4 text-gray-800">人員管理</h3>
          <form @submit.prevent="submitOperator" class="space-y-4 bg-gray-50 p-4 rounded">
            <div>
              <label class="block text-sm font-medium text-gray-700">姓名</label>
              <input v-model="formOperator.name" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">編號/代號</label>
              <input v-model="formOperator.code" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-gray-700 text-white py-3 text-base font-medium rounded-lg hover:bg-gray-800 active:bg-gray-900 shadow">
                {{ editingOperatorId ? '更新人員' : '新增人員' }}
              </button>
              <button v-if="editingOperatorId" type="button" @click="cancelEditOperator" class="px-4 py-3 bg-white border border-gray-300 text-base rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            </div>
          </form>
        </div>
        <div class="w-full md:w-2/3">
          <div class="bg-white border rounded overflow-hidden max-h-60 overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="px-4 py-2 text-left">姓名</th><th class="px-4 py-2 text-left">編號</th><th class="px-4 py-2 text-right">操作</th></tr>
              </thead>
              <tbody>
                <tr v-for="op in operators" :key="op.id">
                  <td class="px-4 py-2">{{ op.name }}</td>
                  <td class="px-4 py-2 text-gray-500">{{ op.code }}</td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                      <button @click="startEditOperator(op)" class="px-3 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-200 active:bg-blue-300">編輯</button>
                      <button @click="deleteOperator(op.id)" class="px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-lg hover:bg-red-200 active:bg-red-300">刪除</button>
                    </div>
                  </td>
                </tr>
                <tr v-if="operators.length === 0"><td colspan="3" class="px-4 py-4 text-center text-gray-500">尚無資料</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 2. Customers -->
      <div class="flex flex-col md:flex-row gap-6 border-b pb-6">
        <div class="w-full md:w-1/3">
          <h3 class="font-bold text-lg mb-4 text-blue-800">客戶管理</h3>
          <form @submit.prevent="submitCustomer" class="space-y-4 bg-blue-50 p-4 rounded">
            <div>
              <label class="block text-sm font-medium text-gray-700">客戶名稱</label>
              <input v-model="formCustomer.name" required placeholder="例如: 台積電 (TSMC)" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">廠區列表 (用逗號分隔)</label>
              <textarea v-model="formCustomer.sitesInput" rows="3" placeholder="例如: F12, F18P5, F18P7" class="mt-1 block w-full border border-gray-300 rounded-md p-2"></textarea>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-blue-600 text-white py-3 text-base font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 shadow">
                {{ editingCustomerId ? '更新客戶' : '新增客戶' }}
              </button>
              <button v-if="editingCustomerId" type="button" @click="cancelEditCustomer" class="px-4 py-3 bg-white border border-gray-300 text-base rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            </div>
          </form>
        </div>
        <div class="w-full md:w-2/3">
          <div class="bg-white border rounded overflow-hidden max-h-60 overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="px-4 py-2 text-left">客戶</th><th class="px-4 py-2 text-left">廠區</th><th class="px-4 py-2 text-right">操作</th></tr>
              </thead>
              <tbody>
                <tr v-for="c in customers" :key="c.id">
                  <td class="px-4 py-2 font-medium">{{ c.name }}</td>
                  <td class="px-4 py-2 text-xs text-gray-600 max-w-xs truncate">
                    {{ (() => { try { return JSON.parse(c.sites).join(', '); } catch { return '-'; } })() }}
                  </td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                      <button @click="startEditCustomer(c)" class="px-3 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-200 active:bg-blue-300">編輯</button>
                      <button @click="deleteCustomer(c.id)" class="px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-lg hover:bg-red-200 active:bg-red-300">刪除</button>
                    </div>
                  </td>
                </tr>
                <tr v-if="customers.length === 0"><td colspan="3" class="px-4 py-4 text-center text-gray-500">尚無資料</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 3. Products -->
      <div class="flex flex-col md:flex-row gap-6">
        <div class="w-full md:w-1/3">
          <h3 class="font-bold text-lg mb-4 text-green-800">產品管理</h3>
          <form @submit.prevent="submitProduct" class="space-y-4 bg-green-50 p-4 rounded">
            <div>
              <label class="block text-sm font-medium text-gray-700">產品名稱</label>
              <input v-model="formProduct.name" required placeholder="例如: HEPA濾網" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">產品編號/型號</label>
              <input v-model="formProduct.code" required placeholder="例如: HEPA-300" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">產品類型</label>
              <div class="flex gap-2">
                <label v-for="t in ['6cm', '10cm', '20cm']" :key="t" class="cursor-pointer">
                  <input type="radio" name="prodType" v-model="formProduct.type" :value="t" class="hidden">
                  <div :class="['px-3 py-1 border rounded text-sm', formProduct.type === t ? 'bg-green-600 text-white border-green-600' : 'bg-white hover:bg-gray-100']">{{ t }}</div>
                </label>
              </div>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="flex-1 bg-green-600 text-white py-3 text-base font-medium rounded-lg hover:bg-green-700 active:bg-green-800 shadow">
                {{ editingProductId ? '更新產品' : '新增產品' }}
              </button>
              <button v-if="editingProductId" type="button" @click="cancelEditProduct" class="px-4 py-3 bg-white border border-gray-300 text-base rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            </div>
          </form>
        </div>
        <div class="w-full md:w-2/3">
          <div class="bg-white border rounded overflow-hidden max-h-60 overflow-y-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="px-4 py-2 text-left">型號</th><th class="px-4 py-2 text-left">名稱</th><th class="px-4 py-2 text-left">類型</th><th class="px-4 py-2 text-right">操作</th></tr>
              </thead>
              <tbody>
                <tr v-for="p in products" :key="p.id">
                  <td class="px-4 py-2 font-bold">{{ p.code }}</td>
                  <td class="px-4 py-2">{{ p.name }}</td>
                  <td class="px-4 py-2 text-xs"><span class="bg-green-100 text-green-800 px-2 py-1 rounded">{{ p.type }}</span></td>
                  <td class="px-4 py-3 text-right">
                    <div class="flex justify-end gap-2">
                      <button @click="startEditProduct(p)" class="px-3 py-2 bg-blue-100 text-blue-700 text-sm font-medium rounded-lg hover:bg-blue-200 active:bg-blue-300">編輯</button>
                      <button @click="deleteProduct(p.id)" class="px-3 py-2 bg-red-100 text-red-700 text-sm font-medium rounded-lg hover:bg-red-200 active:bg-red-300">刪除</button>
                    </div>
                  </td>
                </tr>
                <tr v-if="products.length === 0"><td colspan="4" class="px-4 py-4 text-center text-gray-500">尚無資料</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 4. Admin Tools -->
      <div class="border-t pt-6 mt-6">
        <h3 class="font-bold text-lg mb-4 text-gray-800">系統工具</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Sync Database -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-bold text-blue-800 mb-2">同步資料庫</h4>
            <p class="text-sm text-blue-700 mb-3">新增缺少的欄位（如簽名欄）</p>
            <button @click="adminSyncDatabase" :disabled="adminLoading"
              class="w-full bg-blue-600 text-white py-3 text-base font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 shadow disabled:opacity-50">
              {{ adminLoading ? '同步中...' : '同步資料庫' }}
            </button>
          </div>

          <!-- Fix Column Order -->
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
            <h4 class="font-bold text-orange-800 mb-2">修復欄位順序</h4>
            <p class="text-sm text-orange-700 mb-3">修正欄位順序錯亂導致的資料問題</p>
            <button @click="adminFixColumnOrder" :disabled="adminLoading"
              class="w-full bg-orange-600 text-white py-3 text-base font-medium rounded-lg hover:bg-orange-700 active:bg-orange-800 shadow disabled:opacity-50">
              {{ adminLoading ? '修復中...' : '修復欄位順序' }}
            </button>
          </div>

          <!-- Fix Signature Data -->
          <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
            <h4 class="font-bold text-pink-800 mb-2">修復簽名資料</h4>
            <p class="text-sm text-pink-700 mb-3">修復簽名資料儲存位置錯誤問題</p>
            <button @click="adminFixSignatureData" :disabled="adminLoading"
              class="w-full bg-pink-600 text-white py-3 text-base font-medium rounded-lg hover:bg-pink-700 active:bg-pink-800 shadow disabled:opacity-50">
              {{ adminLoading ? '修復中...' : '修復簽名資料' }}
            </button>
          </div>

          <!-- Generate Test Data -->
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <h4 class="font-bold text-purple-800 mb-2">產生測試資料</h4>
            <p class="text-sm text-purple-700 mb-3">產生測試資料驗證系統完整度</p>
            <button @click="adminGenerateTestData" :disabled="adminLoading"
              class="w-full bg-purple-600 text-white py-3 text-base font-medium rounded-lg hover:bg-purple-700 active:bg-purple-800 shadow disabled:opacity-50">
              {{ adminLoading ? '產生中...' : '產生測試資料' }}
            </button>
          </div>

          <!-- System Info -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <h4 class="font-bold text-gray-800 mb-2">系統資訊</h4>
            <div class="text-sm text-gray-600 space-y-1">
              <p>版本: <span class="font-mono font-bold">{{ systemVersion }}</span></p>
              <p>資料庫: Google Sheets</p>
              <p>部署: Google Apps Script</p>
            </div>
          </div>
        </div>

        <!-- Admin Result Message -->
        <div v-if="adminMessage" class="mt-4 p-3 rounded-lg" :class="adminMessageType === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
          {{ adminMessage }}
        </div>
      </div>

    </div>

    <!-- Modal: Create Work Order -->
    <div v-if="showCreateWoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
        <h3 class="text-xl font-bold mb-4">{{ editingWorkOrderId ? '編輯工單' : '建立新工單' }}</h3>
        <form @submit.prevent="submitWorkOrder" class="space-y-4">
          <!-- 1. 客戶選擇 (Radio Grid) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">客戶名稱</label>
            <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto border p-2 rounded bg-gray-50">
              <label v-for="c in customers" :key="c.id" class="cursor-pointer">
                <input type="radio" name="woCustomer" v-model="formWo.customerName" :value="c.name" class="hidden" @change="onCustomerSelect">
                <div :class="['py-2 border rounded-md text-center font-medium truncate', formWo.customerName === c.name ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-100']">
                  {{ c.name }}
                </div>
              </label>
            </div>
          </div>
          
          <!-- 2. 廠區選擇 (Radio Chips) -->
          <div v-if="formWo.customerName && customerSites.length > 0">
            <label class="block text-sm font-medium text-gray-700 mb-2">廠區</label>
            <div class="flex flex-wrap gap-2">
              <label v-for="site in customerSites" :key="site" class="cursor-pointer">
                <input type="radio" name="woSite" v-model="formWo.customerSite" :value="site" class="hidden">
                <div :class="['px-3 py-1 border rounded-md text-sm', formWo.customerSite === site ? 'bg-gray-800 text-white border-gray-800' : 'hover:bg-gray-100']">
                  {{ site }}
                </div>
              </label>
            </div>
          </div>

          <!-- 3. 產品選擇 (Radio List) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">產品型號</label>
            <div class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded bg-gray-50">
              <label v-for="p in products" :key="p.id" class="cursor-pointer block">
                <input type="radio" name="woProduct" v-model="formWo.productModel" :value="p.code" class="hidden">
                <div :class="['p-2 border rounded-md bg-white flex justify-between items-center', formWo.productModel === p.code ? 'border-green-500 bg-green-50' : 'hover:bg-gray-50']">
                  <div>
                    <div class="font-bold text-sm">{{ p.code }}</div>
                    <div class="text-xs text-gray-500">{{ p.name }}</div>
                  </div>
                  <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded">{{ p.type }}</span>
                </div>
              </label>
            </div>
          </div>
          
          <!-- 4. 工單類型 (Radio Chips) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">工單類型</label>
            <div class="flex flex-wrap gap-2">
              <label class="cursor-pointer">
                <input type="radio" name="woType" v-model="formWo.orderType" value="deglue" class="hidden" @change="formWo.sourceWorkOrderId = ''">
                <div :class="['px-3 py-2 border rounded-md text-center', formWo.orderType === 'deglue' ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-100']">
                  除膠
                </div>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="woType" v-model="formWo.orderType" value="regeneration" class="hidden">
                <div :class="['px-3 py-2 border rounded-md text-center', formWo.orderType === 'regeneration' ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-100']">
                  再生
                </div>
              </label>
              <label class="cursor-pointer">
                <input type="radio" name="woType" v-model="formWo.orderType" value="rework" class="hidden" @change="formWo.sourceWorkOrderId = ''">
                <div :class="['px-3 py-2 border rounded-md text-center', formWo.orderType === 'rework' ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-100']">
                  重工
                </div>
              </label>
            </div>
          </div>

          <!-- 4.5 來源工單選擇 (僅再生時顯示) -->
          <div v-if="formWo.orderType === 'regeneration'" class="bg-orange-50 border border-orange-200 rounded-md p-3">
            <label class="block text-sm font-medium text-orange-800 mb-2">選擇來源除膠工單</label>
            <div v-if="completedDeglueOrders.length === 0" class="text-sm text-orange-600">
              目前沒有已完成的除膠工單可供選擇
            </div>
            <div v-else class="space-y-2 max-h-40 overflow-y-auto">
              <label v-for="swo in completedDeglueOrders" :key="swo.id" class="cursor-pointer block">
                <input type="radio" name="sourceWo" v-model="formWo.sourceWorkOrderId" :value="swo.id" class="hidden" @change="onSourceWorkOrderSelect">
                <div :class="['p-2 border rounded-md bg-white', formWo.sourceWorkOrderId === swo.id ? 'border-orange-500 bg-orange-50' : 'hover:bg-gray-50']">
                  <div class="flex justify-between items-center">
                    <div>
                      <div class="font-bold text-sm">{{ swo.orderNumber }}</div>
                      <div class="text-xs text-gray-500">{{ swo.customerName }} / {{ swo.productModel }}</div>
                    </div>
                    <div class="text-xs text-green-600 font-bold">良品: {{ swo.goodQty }}</div>
                  </div>
                </div>
              </label>
            </div>
            <div v-if="formWo.sourceWorkOrderId" class="mt-2 text-xs text-gray-500">
              已選擇來源工單，客戶/產品資訊已自動帶入
            </div>
          </div>

          <!-- 5. 再生次數 (Radio Chips) -->
          <div v-if="formWo.orderType === 'regeneration'">
             <label class="block text-sm font-medium text-gray-700 mb-2">目標再生次數</label>
             <div class="flex flex-wrap gap-2">
               <label v-for="n in 10" :key="n" class="cursor-pointer">
                 <input type="radio" name="woRCount" v-model="formWo.targetRegenerationCount" :value="n" class="hidden">
                 <div :class="['w-10 h-10 flex items-center justify-center border rounded-md font-bold', formWo.targetRegenerationCount === n ? 'bg-indigo-600 text-white border-indigo-600' : 'hover:bg-gray-100']">
                   R{{ n }}
                 </div>
               </label>
             </div>
          </div>

          <!-- 6. 數量與優先級 -->
          <div class="flex space-x-2">
            <div class="w-1/2">
              <label class="block text-sm font-medium text-gray-700">數量</label>
              <input v-model.number="formWo.quantity" type="number" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
            </div>
            <div class="w-1/2">
               <label class="block text-sm font-medium text-gray-700 mb-2">優先級</label>
               <div class="flex gap-2">
                 <label class="flex-1 cursor-pointer">
                   <input type="radio" name="woPriority" v-model="formWo.priority" value="normal" class="hidden">
                   <div :class="['py-2 border rounded-md text-center', formWo.priority === 'normal' ? 'bg-green-600 text-white border-green-600' : 'hover:bg-gray-100']">
                     一般
                   </div>
                 </label>
                 <label class="flex-1 cursor-pointer">
                   <input type="radio" name="woPriority" v-model="formWo.priority" value="urgent" class="hidden">
                   <div :class="['py-2 border rounded-md text-center', formWo.priority === 'urgent' ? 'bg-red-600 text-white border-red-600' : 'hover:bg-gray-100']">
                     緊急
                   </div>
                 </label>
               </div>
            </div>
          </div>
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" @click="cancelEditWorkOrder" class="px-5 py-3 bg-white text-gray-700 text-base font-medium border border-gray-300 rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            <button type="submit" class="px-6 py-3 bg-blue-600 text-white text-base font-bold rounded-lg shadow hover:bg-blue-700 active:bg-blue-800">{{ editingWorkOrderId ? '更新工單' : '建立工單' }}</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Dispatch -->
    <div v-if="showDispatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-2">新增派工</h3>
        <p class="text-sm text-gray-500 mb-4">針對工單: {{ selectedWo?.orderNumber }}</p>
        
        <form @submit.prevent="submitDispatch" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">工作站點</label>
            <div class="grid grid-cols-2 gap-2">
              <label v-for="st in ['除膠站', '檢驗站', '包裝站', '維修站']" :key="st" class="cursor-pointer">
                <input type="radio" name="dsStation" v-model="formDispatch.stationName" :value="st" class="hidden">
                <div :class="['py-2 border rounded-md text-center', formDispatch.stationName === st ? 'bg-indigo-600 text-white border-indigo-600' : 'hover:bg-gray-100']">
                  {{ st }}
                </div>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">作業員</label>

            <!-- Radio Mode (for few operators) -->
            <div v-if="operators.length > 0 && operators.length <= 12" class="grid grid-cols-3 gap-2">
              <label v-for="op in operators" :key="op.id" class="cursor-pointer">
                <input type="radio" name="dsOperator" v-model="formDispatch.operatorName" :value="op.name" class="hidden">
                <div :class="['py-2 border rounded-md text-center text-sm font-medium truncate', formDispatch.operatorName === op.name ? 'bg-green-600 text-white border-green-600' : 'hover:bg-gray-100']">
                  {{ op.name }}
                </div>
              </label>
            </div>

            <!-- Select Mode (fallback) -->
            <select v-else v-model="formDispatch.operatorName" required class="mt-1 block w-full border border-gray-300 rounded-md p-2 bg-white">
              <option value="" disabled>-- 請選擇 --</option>
              <option v-for="op in operators" :key="op.id" :value="op.name">{{ op.name }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">派工數量</label>
            <input v-model.number="formDispatch.quantity" type="number" required class="mt-1 block w-full border border-gray-300 rounded-md p-2">
          </div>
          
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" @click="showDispatchModal = false" class="px-5 py-3 bg-white text-gray-700 text-base font-medium border border-gray-300 rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            <button type="submit" class="px-6 py-3 bg-indigo-600 text-white text-base font-bold rounded-lg shadow hover:bg-indigo-700 active:bg-indigo-800">確認派工</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Report -->
    <div v-if="showReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-2">生產回報</h3>
        <p class="text-sm text-gray-500 mb-4">派工單: {{ selectedDispatch?.dispatchNumber }}</p>
        
        <form @submit.prevent="submitReport" class="space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 text-green-700">良品數量</label>
              <input v-model.number="formReport.goodQty" type="number" min="0" class="mt-1 block w-full border border-green-300 rounded-md p-2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 text-red-700">NG 數量</label>
              <input v-model.number="formReport.ngQty" type="number" min="0" class="mt-1 block w-full border border-red-300 rounded-md p-2">
            </div>
          </div>
          <div>
             <label class="block text-sm font-medium text-gray-700">異常標記</label>
             <div class="mt-1 flex items-center">
               <input type="checkbox" v-model="formReport.hasAbnormal" class="h-4 w-4 text-red-600">
               <span class="ml-2 text-sm text-gray-600">發生異常</span>
             </div>
          </div>
          <div v-if="formReport.hasAbnormal">
            <label class="block text-sm font-medium text-gray-700">異常原因</label>
            <input v-model="formReport.abnormalType" class="mt-1 block w-full border border-gray-300 rounded-md p-2">
          </div>
          
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" @click="showReportModal = false" class="px-5 py-3 bg-white text-gray-700 text-base font-medium border border-gray-300 rounded-lg hover:bg-gray-100 active:bg-gray-200">取消</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white text-base font-bold rounded-lg shadow hover:bg-green-700 active:bg-green-800">提交報工</button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const loading = ref(false);
        const loadingCount = ref(0); // Loading 計數器
        const version = ref('');
        const currentTab = ref('work-orders');
        const workOrders = ref([]);
        const dispatches = ref([]);
        const epcHistory = ref([]);
        const reports = ref([]);
        const operators = ref([]);
        const customers = ref([]);
        const products = ref([]);
        
        // Computed
        const regenerationOrders = Vue.computed(() => workOrders.value.filter(w => w.orderType === 'regeneration'));
        // 已完成的除膠工單（可作為再生工單的來源）
        const completedDeglueOrders = Vue.computed(() => workOrders.value.filter(w => w.orderType === 'deglue' && w.status === 'completed'));
        
        // Computed for WO Form
        const customerSites = Vue.computed(() => {
          if (!formWo.value.customerName) return [];
          const cust = customers.value.find(c => c.name === formWo.value.customerName);
          if (!cust || !cust.sites) return [];
          try {
            return JSON.parse(cust.sites);
          } catch { return []; }
        });

        // Filtered outgassing tests by selected work order
        const filteredOutgassingTests = Vue.computed(() => {
          if (!formOutgassing.value.workOrderId) return outgassingTests.value;
          return outgassingTests.value.filter(t => t.workOrderId === formOutgassing.value.workOrderId);
        });

        // Modals state
        const showCreateWoModal = ref(false);
        const showDispatchModal = ref(false);
        const showReportModal = ref(false);
        
        const selectedWo = ref(null);
        const selectedDispatch = ref(null);
        const selectedEpcWo = ref(null); // Selected WO for EPC change

        // Forms
        const formWo = ref({ customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' });
        const formDispatch = ref({ stationName: '除膠站', operatorName: '', quantity: 0 });
        const formReport = ref({ goodQty: 0, ngQty: 0, hasAbnormal: false, abnormalType: '' });
        const formEpc = ref({ workOrderId: '', oldEpc: '', newEpc: '', operatorName: '' });
        const formOperator = ref({ name: '', code: '' });
        const formCustomer = ref({ name: '', code: '', sitesInput: '' }); // sitesInput: comma separated
        const formProduct = ref({ name: '', code: '', type: '10cm' });

        // Outgassing (釋氣檢驗)
        const outgassingTests = ref([]);
        const outgassingSampleInfo = ref(null);
        const formOutgassing = ref({ workOrderId: '', rfidCode: '', result: '', operatorName: '', notes: '', signature: '' });

        // Signature Pad
        const signaturePadOutgassing = ref(null);
        const signaturePadAoi = ref(null);
        const isDrawing = ref(false);
        const lastPos = ref({ x: 0, y: 0 });

        // AOI Inspection
        const aoiInspections = ref([]);
        const aoiCsvPreview = ref([]);
        const formAoi = ref({ workOrderId: '', operatorName: '' });
        const formAoiSingle = ref({ rfidCode: '', result: '', defectType: '' });

        // Editing State
        const editingOperatorId = ref(null);
        const editingCustomerId = ref(null);
        const editingProductId = ref(null);
        const editingWorkOrderId = ref(null);
        
        // Check State
        const epcCheckStatus = ref('idle');
        const epcCheckInfo = ref(null);

        // Admin Tools
        const adminLoading = ref(false);
        const adminMessage = ref('');
        const adminMessageType = ref('success');
        const systemVersion = ref('4.6.2');

        const onWoSelect = () => {
          const wo = workOrders.value.find(w => w.id === formEpc.value.workOrderId);
          selectedEpcWo.value = wo;
        };
        
        const onCustomerSelect = () => {
           // Reset site when customer changes
           formWo.value.customerSite = '';
        };

        const onSourceWorkOrderSelect = () => {
          // 選擇來源工單後，自動帶入客戶、廠區、產品資訊
          const sourceWo = workOrders.value.find(w => w.id === formWo.value.sourceWorkOrderId);
          if (sourceWo) {
            formWo.value.customerName = sourceWo.customerName;
            formWo.value.customerSite = sourceWo.customerSite || '';
            formWo.value.productModel = sourceWo.productModel;
            formWo.value.quantity = sourceWo.goodQty || sourceWo.quantity; // 使用良品數量作為預設
          }
        };
        
        // Edit Handlers
        const startEditOperator = (op) => {
          editingOperatorId.value = op.id;
          formOperator.value = { name: op.name, code: op.code };
        };
        const cancelEditOperator = () => {
          editingOperatorId.value = null;
          formOperator.value = { name: '', code: '' };
        };

        const startEditCustomer = (c) => {
          editingCustomerId.value = c.id;
          let sites = [];
          try { sites = JSON.parse(c.sites); } catch { sites = []; }
          formCustomer.value = { name: c.name, code: c.code, sitesInput: sites.join(', ') };
        };
        const cancelEditCustomer = () => {
          editingCustomerId.value = null;
          formCustomer.value = { name: '', code: '', sitesInput: '' };
        };

        const startEditProduct = (p) => {
          editingProductId.value = p.id;
          formProduct.value = { name: p.name, code: p.code, type: p.type };
        };
        const cancelEditProduct = () => {
          editingProductId.value = null;
          formProduct.value = { name: '', code: '', type: '10cm' };
        };

        const checkOldEpc = async () => {
          const epc = formEpc.value.oldEpc;
          if (!epc) return;
          
          epcCheckStatus.value = 'checking';
          epcCheckInfo.value = null;
          
          try {
            const record = await callApi('checkEpc', { epc });
            if (record) {
              epcCheckInfo.value = { 
                found: true, 
                message: `[已找到] ${record.productModel} (來自工單 ${record.orderNumber})`
              };
            } else {
              epcCheckInfo.value = { 
                found: false, 
                message: `[注意] 系統無此 EPC 紀錄 (將視為首次入站)`
              };
            }
          } catch (e) {
            console.error(e);
          } finally {
            epcCheckStatus.value = 'idle';
          }
        };

        // API Wrapper with Counter
        const callApi = (action, payload) => {
          loadingCount.value++;
          loading.value = true;
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(res => {
                loadingCount.value--;
                if (loadingCount.value <= 0) loading.value = false;
                if (res.success) resolve(res.data);
                else reject(res.error);
              })
              .withFailureHandler(err => {
                loadingCount.value--;
                if (loadingCount.value <= 0) loading.value = false;
                reject(err);
              })
              .api(action, payload);
          });
        };
        
        // 全局錯誤處理
        window.onerror = function(message, source, lineno, colno, error) {
           console.error('Global Error:', error);
           loading.value = false; // 發生錯誤時強制關閉遮罩
           loadingCount.value = 0;
        };

        const refreshData = async () => {
          try {
            // First check version
            const ver = await callApi('getVersion');
            version.value = ver;

            const [wos, ds, eh, rps, ops, custs, prods, ogTests, aoiRecs] = await Promise.all([
              callApi('getWorkOrders'),
              callApi('getDispatches'),
              callApi('getEpcHistory'),
              callApi('getReports'),
              callApi('getOperators'),
              callApi('getCustomers'),
              callApi('getProducts'),
              callApi('getOutgassingTests'),
              callApi('getAoiInspections')
            ]);
            workOrders.value = wos;
            dispatches.value = ds;
            epcHistory.value = eh;
            reports.value = rps;
            operators.value = ops;
            customers.value = custs;
            products.value = prods;
            outgassingTests.value = ogTests;
            aoiInspections.value = aoiRecs;
          } catch (e) {
            alert('載入失敗: ' + e);
          }
        };

        const submitOperator = async () => {
           try {
             if (editingOperatorId.value) {
               await callApi('updateOperator', { id: editingOperatorId.value, data: { ...formOperator.value } });
               editingOperatorId.value = null;
             } else {
               await callApi('createOperator', { ...formOperator.value });
             }
             formOperator.value = { name: '', code: '' };
             await refreshData();
           } catch (e) { alert(e); }
        };

        const deleteOperator = async (id) => {
           if (!confirm('確定要刪除此人員嗎？此操作無法復原。')) return;
           try {
             await callApi('deleteOperator', { id });
             await refreshData();
           } catch (e) { alert(e); }
        };
        
        const submitCustomer = async () => {
           try {
             const sites = formCustomer.value.sitesInput.split(/[,，\n]+/).map(s => s.trim()).filter(s => s);
             if (editingCustomerId.value) {
               await callApi('updateCustomer', { id: editingCustomerId.value, data: { name: formCustomer.value.name, code: formCustomer.value.code, sites } });
               editingCustomerId.value = null;
             } else {
               await callApi('createCustomer', { ...formCustomer.value, sites });
             }
             formCustomer.value = { name: '', code: '', sitesInput: '' };
             await refreshData();
           } catch (e) { alert(e); }
        };
        
        const deleteCustomer = async (id) => {
           if (!confirm('確定要刪除此客戶嗎？')) return;
           try { await callApi('deleteCustomer', { id }); await refreshData(); } catch (e) { alert(e); }
        };

        const submitProduct = async () => {
           try {
             if (editingProductId.value) {
               await callApi('updateProduct', { id: editingProductId.value, data: { ...formProduct.value } });
               editingProductId.value = null;
             } else {
               await callApi('createProduct', { ...formProduct.value });
             }
             formProduct.value = { name: '', code: '', type: '10cm' };
             await refreshData();
           } catch (e) { alert(e); }
        };
        
        const deleteProduct = async (id) => {
           if (!confirm('確定要刪除此產品嗎？')) return;
           try { await callApi('deleteProduct', { id }); await refreshData(); } catch (e) { alert(e); }
        };

        // Admin Functions
        const adminFixStationName = async () => {
          if (!confirm('確定要將所有「清洗站」紀錄修改為「除膠站」嗎？')) return;
          adminLoading.value = true;
          adminMessage.value = '';
          try {
            const result = await callApi('fixStationName');
            adminMessageType.value = 'success';
            adminMessage.value = `修復完成！共修正 ${result.updated} 筆紀錄`;
            await refreshData();
          } catch (e) {
            adminMessageType.value = 'error';
            adminMessage.value = '修復失敗: ' + e;
          } finally {
            adminLoading.value = false;
          }
        };

        const adminSyncDatabase = async () => {
          adminLoading.value = true;
          adminMessage.value = '';
          try {
            const result = await callApi('syncDatabase');
            adminMessageType.value = 'success';
            adminMessage.value = `資料庫同步完成！${result.message || ''}`;
          } catch (e) {
            adminMessageType.value = 'error';
            adminMessage.value = '同步失敗: ' + e;
          } finally {
            adminLoading.value = false;
          }
        };

        const adminFixColumnOrder = async () => {
          adminLoading.value = true;
          adminMessage.value = '';
          try {
            const result = await callApi('fixColumnOrder');
            adminMessageType.value = 'success';
            const fixed = result.fixed || [];
            adminMessage.value = fixed.length > 0
              ? `已修復欄位順序: ${fixed.join(', ')}`
              : '所有資料表欄位順序正確，無需修復';
            await refreshData();
          } catch (e) {
            adminMessageType.value = 'error';
            adminMessage.value = '修復失敗: ' + e;
          } finally {
            adminLoading.value = false;
          }
        };

        const adminFixSignatureData = async () => {
          adminLoading.value = true;
          adminMessage.value = '';
          try {
            const result = await callApi('fixSignatureData');
            adminMessageType.value = 'success';
            const tables = result.tables || [];
            adminMessage.value = result.fixed > 0
              ? `已修復簽名資料: ${tables.join(', ')}`
              : '所有簽名資料位置正確，無需修復';
            await refreshData();
          } catch (e) {
            adminMessageType.value = 'error';
            adminMessage.value = '修復失敗: ' + e;
          } finally {
            adminLoading.value = false;
          }
        };

        const adminGenerateTestData = async () => {
          if (!confirm('確定要產生測試資料嗎？這會新增測試用的客戶、產品、作業員、工單等資料。')) return;
          adminLoading.value = true;
          adminMessage.value = '';
          try {
            const result = await callApi('generateTestData');
            adminMessageType.value = 'success';
            adminMessage.value = `測試資料產生完成！新增 ${result.customers} 個客戶、${result.products} 個產品、${result.operators} 個作業員、${result.workOrders} 張工單、${result.dispatches} 筆派工、${result.reports} 筆報工、${result.outgassingTests} 筆釋氣檢驗、${result.aoiInspections} 筆 AOI 檢驗`;
            await refreshData();
          } catch (e) {
            adminMessageType.value = 'error';
            adminMessage.value = '產生失敗: ' + e;
          } finally {
            adminLoading.value = false;
          }
        };

        const submitEpcChange = async () => {
          try {
             if (!formEpc.value.workOrderId || !formEpc.value.newEpc || !formEpc.value.operatorName) {
               alert('請填寫所有必要欄位');
               return;
             }
             await callApi('createEpcHistory', { ...formEpc.value });
             alert('綁定成功！');
             formEpc.value.oldEpc = ''; // 清空舊 EPC
             formEpc.value.newEpc = ''; // 清空新 EPC
             epcCheckInfo.value = null; // 清空檢查訊息
             await refreshData();
          } catch (e) { alert(e); }
        };

        const submitWorkOrder = async () => {
          // 前端驗證
          if (formWo.value.orderType === 'regeneration' && !formWo.value.sourceWorkOrderId) {
            alert('再生工單必須選擇來源除膠工單'); return;
          }
          if (!formWo.value.customerName) { alert('請選擇客戶'); return; }
          if (!formWo.value.productModel) { alert('請選擇產品'); return; }
          if (!formWo.value.quantity || formWo.value.quantity <= 0) { alert('請輸入有效數量'); return; }

          // 如果是再生工單，補上來源工單編號
          const payload = { ...formWo.value };
          if (payload.orderType === 'regeneration' && payload.sourceWorkOrderId) {
            const sourceWo = workOrders.value.find(w => w.id === payload.sourceWorkOrderId);
            if (sourceWo) payload.sourceOrderNumber = sourceWo.orderNumber;
          }

          try {
            if (editingWorkOrderId.value) {
              await callApi('updateWorkOrder', { id: editingWorkOrderId.value, data: payload });
              editingWorkOrderId.value = null;
            } else {
              await callApi('createWorkOrder', payload);
            }
            showCreateWoModal.value = false;
            formWo.value = { customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' };
            await refreshData();
          } catch (e) { alert(e); }
        };

        const startEditWorkOrder = (wo) => {
          editingWorkOrderId.value = wo.id;
          formWo.value = {
            customerName: wo.customerName,
            customerSite: wo.customerSite || '',
            productModel: wo.productModel,
            quantity: wo.quantity,
            orderType: wo.orderType,
            priority: wo.priority,
            targetRegenerationCount: wo.targetRegenerationCount || 1,
            sourceWorkOrderId: wo.sourceWorkOrderId || ''
          };
          showCreateWoModal.value = true;
        };

        const cancelEditWorkOrder = () => {
          editingWorkOrderId.value = null;
          formWo.value = { customerName: '', customerSite: '', productModel: '', quantity: 10, orderType: 'deglue', priority: 'normal', targetRegenerationCount: 1, sourceWorkOrderId: '' };
          showCreateWoModal.value = false;
        };

        const deleteWorkOrder = async (id) => {
          if (!confirm('確定要取消此工單嗎？')) return;
          try {
            await callApi('deleteWorkOrder', { id });
            await refreshData();
          } catch (e) { alert(e); }
        };

        const openDispatchModal = (wo) => {
          selectedWo.value = wo;
          formDispatch.value = { 
            workOrderId: wo.id,
            stationName: '清洗站', 
            operatorName: '', 
            quantity: wo.quantity - wo.completedQty // 預設帶入剩餘數量
          };
          showDispatchModal.value = true;
        };

        const submitDispatch = async () => {
          // 前端驗證
          if (!formDispatch.value.operatorName) { alert('請選擇作業員'); return; }
          if (!formDispatch.value.quantity || formDispatch.value.quantity <= 0) { alert('請輸入有效數量'); return; }
          try {
            await callApi('createDispatch', { ...formDispatch.value });
            showDispatchModal.value = false;
            await refreshData();
            // Switch to dispatch tab to see result
            currentTab.value = 'dispatches';
          } catch (e) { alert(e); }
        };

        const deleteDispatch = async (id) => {
          if (!confirm('確定要取消此派工嗎？')) return;
          try {
            await callApi('deleteDispatch', { id });
            await refreshData();
          } catch (e) { alert(e); }
        };

        const startJob = async (d) => {
          try {
            await callApi('startDispatch', { id: d.id });
            await refreshData();
          } catch (e) { alert(e); }
        };

        const completeJob = async (d) => {
          try {
            // 先記錄結束時間
            await callApi('completeDispatch', { id: d.id });
            // 再打開報工視窗 (會自動抓取時間)
            await refreshData(); // 先重整以取得最新時間
            // 找出更新後的 dispatch 物件
            const updatedD = dispatches.value.find(x => x.id === d.id);
            openReportModal(updatedD);
          } catch (e) { alert(e); }
        };

        const openReportModal = (d) => {
          selectedDispatch.value = d;
          formReport.value = { 
            dispatchId: d.id,
            goodQty: 0, 
            ngQty: 0, 
            hasAbnormal: false, 
            abnormalType: '',
            operatorName: d.operatorName,
            stationName: d.stationName,
            // 如果有記錄實際開始時間，就用實際的；否則用現在
            startTime: d.actualStartAt || new Date().toISOString(),
            // 如果有記錄實際結束時間，就用實際的；否則用現在
            endTime: d.actualEndAt || new Date().toISOString()
          };
          showReportModal.value = true;
        };

        const submitReport = async () => {
          try {
            formReport.value.endTime = new Date().toISOString();
            formReport.value.quantity = formReport.value.goodQty + formReport.value.ngQty;
            
            await callApi('createReport', { ...formReport.value });
            showReportModal.value = false;
            await refreshData();
          } catch (e) { alert(e); }
        };

        const getStatusClass = (status) => {
          const map = {
            'draft': 'bg-gray-200 text-gray-700',
            'pending': 'bg-yellow-100 text-yellow-800',
            'in_progress': 'bg-blue-100 text-blue-800',
            'completed': 'bg-green-100 text-green-800',
            'paused': 'bg-red-100 text-red-800'
          };
          return map[status] || 'bg-gray-100';
        };

        // ========== 簽名板功能 ==========
        const getSignatureCanvas = (type) => {
          return type === 'outgassing' ? signaturePadOutgassing.value : signaturePadAoi.value;
        };

        const startSign = (e, type) => {
          const canvas = getSignatureCanvas(type);
          if (!canvas) return;
          isDrawing.value = true;
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches ? e.touches[0] : e;
          lastPos.value = {
            x: (touch.clientX - rect.left) * (canvas.width / rect.width),
            y: (touch.clientY - rect.top) * (canvas.height / rect.height)
          };
        };

        const drawSign = (e, type) => {
          if (!isDrawing.value) return;
          const canvas = getSignatureCanvas(type);
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          const rect = canvas.getBoundingClientRect();
          const touch = e.touches ? e.touches[0] : e;
          const pos = {
            x: (touch.clientX - rect.left) * (canvas.width / rect.width),
            y: (touch.clientY - rect.top) * (canvas.height / rect.height)
          };
          ctx.beginPath();
          ctx.moveTo(lastPos.value.x, lastPos.value.y);
          ctx.lineTo(pos.x, pos.y);
          ctx.strokeStyle = '#1e3a5f';
          ctx.lineWidth = 2;
          ctx.lineCap = 'round';
          ctx.stroke();
          lastPos.value = pos;
        };

        const endSign = (type) => {
          isDrawing.value = false;
          // Save signature to form
          const canvas = getSignatureCanvas(type);
          if (canvas) {
            const dataUrl = canvas.toDataURL('image/png');
            if (type === 'outgassing') {
              formOutgassing.value.signature = dataUrl;
            } else {
              formAoiSingle.value.signature = dataUrl;
            }
          }
        };

        const clearSignature = (type) => {
          const canvas = getSignatureCanvas(type);
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (type === 'outgassing') {
            formOutgassing.value.signature = '';
          } else {
            formAoiSingle.value.signature = '';
          }
        };

        // ========== 釋氣檢驗 ==========
        const loadOutgassingSampleInfo = async () => {
          if (!formOutgassing.value.workOrderId) {
            outgassingSampleInfo.value = null;
            return;
          }
          try {
            const info = await callApi('getOutgassingSampleInfo', { workOrderId: formOutgassing.value.workOrderId });
            outgassingSampleInfo.value = info;
          } catch (e) {
            console.error(e);
          }
        };

        const submitOutgassingTest = async () => {
          if (!formOutgassing.value.workOrderId) { alert('請選擇工單'); return; }
          if (!formOutgassing.value.result) { alert('請選擇檢驗結果'); return; }
          if (!formOutgassing.value.operatorName) { alert('請選擇檢驗員'); return; }

          try {
            await callApi('createOutgassingTest', { ...formOutgassing.value });

            // 規則提示: NG 時需加抽 2 片
            if (formOutgassing.value.result === 'NG') {
              alert('檢驗結果: NG\n\n依規定需加抽 2 片再測，若仍超標則回爐重烤。');
            }

            formOutgassing.value.rfidCode = '';
            formOutgassing.value.result = '';
            formOutgassing.value.notes = '';
            formOutgassing.value.signature = '';
            clearSignature('outgassing');
            await refreshData();
            await loadOutgassingSampleInfo();
          } catch (e) { alert(e); }
        };

        // 產生品檢報告
        const generateOutgassingReport = () => {
          if (!formOutgassing.value.workOrderId) { alert('請先選擇工單'); return; }
          const wo = workOrders.value.find(w => w.id === formOutgassing.value.workOrderId);
          const tests = outgassingTests.value.filter(t => t.workOrderId === formOutgassing.value.workOrderId);
          const info = outgassingSampleInfo.value;

          if (!wo || tests.length === 0) { alert('無檢驗資料可產生報告'); return; }

          // 取得最後一筆有簽名的檢驗紀錄
          const lastTestWithSig = [...tests].reverse().find(t => t.signature);
          const lastSignature = lastTestWithSig?.signature || '';

          const reportHtml = `
<!DOCTYPE html>
<html><head>
  <meta charset="UTF-8">
  <title>釋氣檢驗報告 - ${wo.orderNumber}</title>
  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
    .header h1 { margin: 0; font-size: 24px; }
    .header p { margin: 5px 0; color: #666; }
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .info-item { padding: 8px; background: #f5f5f5; border-radius: 4px; }
    .info-item label { font-size: 12px; color: #666; display: block; }
    .info-item span { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background: #f0f0f0; font-weight: bold; }
    .pass { color: green; font-weight: bold; }
    .ng { color: red; font-weight: bold; }
    .summary { background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0; }
    .summary.warning { background: #fff3e0; }
    .signature-section { margin-top: 30px; display: flex; justify-content: flex-end; }
    .signature-box { text-align: center; }
    .signature-box img { max-height: 80px; border-bottom: 1px solid #333; }
    .signature-box p { margin: 5px 0 0; font-size: 12px; }
    .footer { margin-top: 40px; text-align: center; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 10px; }
    @media print { body { padding: 0; } .no-print { display: none; } }
  </style>
</head><body>
  <div class="header">
    <h1>釋氣檢驗報告</h1>
    <p>Outgassing Inspection Report</p>
  </div>

  <div class="info-grid">
    <div class="info-item"><label>工單編號</label><span>${wo.orderNumber}</span></div>
    <div class="info-item"><label>客戶</label><span>${wo.customerName} / ${wo.customerSite || '-'}</span></div>
    <div class="info-item"><label>產品型號</label><span>${wo.productModel}</span></div>
    <div class="info-item"><label>工單數量</label><span>${info?.totalQty || wo.quantity} 片</span></div>
    <div class="info-item"><label>抽樣規則</label><span>18 抽 1 (5.56%)</span></div>
    <div class="info-item"><label>報告日期</label><span>${new Date().toLocaleDateString('zh-TW')}</span></div>
  </div>

  <h3>檢驗結果明細</h3>
  <table>
    <thead>
      <tr><th>序號</th><th>檢驗單號</th><th>條碼</th><th>結果</th><th>備註</th><th>檢驗員</th><th>時間</th></tr>
    </thead>
    <tbody>
      ${tests.map((t, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${t.testNumber || '-'}</td>
          <td>${t.rfidCode || '-'}</td>
          <td class="${t.result === 'PASS' ? 'pass' : 'ng'}">${t.result}</td>
          <td>${t.notes || '-'}</td>
          <td>${t.operatorName || '-'}</td>
          <td>${t.testedAt ? new Date(t.testedAt).toLocaleString('zh-TW') : '-'}</td>
        </tr>
      `).join('')}
    </tbody>
  </table>

  <div class="summary ${info?.passRate < 100 ? 'warning' : ''}">
    <strong>檢驗摘要</strong><br>
    已檢驗: ${info?.testedCount || tests.length} 片 / 需抽樣: ${info?.requiredSamples || '-'} 片<br>
    合格: ${info?.passCount || tests.filter(t => t.result === 'PASS').length} 片 |
    不合格: ${info?.failCount || tests.filter(t => t.result === 'NG').length} 片<br>
    <strong>合格率: ${info?.passRate || Math.round(tests.filter(t => t.result === 'PASS').length / tests.length * 100)}%</strong>
  </div>

  <div class="signature-section">
    <div class="signature-box">
      ${lastSignature ? `<img src="${lastSignature}" alt="簽名">` : '<div style="width:150px;height:60px;border-bottom:1px solid #333;"></div>'}
      <p>品檢人員簽名</p>
    </div>
  </div>

  <div class="footer">
    SMAI-MES 品質管理系統 | 報告產生時間: ${new Date().toLocaleString('zh-TW')} | v${systemVersion.value}
  </div>

  <div class="no-print" style="margin-top:20px;text-align:center;">
    <button onclick="window.print()" style="padding:10px 30px;font-size:16px;cursor:pointer;">列印報告</button>
  </div>
</body></html>`;

          // Open in new window
          const reportWindow = window.open('', '_blank');
          reportWindow.document.write(reportHtml);
          reportWindow.document.close();
        };

        // ========== AOI 檢驗 ==========
        const handleAoiCsvFile = (event) => {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const text = e.target.result;
            const lines = text.split('\n').filter(l => l.trim());
            if (lines.length < 2) {
              alert('CSV 檔案格式錯誤或無資料');
              return;
            }

            // Parse header
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
              const values = lines[i].split(',').map(v => v.trim());
              const row = {};
              headers.forEach((h, idx) => {
                // Map common header names (支援 Barcode/條碼/RFID)
                if (h.toLowerCase().includes('barcode') || h.toLowerCase().includes('rfid') || h === '條碼' || h === '條碼編號') row.rfidCode = values[idx];
                else if (h.toLowerCase().includes('result') || h === '結果') row.result = (values[idx] || '').toUpperCase() === 'PASS' ? 'PASS' : 'NG';
                else if (h.toLowerCase().includes('defect') && h.toLowerCase().includes('type') || h === '缺陷類型') row.defectType = values[idx];
                else if (h.toLowerCase().includes('defect') && h.toLowerCase().includes('count') || h === '缺陷數量') row.defectCount = Number(values[idx]) || 0;
              });
              if (row.rfidCode) rows.push(row);
            }

            aoiCsvPreview.value = rows;
          };
          reader.readAsText(file);
        };

        const submitAoiImport = async () => {
          if (!formAoi.value.workOrderId) { alert('請選擇工單'); return; }
          if (!formAoi.value.operatorName) { alert('請選擇匯入人員'); return; }
          if (aoiCsvPreview.value.length === 0) { alert('請先選擇 CSV 檔案'); return; }

          try {
            const result = await callApi('importAoiCsv', {
              workOrderId: formAoi.value.workOrderId,
              csvRows: aoiCsvPreview.value,
              operatorName: formAoi.value.operatorName
            });

            alert(`匯入完成！\n成功: ${result.success} 筆\n失敗: ${result.failed} 筆`);
            aoiCsvPreview.value = [];
            await refreshData();
          } catch (e) { alert(e); }
        };

        const submitSingleAoi = async () => {
          if (!formAoi.value.workOrderId) { alert('請先在上方選擇工單'); return; }
          if (!formAoiSingle.value.rfidCode) { alert('請輸入條碼編號'); return; }
          if (!formAoiSingle.value.result) { alert('請選擇檢驗結果'); return; }

          try {
            await callApi('createAoiInspection', {
              workOrderId: formAoi.value.workOrderId,
              operatorName: formAoi.value.operatorName || '系統',
              ...formAoiSingle.value
            });

            // 破洞/嚴重瑕疵提示
            if (formAoiSingle.value.result === 'NG' &&
                (formAoiSingle.value.defectType || '').includes('破洞')) {
              alert('嚴重瑕疵: 破洞\n此件須直接報廢處理。');
            }

            formAoiSingle.value = { rfidCode: '', result: '', defectType: '' };
            await refreshData();
          } catch (e) { alert(e); }
        };

        onMounted(() => {
          // 初始化載入
          refreshData();
        });

        return {
          loading, version, currentTab, workOrders, dispatches, reports,
          showCreateWoModal, showDispatchModal, showReportModal,
          selectedWo, selectedDispatch, selectedEpcWo,
          formWo, formDispatch, formReport, formEpc, formOperator, formCustomer, formProduct,
          editingOperatorId, editingCustomerId, editingProductId, editingWorkOrderId,
          regenerationOrders, completedDeglueOrders, epcHistory, operators, customers, products, customerSites, epcCheckStatus, epcCheckInfo,
          refreshData, submitWorkOrder, openDispatchModal, submitDispatch, openReportModal, submitReport,
          startEditWorkOrder, cancelEditWorkOrder, deleteWorkOrder, deleteDispatch,
          submitEpcChange, onWoSelect, onCustomerSelect, onSourceWorkOrderSelect, checkOldEpc,
          submitOperator, deleteOperator, startEditOperator, cancelEditOperator,
          submitCustomer, deleteCustomer, startEditCustomer, cancelEditCustomer,
          submitProduct, deleteProduct, startEditProduct, cancelEditProduct,
          startJob, completeJob,
          getStatusClass,
          // Signature Pad
          signaturePadOutgassing, signaturePadAoi, startSign, drawSign, endSign, clearSignature,
          // Outgassing
          outgassingTests, outgassingSampleInfo, formOutgassing, filteredOutgassingTests,
          loadOutgassingSampleInfo, submitOutgassingTest, generateOutgassingReport,
          // AOI
          aoiInspections, aoiCsvPreview, formAoi, formAoiSingle,
          handleAoiCsvFile, submitAoiImport, submitSingleAoi,
          // Admin
          adminLoading, adminMessage, adminMessageType, systemVersion,
          adminFixStationName, adminGenerateTestData, adminSyncDatabase, adminFixColumnOrder, adminFixSignatureData
        };
      }
    }).mount('#app');
  </script>
</body>
</html>