<!DOCTYPE html>
<html data-theme="light">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <?!= include('styles'); ?>
</head>
<body>
  <div id="app">

    <!-- Loading Overlay -->
    <div v-if="loading" class="loading-overlay">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <div style="font-weight: 600; color: #667eea;">{{ loadingMessage || '載入中...' }}</div>
    </div>

    <!-- Header -->
    <header class="header-card">
      <div>
        <h1>SMAI - MES</h1>
        <div class="system-info-trigger">
          <span class="trigger-text">Plan B 應急作業模式</span>
          <span class="version-badge" @click="showChangelogModal = true" style="cursor: pointer;" title="點擊查看更新歷程">v{{ version || '...' }}</span>
          <span v-if="currentOperator" class="admin-badge">{{ currentOperator.name }} ({{ currentOperator.role || 'operator' }})</span>
          <span class="trigger-quote">"Because Plan A needs 7 more months"</span>

          <!-- 賽博龐克 Tooltip -->
          <div class="cyber-tooltip">
            <div class="cyber-header">
              <div class="cyber-title">SMAI-EMERGENCY LITE</div>
              <div class="cyber-subtitle">Strategic Manufacturing AI - Improvised Countermeasure Division</div>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-desc">
              <span class="cyber-label">SYSTEM DESIGNATION:</span>
              「七個月技術真空期」緊急應變作戰方案<br>
              <span style="color: #666; font-size: 11px;">非正式、臨時性、純手工刻製之極限生存自動化數據矩陣</span>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-countdown-container">
              <div class="cyber-label">PLAN A DELIVERY COUNTDOWN</div>
              <div class="cyber-countdown">
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-days">---</span>
                  <span class="countdown-label">DAYS</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-hours">--</span>
                  <span class="countdown-label">HRS</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-mins">--</span>
                  <span class="countdown-label">MIN</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-secs">--</span>
                  <span class="countdown-label">SEC</span>
                </div>
                <div class="countdown-separator">.</div>
                <div class="countdown-block countdown-ms">
                  <span class="countdown-value" id="countdown-ms">---</span>
                  <span class="countdown-label">MS</span>
                </div>
              </div>
              <div class="cyber-target">TARGET: 2026/08/01 00:00:00 TST</div>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-footer">
              <div class="cyber-status">
                <span class="status-dot"></span>
                PLAN B SYSTEM ACTIVE
              </div>
              <div class="cyber-note">* 此為第三代重構版本 (Vite → Angular → GAS)</div>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <!-- 操作人員選擇器 (ISO 27001) -->
        <div class="operator-selector" @click="showOperatorSelector = true">
          <i data-lucide="user-circle" class="w-4 h-4"></i>
          <span v-if="currentOperator">{{ currentOperator.name }}</span>
          <span v-else class="operator-placeholder">請選擇操作人員</span>
          <i data-lucide="chevron-down" class="w-3 h-3"></i>
        </div>
        <button class="btn btn-ghost" @click="openShareModal">
          <i data-lucide="share-2" class="w-4 h-4"></i>
          分享
        </button>
        <button class="btn btn-primary" @click="forceRefresh">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          重新整理
        </button>
      </div>
    </header>

    <!-- 操作人員選擇 Modal -->
    <div v-if="showOperatorSelector" class="modal-overlay" @click.self="showOperatorSelector = false">
      <div class="modal-box" style="max-width: 400px;">
        <div class="modal-header">
          <h3>選擇操作人員</h3>
          <button class="btn btn-sm btn-ghost" @click="showOperatorSelector = false">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="modal-body">
          <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">
            <i data-lucide="shield-check" class="w-4 h-4" style="display: inline; vertical-align: middle;"></i>
            操作紀錄將記錄至系統日誌 (ISO 27001)
          </p>
          <div class="operator-list">
            <div v-for="op in operators" :key="op.id"
                 :class="['operator-item', currentOperator?.id === op.id ? 'selected' : '']"
                 @click="selectOperator(op)">
              <div class="operator-name">
                {{ op.name }}
                <i v-if="op.pin" data-lucide="lock" class="w-3 h-3" style="display: inline; vertical-align: middle; margin-left: 0.25rem; color: #94a3b8;"></i>
              </div>
              <div class="operator-code">{{ op.code || '-' }}</div>
            </div>
            <div v-if="operators.length === 0" class="empty-state" style="padding: 2rem;">
              尚無人員資料，請先至設定頁新增
            </div>
          </div>
          <div v-if="currentOperator" style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-ghost btn-sm" @click="clearOperator">
              <i data-lucide="log-out" class="w-4 h-4"></i>
              登出操作人員
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PIN 輸入 Modal -->
    <div v-if="showPinModal" class="modal-overlay">
      <div class="modal-box" style="max-width: 320px;">
        <div class="modal-header">
          <h3>輸入 PIN 碼</h3>
          <button class="btn btn-sm btn-ghost" @click="cancelPinEntry">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="modal-body" style="text-align: center;">
          <p style="margin-bottom: 1rem; color: #64748b;">
            切換至 <strong>{{ pendingOperator?.name }}</strong> 需要輸入 PIN 碼
          </p>
          <input type="password" class="input input-bordered w-full"
                 v-model="pinInput"
                 placeholder="請輸入 4 位數 PIN"
                 maxlength="4"
                 pattern="[0-9]*"
                 inputmode="numeric"
                 @keyup.enter="verifyPin"
                 style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;">
          <p v-if="pinError" style="color: #ef4444; margin-top: 0.5rem; font-size: 0.875rem;">{{ pinError }}</p>
          <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-ghost flex-1" @click="cancelPinEntry">取消</button>
            <button class="btn btn-primary flex-1" @click="verifyPin">確認</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 更新歷程 Modal -->
    <div v-if="showChangelogModal" class="modal-overlay" @click.self="showChangelogModal = false">
      <div class="modal-box" style="max-width: 500px; max-height: 80vh;">
        <div class="modal-header">
          <h3>更新歷程</h3>
          <button class="btn btn-sm btn-ghost" @click="showChangelogModal = false">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="modal-body" style="overflow-y: auto; max-height: 60vh;">
          <div class="changelog-container">
            <div class="changelog-item" style="border-left: 3px solid #22c55e;">
              <div class="changelog-version" style="color: #16a34a;">v5.48.4</div>
              <div class="changelog-date">2026-01-11</div>
              <ul class="changelog-list">
                <li><span class="changelog-tag refactor">UX</span>操作紀錄變更內容中文化顯示</li>
              </ul>
            </div>
            <div class="changelog-item">
              <div class="changelog-version">v5.48.3</div>
              <div class="changelog-date">2026-01-11</div>
              <ul class="changelog-list">
                <li><span class="changelog-tag feat">NEW</span>行政角色：人員/客戶/產品/物料/倉儲盤點</li>
                <li><span class="changelog-tag feat">UX</span>點版本號查看更新歷程</li>
                <li><span class="changelog-tag refactor">UX</span>操作紀錄欄位名稱優化</li>
              </ul>
            </div>
            <div class="changelog-item">
              <div class="changelog-version">v5.48.2</div>
              <div class="changelog-date">2026-01-11</div>
              <ul class="changelog-list">
                <li><span class="changelog-tag refactor">UX</span>同步資料庫按鈕整合三項功能</li>
              </ul>
            </div>
            <div class="changelog-item">
              <div class="changelog-version">v5.48.1</div>
              <div class="changelog-date">2026-01-11</div>
              <ul class="changelog-list">
                <li><span class="changelog-tag feat">NEW</span>PIN 碼驗證保護帳號切換</li>
              </ul>
            </div>
            <div class="changelog-item">
              <div class="changelog-version">v5.48.0</div>
              <div class="changelog-date">2026-01-11</div>
              <ul class="changelog-list">
                <li><span class="changelog-tag feat">NEW</span>6 種角色權限系統</li>
              </ul>
            </div>
          </div>
          <p v-if="hasPermission('settings')" style="margin-top: 1rem; font-size: 0.85rem; color: #64748b; text-align: center;">
            完整歷程請至「設定」頁籤查看
          </p>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-card">
      <!-- Tabs Navigation (依角色權限顯示) -->
      <div class="tabs-nav">
        <a v-if="hasPermission('dashboard')" href="#" :class="['nav-tab', currentTab === 'dashboard' ? 'active' : '']" @click.prevent="currentTab = 'dashboard'"><span>戰情中心</span></a>
        <a v-if="hasPermission('work-orders') || hasPermission('work-orders-view')" href="#" :class="['nav-tab', currentTab === 'work-orders' ? 'active' : '']" @click.prevent="currentTab = 'work-orders'"><span>{{ canManage ? '工單管理' : '工單查看' }}</span></a>
        <a v-if="hasPermission('dispatches')" href="#" :class="['nav-tab', currentTab === 'dispatches' ? 'active' : '']" @click.prevent="currentTab = 'dispatches'"><span>現場派工</span></a>
        <a v-if="hasPermission('reports')" href="#" :class="['nav-tab', currentTab === 'reports' ? 'active' : '']" @click.prevent="currentTab = 'reports'"><span>報工紀錄</span></a>
        <a v-if="hasPermission('outgassing')" href="#" :class="['nav-tab', currentTab === 'outgassing' ? 'active' : '']" @click.prevent="currentTab = 'outgassing'"><span>釋氣檢驗</span></a>
        <a v-if="hasPermission('aoi')" href="#" :class="['nav-tab', currentTab === 'aoi' ? 'active' : '']" @click.prevent="currentTab = 'aoi'"><span>AOI 檢驗</span></a>
        <a v-if="hasPermission('r0')" href="#" :class="['nav-tab', currentTab === 'r0' ? 'active' : '']" @click.prevent="currentTab = 'r0'"><span>標籤管理</span></a>
        <a v-if="hasPermission('label-editor')" href="#" :class="['nav-tab', currentTab === 'label-editor' ? 'active' : '']" @click.prevent="currentTab = 'label-editor'"><span>樣式設計</span></a>
        <a v-if="hasPermission('schedule')" href="#" :class="['nav-tab', currentTab === 'schedule' ? 'active' : '']" @click.prevent="currentTab = 'schedule'"><span>排程管理</span></a>
        <a v-if="hasPermission('oven')" href="#" :class="['nav-tab', currentTab === 'oven' ? 'active' : '']" @click.prevent="currentTab = 'oven'"><span>烘箱監控</span></a>
        <a v-if="hasPermission('wms')" href="#" :class="['nav-tab', currentTab === 'wms' ? 'active' : '']" @click.prevent="currentTab = 'wms'"><span>{{ canSupervise ? '倉儲管理' : '倉儲操作' }}</span></a>
        <a v-if="hasPermission('parts')" href="#" :class="['nav-tab', currentTab === 'parts' ? 'active' : '']" @click.prevent="currentTab = 'parts'"><span>物料主檔</span></a>
        <a v-if="hasPermission('audit')" href="#" :class="['nav-tab', currentTab === 'audit' ? 'active' : '']" @click.prevent="currentTab = 'audit'; loadAuditLogs()"><span>操作紀錄</span></a>
        <a v-if="hasPermission('settings')" href="#" :class="['nav-tab', currentTab === 'settings' ? 'active' : '']" @click.prevent="currentTab = 'settings'"><span>設定</span></a>
      </div>

      <!-- Tab Panels -->
      <div class="tab-content">
        <?!= include('tab-dashboard'); ?>
        <?!= include('tab-work-orders'); ?>
        <?!= include('tab-dispatches'); ?>
        <?!= include('tab-reports'); ?>
        <?!= include('tab-outgassing'); ?>
        <?!= include('tab-aoi'); ?>
        <?!= include('tab-r0'); ?>
        <?!= include('tab-label-editor'); ?>
        <?!= include('tab-schedule'); ?>
        <?!= include('tab-oven'); ?>
        <?!= include('tab-wms'); ?>
        <?!= include('tab-parts'); ?>
        <?!= include('tab-audit'); ?>
        <?!= include('tab-settings'); ?>
      </div>
    </div>

    <!-- Modals -->
    <?!= include('modals'); ?>

  </div>

  <?!= include('app'); ?>
</body>
</html>
