<!DOCTYPE html>
<html data-theme="light">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <?!= include('styles'); ?>
</head>
<body>
  <div id="app">

    <!-- Loading Overlay -->
    <div v-if="loading" class="loading-overlay">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <div style="font-weight: 600; color: #667eea;">{{ loadingMessage || '載入中...' }}</div>
    </div>

    <!-- Header -->
    <header class="header-card">
      <div>
        <h1>SMAI - MES 線外表單</h1>
        <div class="system-info-trigger">
          <span class="trigger-text">Plan B 應急作業模式</span>
          <span class="version-badge">v{{ version || '...' }}</span>
          <span class="trigger-quote">"Because Plan A needs 7 more months"</span>

          <!-- 賽博龐克 Tooltip -->
          <div class="cyber-tooltip">
            <div class="cyber-header">
              <div class="cyber-title">SMAI-EMERGENCY LITE</div>
              <div class="cyber-subtitle">Strategic Manufacturing AI - Improvised Countermeasure Division</div>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-desc">
              <span class="cyber-label">SYSTEM DESIGNATION:</span>
              「七個月技術真空期」緊急應變作戰方案<br>
              <span style="color: #666; font-size: 11px;">非正式、臨時性、純手工刻製之極限生存自動化數據矩陣</span>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-countdown-container">
              <div class="cyber-label">PLAN A DELIVERY COUNTDOWN</div>
              <div class="cyber-countdown">
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-days">---</span>
                  <span class="countdown-label">DAYS</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-hours">--</span>
                  <span class="countdown-label">HRS</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-mins">--</span>
                  <span class="countdown-label">MIN</span>
                </div>
                <div class="countdown-separator">:</div>
                <div class="countdown-block">
                  <span class="countdown-value" id="countdown-secs">--</span>
                  <span class="countdown-label">SEC</span>
                </div>
                <div class="countdown-separator">.</div>
                <div class="countdown-block countdown-ms">
                  <span class="countdown-value" id="countdown-ms">---</span>
                  <span class="countdown-label">MS</span>
                </div>
              </div>
              <div class="cyber-target">TARGET: 2026/08/01 00:00:00 TST</div>
            </div>

            <div class="cyber-divider"></div>

            <div class="cyber-footer">
              <div class="cyber-status">
                <span class="status-dot"></span>
                PLAN B SYSTEM ACTIVE
              </div>
              <div class="cyber-note">* 此為第三代重構版本 (Vite → Angular → GAS)</div>
            </div>
          </div>
        </div>
      </div>
      <div style="display: flex; gap: 0.5rem; align-items: center;">
        <!-- 操作人員選擇器 (ISO 27001) -->
        <div class="operator-selector" @click="showOperatorSelector = true">
          <i data-lucide="user-circle" class="w-4 h-4"></i>
          <span v-if="currentOperator">{{ currentOperator.name }}</span>
          <span v-else class="operator-placeholder">請選擇操作人員</span>
          <i data-lucide="chevron-down" class="w-3 h-3"></i>
        </div>
        <button class="btn btn-ghost" @click="openShareModal">
          <i data-lucide="share-2" class="w-4 h-4"></i>
          分享
        </button>
        <button class="btn btn-primary" @click="forceRefresh">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i>
          重新整理
        </button>
      </div>
    </header>

    <!-- 操作人員選擇 Modal -->
    <div v-if="showOperatorSelector" class="modal-overlay" @click.self="showOperatorSelector = false">
      <div class="modal-box" style="max-width: 400px;">
        <div class="modal-header">
          <h3>選擇操作人員</h3>
          <button class="btn btn-sm btn-ghost" @click="showOperatorSelector = false">
            <i data-lucide="x" class="w-4 h-4"></i>
          </button>
        </div>
        <div class="modal-body">
          <p style="color: #64748b; font-size: 0.85rem; margin-bottom: 1rem;">
            <i data-lucide="shield-check" class="w-4 h-4" style="display: inline; vertical-align: middle;"></i>
            操作紀錄將記錄至系統日誌 (ISO 27001)
          </p>
          <div class="operator-list">
            <div v-for="op in operators" :key="op.id"
                 :class="['operator-item', currentOperator?.id === op.id ? 'selected' : '']"
                 @click="selectOperator(op)">
              <div class="operator-name">{{ op.name }}</div>
              <div class="operator-code">{{ op.code || '-' }}</div>
            </div>
            <div v-if="operators.length === 0" class="empty-state" style="padding: 2rem;">
              尚無人員資料，請先至設定頁新增
            </div>
          </div>
          <div v-if="currentOperator" style="margin-top: 1rem; text-align: center;">
            <button class="btn btn-ghost btn-sm" @click="clearOperator">
              <i data-lucide="log-out" class="w-4 h-4"></i>
              登出操作人員
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="content-card">
      <!-- Tabs Navigation -->
      <div class="tabs-nav">
        <a href="#" :class="['nav-tab', currentTab === 'schedule' ? 'active' : '']" @click.prevent="currentTab = 'schedule'"><span>排程看板</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'work-orders' ? 'active' : '']" @click.prevent="currentTab = 'work-orders'"><span>工單管理</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'dispatches' ? 'active' : '']" @click.prevent="currentTab = 'dispatches'"><span>現場派工</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'reports' ? 'active' : '']" @click.prevent="currentTab = 'reports'"><span>報工紀錄</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'outgassing' ? 'active' : '']" @click.prevent="currentTab = 'outgassing'"><span>釋氣檢驗</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'aoi' ? 'active' : '']" @click.prevent="currentTab = 'aoi'"><span>AOI 檢驗</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'r0' ? 'active' : '']" @click.prevent="currentTab = 'r0'"><span>標籤管理</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'label-editor' ? 'active' : '']" @click.prevent="currentTab = 'label-editor'"><span>樣式設計</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'oven' ? 'active' : '']" @click.prevent="currentTab = 'oven'"><span>烘箱監控</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'wms' ? 'active' : '']" @click.prevent="currentTab = 'wms'"><span>倉儲管理</span></a>
        <a href="#" :class="['nav-tab', currentTab === 'settings' ? 'active' : '']" @click.prevent="currentTab = 'settings'"><span>設定</span></a>
      </div>

      <!-- Tab Panels -->
      <div class="tab-content">
        <?!= include('tab-schedule'); ?>
        <?!= include('tab-work-orders'); ?>
        <?!= include('tab-dispatches'); ?>
        <?!= include('tab-reports'); ?>
        <?!= include('tab-outgassing'); ?>
        <?!= include('tab-aoi'); ?>
        <?!= include('tab-r0'); ?>
        <?!= include('tab-label-editor'); ?>
        <?!= include('tab-oven'); ?>
        <?!= include('tab-wms'); ?>
        <?!= include('tab-settings'); ?>
      </div>
    </div>

    <!-- Modals -->
    <?!= include('modals'); ?>

  </div>

  <?!= include('app'); ?>
</body>
</html>
