<!-- Tab: Dispatches -->
<div v-show="currentTab === 'dispatches'">
  <div class="section-header">
    <h2>現場派工任務</h2>
  </div>

  <div class="card-grid">
    <div v-for="d in dispatches" :key="d.id" class="dispatch-card">
      <div class="card-header">
        <div>
          <div class="dispatch-number">{{ d.dispatchNumber }}</div>
          <div style="font-size: 0.75rem; color: #94a3b8;">
            {{ workOrders.find(w => w.id === d.workOrderId)?.orderNumber || '-' }}
          </div>
        </div>
        <span :class="'status-badge status-' + d.status">
          {{ { pending: '待開始', in_progress: '作業中', completed: '已完成' }[d.status] || d.status }}
        </span>
      </div>

      <div class="station-name">{{ d.stationName }}</div>
      <div class="operator">操作員: {{ d.operatorName }}</div>

      <div class="progress-section">
        <div class="progress-info">
          <span>目標: {{ d.quantity }}</span>
          <span>良品: {{ d.goodQty }}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" :style="{ width: Math.min((d.completedQty / d.quantity) * 100, 100) + '%' }"></div>
        </div>
        <div v-if="d.actualStartAt" style="margin-top: 0.5rem; font-size: 0.75rem; color: #667eea; font-family: monospace;">
          開始: {{ new Date(d.actualStartAt).toLocaleString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }}
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <button v-if="d.status === 'pending'" class="btn btn-primary w-full" @click="startJob(d)">
          <i data-lucide="play" class="w-4 h-4"></i>
          開始作業
        </button>

        <button v-if="d.status === 'in_progress'" class="btn btn-success w-full" @click="completeJob(d)">
          <i data-lucide="check" class="w-4 h-4"></i>
          完成並報工
        </button>

        <button v-if="d.status === 'completed'" class="btn btn-ghost w-full" disabled>
          已完成
        </button>

        <button v-if="d.status === 'pending'" class="btn btn-sm btn-outline btn-error w-full" @click="deleteDispatch(d.id)">
          取消派工
        </button>
      </div>
    </div>
  </div>

  <div v-if="dispatches.length === 0" class="empty-state">
    <i data-lucide="clipboard-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
    <div>暫無派工任務，請從工單頁面進行派工。</div>
  </div>
</div>
