<!-- Tab: Dispatches -->
<div v-show="currentTab === 'dispatches'">
  <div class="section-header">
    <h2>現場派工任務</h2>
  </div>

  <div class="card-grid">
    <div v-for="d in dispatches" :key="d.id" class="dispatch-card">
      <div class="card-header">
        <div>
          <div class="dispatch-number">{{ d.dispatchNumber }}</div>
          <div style="font-size: 0.75rem; color: #94a3b8;">
            {{ workOrders.find(w => w.id === d.workOrderId)?.orderNumber || '-' }}
          </div>
        </div>
        <span :class="'status-badge status-' + d.status">
          {{ { pending: '待開始', in_progress: '作業中', completed: '已完成' }[d.status] || d.status }}
        </span>
      </div>

      <div class="station-name">{{ d.stationName }}</div>
      <div class="operator">操作員: {{ d.operatorName }}</div>

      <div class="progress-section">
        <div class="progress-info">
          <span>目標: {{ d.quantity }}</span>
          <span>良品: {{ d.goodQty }}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" :style="{ width: Math.min((d.completedQty / d.quantity) * 100, 100) + '%' }"></div>
        </div>
        <div v-if="d.actualStartAt" style="margin-top: 0.5rem; font-size: 0.75rem; color: #667eea; font-family: monospace;">
          開始: {{ new Date(d.actualStartAt).toLocaleString('zh-TW', {hour:'2-digit', minute:'2-digit'}) }}
        </div>
      </div>

      <!-- 待開始狀態：開始 + 取消 並列 -->
      <div v-if="d.status === 'pending'" class="flex gap-2">
        <button class="btn btn-primary flex-1" @click="startJob(d)">
          <i data-lucide="play" class="w-4 h-4"></i>
          開始作業
        </button>
        <button class="btn btn-outline btn-error flex-1" @click="deleteDispatch(d.id)">
          <i data-lucide="x" class="w-4 h-4"></i>
          取消
        </button>
      </div>

      <!-- 作業中狀態 -->
      <div v-if="d.status === 'in_progress'" class="flex flex-col gap-2">
        <!-- 烘箱站專用：開/關門按鈕 -->
        <div v-if="d.stationName === '烘箱站'" class="oven-door-controls">
          <button class="btn btn-sm flex-1"
                  :class="getDispatchDoorState(d.id) === 'open' ? 'btn-warning' : 'btn-ghost'"
                  @click="recordOvenDoor(d, 'open')"
                  :disabled="getDispatchDoorState(d.id) === 'open'">
            <i data-lucide="door-open" class="w-4 h-4"></i>
            開門
          </button>
          <button class="btn btn-sm flex-1"
                  :class="getDispatchDoorState(d.id) === 'closed' ? 'btn-success' : 'btn-ghost'"
                  @click="recordOvenDoor(d, 'closed')"
                  :disabled="getDispatchDoorState(d.id) === 'closed' || getDispatchDoorState(d.id) === null">
            <i data-lucide="door-closed" class="w-4 h-4"></i>
            關門
          </button>
        </div>
        <!-- 烘箱站：顯示目前狀態與時間 -->
        <div v-if="d.stationName === '烘箱站' && getDispatchDoorState(d.id)"
             class="oven-door-status">
          <span v-if="getDispatchDoorState(d.id) === 'open'">
            <i data-lucide="door-open" class="w-3 h-3"></i>
            開門中
          </span>
          <span v-else>
            <i data-lucide="door-closed" class="w-3 h-3"></i>
            烘烤中
          </span>
          <span class="door-time">{{ getDispatchDoorTime(d.id) }}</span>
        </div>
        <!-- 完成報工按鈕 -->
        <button class="btn btn-success w-full" @click="completeJob(d)">
          <i data-lucide="check" class="w-4 h-4"></i>
          完成並報工
        </button>
      </div>

      <!-- 已完成狀態 -->
      <div v-if="d.status === 'completed'" class="flex">
        <button class="btn btn-ghost w-full" disabled>
          <i data-lucide="check-circle" class="w-4 h-4"></i>
          已完成
        </button>
      </div>
    </div>
  </div>

  <div v-if="dispatches.length === 0" class="empty-state">
    <i data-lucide="clipboard-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
    <div>暫無派工任務，請從工單頁面進行派工。</div>
  </div>
</div>
